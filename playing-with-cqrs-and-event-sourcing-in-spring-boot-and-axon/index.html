<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Playing with CQRS and Event Sourcing in Spring Boot and Axon | Nebrass Homepage</title><meta name=keywords content><meta name=description content="The Microservices Architecture World, we can meet many concepts and patterns, like the Centralized Configuration, Circuit Breaker, Service Registry and Discovery, etc.. Two of these patterns are the CQRS and the Event Sourcing patterns, coming from the Domain Driven Design planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ?"><meta name=author content><link rel=canonical href=https://blog.nebrass.fr/playing-with-cqrs-and-event-sourcing-in-spring-boot-and-axon/><link crossorigin=anonymous href=/assets/css/stylesheet.min.9aeab43847eb11aca320bfadedfe191ed6516dd768bf1314b534c4992aac901a.css integrity="sha256-muq0OEfrEayjIL+t7f4ZHtZRbddovxMUtTTEmSqskBo=" rel="preload stylesheet" as=style><script src=/js/prism.min.js></script>
<link rel=stylesheet href=/css/prism.min.css><link rel=icon href=https://blog.nebrass.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nebrass.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nebrass.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nebrass.fr/apple-touch-icon.png><link rel=mask-icon href=https://blog.nebrass.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style amp-custom>.main,.footer,.nav{max-width:calc(var(--main-width) + var(--gap) * 15)}</style><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-111781986-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Playing with CQRS and Event Sourcing in Spring Boot and Axon"><meta property="og:description" content="The Microservices Architecture World, we can meet many concepts and patterns, like the Centralized Configuration, Circuit Breaker, Service Registry and Discovery, etc.. Two of these patterns are the CQRS and the Event Sourcing patterns, coming from the Domain Driven Design planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ?"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nebrass.fr/playing-with-cqrs-and-event-sourcing-in-spring-boot-and-axon/"><meta property="og:image" content="https://blog.nebrass.fr/images/playing-with-cqrs-event-sourcing-spring-boot-axon.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.nebrass.fr/images/playing-with-cqrs-event-sourcing-spring-boot-axon.webp"><meta name=twitter:title content="Playing with CQRS and Event Sourcing in Spring Boot and Axon"><meta name=twitter:description content="The Microservices Architecture World, we can meet many concepts and patterns, like the Centralized Configuration, Circuit Breaker, Service Registry and Discovery, etc.. Two of these patterns are the CQRS and the Event Sourcing patterns, coming from the Domain Driven Design planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.nebrass.fr/posts/"},{"@type":"ListItem","position":3,"name":"Playing with CQRS and Event Sourcing in Spring Boot and Axon","item":"https://blog.nebrass.fr/playing-with-cqrs-and-event-sourcing-in-spring-boot-and-axon/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Playing with CQRS and Event Sourcing in Spring Boot and Axon","name":"Playing with CQRS and Event Sourcing in Spring Boot and Axon","description":"The Microservices Architecture World, we can meet many concepts and patterns, like the Centralized Configuration, Circuit Breaker, Service Registry and Discovery, etc.. Two of these patterns are the CQRS and the Event Sourcing patterns, coming from the Domain Driven Design planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ?","keywords":[],"articleBody":"The Microservices Architecture World, we can meet many concepts and patterns, like the Centralized Configuration, Circuit Breaker, Service Registry and Discovery, etc.. Two of these patterns are the CQRS and the Event Sourcing patterns, coming from the Domain Driven Design planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ? and for sure we will implement these two patterns in Java ‚òïÔ∏è obviously ü§ì\nLet‚Äôs start with some definitions and literature üòá\nWhat is the cqrs pattern ? CQRS stands for Command Query Responsibility Segregation is a design pattern that aims to separate the Read and Write operations. In the CQRS distinguishes the operations as:\n Queries: a Read only operation - no state is updated after executing queries Commands: a Writing operation - state is updated after executing commands  The schema describes the CQRS pattern:\nCQRS pattern\n A Query is a Read operation, that does not update any the state of the application. A Query is handled by the Reading Components that will interact with the DB, parses the DB response, creates a Data Transfert Object that will be returned to the User.\nA Command is a Business Action that the Application‚Äôs user want to do, for example: RegisterStudent, MakeDeposit, etc..\nEvery Command has a Handling Layer¬†that knows how to apply the Business Action. Generally, commands are inserted in a Queue to be processed asynchronously, so technically speaking, a Command Handler is invoked by a Queue Listener..\nWhat is the Event Sourcing Pattern ? Event Sourcing aims to persist the state of a business entity (BankAccount for example) as a sequence of state-changing events. Every action performed on a business entity should be persisted. The application reconstructs an entity‚Äôs current state by replaying the events.\nFor example, to reconstruct a given BankAccount current state, we need to replay all the events occurred on this business entity. It means we do not store the state of the BankAccount.\nApplications persist events in a database of events called event store. The store has an API for adding and retrieving an entity‚Äôs events. The event store also behaves like a message broker. It provides an API that enables services to subscribe to events. When a service saves an event in the event store, it is delivered to all interested subscribers.\nSome entities, such as a BankAccount, can have a large number of events. In order to optimize loading, an application can periodically save a snapshot of an entity‚Äôs current state. To reconstruct the current state, the application finds the most recent snapshot and the events that have occurred since that snapshot. As a result, there are fewer events to replay.\nEvent Sourcing (very) simplified diagram\n Why we are always coupling these patterns ? CQRS separates the responsibilities, typically into different components. The first component covers CUD operations (without the Reading), while a second component will ensure the Read operation.\nReads and writes from different places can create a timing issue. Most database theory focuses on consistency. It should be possible to keep a log of every data change. That way, at any point in time, the values that the queries display are logically correct. Here comes the Event Sourcing, which will ensure consistency. Event Sourcing stores a record of every action in a dedicated database. From there, an event handler reads these changes in order, applies them appropriately and marks them as complete once the transaction is complete. This event handler does not need to be complex ‚Äì it can be as simple as an API endpoint. Once the event handler creates an event record, a central service messaging system can push notifications every time it discovers about a new event.\nCoupling CQRS and Event Sourcing Diagram\n CQRS and Event Sourcing patterns are frequently used together. Coupling these two patterns means that each event on the Writing part of our application. Obviously ü§ì the Reading part is made by playing the events.\nLet‚Äôs implement the CQRS \u0026 Event Sourcing in a typical Java application We will create a small Spring Boot application on which we will implement CQRS and Event Sourcing patterns using Axon.\nWhat is Axon ? ü§î\nBased on the official documentation:\n Axon provides a unified, productive way of developing Java applications that can evolve without significant refactoring from a monolith to Event-Driven microservices. Axon includes both a programming model as well as specialized infrastructure to provide enterprise ready operational support for the programming model - especially for scaling and distributing mission critical business applications. The programming model is provided by the popular Axon Framework while Axon Server is the infrastructure part of Axon, all open sourced.\n Axon Framework and Server - Official documentation\n Let‚Äôs dig into the coding part; we will start by generating the Spring Boot application using the Spring Initializr with these dependencies:\n Web H2 Actuator H2 Database Lombok  Generating the Spring Boot application\n After generating the project. We will add these dependencies to the pom.xml:\n  SpringFox Swagger2 and Swagger UI:\n1 2 3 4 5 6 7 8 9 10   io.springfox springfox-swagger2 2.9.2   io.springfox springfox-swagger-ui 2.9.2      Axon Spring Boot Starter:\n1 2 3 4 5   org.axonframework axon-spring-boot-starter 4.2.1      Axon Test module ü§ì We will be testing our code ü§¨\n1 2 3 4 5 6   org.axonframework axon-test 4.2 test      Our sample application will be a Bank Account manager. Our application will have these features:\n Create a new account for a given Owner with a given Initial Balance Credit an amount on a given account Debit an amount from a given account Read information about a given account  A BankAccount will look like:\n1 2 3 4 5 6 7 8 9 10  @Data // Lombok @NoArgsConstructor // Lombok @AllArgsConstructor // Lombok @Entity public class BankAccount { @Id private UUID id; private String owner; private BigDecimal balance; }   commands and queries Now, we need to list the Reading and Writing actions related to the application features:\n   Feature Command Query     Create a new account Yes No   Credit an amount from account Yes No   Debit an amount from account Yes No   Get Account information No Yes    Based on this table, our commands will be:\n CreateAccountCommand CreditMoneyCommand DebitMoneyCommand  For the queries, we will have only one:\n FindAccountQuery  - What‚Äôs next ? ü§î\n- Did you forgot that the CQRS and Event Sourcing are two patterns that belong to the DDD paradigm? ü§î As it‚Äôs a Domain Driven, we need to start designing our Domain üòÅ\nWe will start by implementing the Command model for our CQRS segments, using Aggregates üò±\nAggregate I have found two definitions of Aggregates in the Axon Documentation:\n  An Aggregate is a regular object, which contains state and methods to alter that state. An Aggregate is an entity or group of entities that is always kept in a consistent state (within a single ACID transaction). The Aggregate Root is the entity within the aggregate that is responsible for maintaining this consistent state.   ‚ö†Ô∏è¬†I have a small objection on these definition: I dont like to have the word entity - because like everyone, I will directly think on JPA Entity - but keep in mind, Aggregate is a pattern in Domain-Driven Design, and in this level (the design) we dont talk about technical details. üëâ This is why I would like to say business entity instead entity.\nThe updated definition that I like üòÅ\n  An Aggregate is a regular object, which contains state and methods to alter that state. An Aggregate is a business entity or group of business entities that is always kept in a consistent state (within a single ACID transaction). The Aggregate Root is the business entity within the aggregate that is responsible for maintaining this consistent state.   For example: an aggregate can be an e-Commerce Order with the related OrderItems and Customer information. Here, the Order class is the Aggregate Root:\nOrder Aggregate example\n In our application, our Aggregate is the BankAccountAggregate will look like:\n1 2 3 4 5 6 7 8 9 10 11 12 13  @AllArgsConstructor // Lombok @NoArgsConstructor // Lombok @Getter // Lombok @Aggregate // 1 public class BankAccountAggregate { @AggregateIdentifier // 2  private UUID id; private BigDecimal balance; private String owner; ... }    The @Aggregate annotation informs Axon‚Äôs auto configurer for Spring that this class is an Aggregate instance. The @AggregateIdentifier identifies the field as the identifier of the Aggregate.  ‚ö†Ô∏è‚ö†Ô∏è For sure that you are saying now that the BookAccountAggregate and the BookAccount JPA Entity looks like the same structure. Why are we duplicating the code? Why don‚Äôt we use the BookAccountAggregate class as the JPA Entity class? The answer is that the BookAccountAggregate will contain more Axon boilerplate code which cannot fit to a JPA Entity class, which is used only to represent data stored in a DB ü§ì\nLet‚Äôs continue to code our BookAccountAggregate class.\nNow we will code the constructor. We already said that we have a Command that will create a new account: CreateAccountCommand. Here will come the first glue between the Commands and the Aggregate: the CreateAccountCommand will be passed to the Aggregate constructor:\n@CommandHandler public BankAccountAggregate(CreateAccountCommand command) { }\nThe @CommandHandler will mark this method (constructor) as a Handler of the CreateAccountCommand. The command needs to bring the data needed by to construct the BankAccount instance. Think of it as a Data Transfert Object used to wrap data received and sent via REST APIs. Obviously a CreateAccountCommand will have the same content like the BankAccount JPA Entity and the BookAccountAggregate. It will look like:\n1 2 3 4 5 6 7 8 9 10  @Data // Lombok @NoArgsConstructor // Lombok @AllArgsConstructor // Lombok public class CreateAccountCommand { @TargetAggregateIdentifier private UUID accountId; private BigDecimal initialBalance; private String owner; }   The @TargetAggregateIdentifier will identify the field as the identifier of the targeted aggregate.\nWe said before that in the CQRS and Event Sourcing based applications, for every Command made, we dispatch an Event.\nFor example; for the CreateAccountCommand we need to create an AccountCreatedEvent that will be used to say that a Command has been received.\n You can notice that the Command is formed by an Action + Command suffix while the Event is PastAction + Event suffix\n Guess what üòÅ the AccountCreatedEvent will look like:\n1 2 3 4 5 6 7  @Data // Lombok public class AccountCreatedEvent { private final UUID id; private final BigDecimal initialBalance; private final String owner; }   Now, the CommandHandler will look like:\n1 2 3 4 5 6 7 8 9 10 11  @CommandHandler public BankAccountAggregate(CreateAccountCommand command) { AggregateLifecycle.apply( new AccountCreatedEvent( command.getAccountId(), command.getInitialBalance(), command.getOwner() ) ); }   The AggregateLifecycle component is used to notify the Aggregate that a new BankAccount was created by publishing the AccountCreatedEvent.\nGood ! The same way, if we dispatched a Command, we defined its CommandHandler. Now, as we dispatched an Event, we need to define the EventHandler:\n1 2 3 4 5 6  @EventSourcingHandler public void on(AccountCreatedEvent event) { this.id = event.getId(); this.owner = event.getOwner(); this.balance = event.getInitialBalance(); }   The @EventSourcingHandler will define the annotated method as a handler for Events generated by that Aggregate.\nNow, we will define the two remaining Commands:\n  The CreditMoneyCommand:\n1 2 3 4 5 6 7 8 9  @Data @NoArgsConstructor @AllArgsConstructor public class CreditMoneyCommand { @TargetAggregateIdentifier private UUID accountId; private BigDecimal creditAmount; }     The DebitMoneyCommand:\n1 2 3 4 5 6 7 8 9  @Data @NoArgsConstructor @AllArgsConstructor public class DebitMoneyCommand { @TargetAggregateIdentifier private UUID accountId; private BigDecimal debitAmount; }     The remaining two Events:\n  The MoneyCreditedEvent:\n1 2 3 4 5 6  @Value public class MoneyCreditedEvent { private final UUID id; private final BigDecimal creditAmount; }     The MoneyDebitedEvent:\n1 2 3 4 5 6  @Value public class MoneyDebitedEvent { private final UUID id; private final BigDecimal debitAmount; }     The BankAccountAggregate will finally look like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  @AllArgsConstructor @NoArgsConstructor @Getter @Aggregate public class BankAccountAggregate { @AggregateIdentifier private UUID id; private BigDecimal balance; private String owner; @CommandHandler public BankAccountAggregate(CreateAccountCommand command) { AggregateLifecycle.apply( new AccountCreatedEvent( command.getAccountId(), command.getInitialBalance(), command.getOwner() ) ); } @EventSourcingHandler public void on(AccountCreatedEvent event) { this.id = event.getId(); this.owner = event.getOwner(); this.balance = event.getInitialBalance(); } @CommandHandler public void handle(CreditMoneyCommand command) { AggregateLifecycle.apply( new MoneyCreditedEvent( command.getAccountId(), command.getCreditAmount() ) ); } @EventSourcingHandler public void on(MoneyCreditedEvent event) { this.balance = this.balance.add(event.getCreditAmount()); } @CommandHandler public void handle(DebitMoneyCommand command) { AggregateLifecycle.apply( new MoneyDebitedEvent( command.getAccountId(), command.getDebitAmount() ) ); } @EventSourcingHandler public void on(MoneyDebitedEvent event) throws InsufficientBalanceException { if (this.balance.compareTo(event.getDebitAmount())  0) { throw new InsufficientBalanceException(event.getId(), event.getDebitAmount()); } this.balance = this.balance.subtract(event.getDebitAmount()); } }   I defined an InsufficientBalanceException for handling an error while debiting money:\n1 2 3 4 5 6  public class InsufficientBalanceException extends Throwable { public InsufficientBalanceException(UUID accountId, BigDecimal debitAmount) { super(\"Insufficient Balance: Cannot debit \" + debitAmount + \" from account number [\" + accountId.toString() + \"]\"); } }   At this stage, we created the aggregate that receives and handles the Commands and for every Command will dispatch a Query.\nGood ! But no data is inserted in the DB, no boundary is available to emit instructions ü•∫\nNow we will create the JPA Repository for our BankAccount JPA Entity:\n1 2 3  @Repository public interface BankAccountRepository extends JpaRepositoryBankAccount, UUID { }   Now, we can use the BankAccountRepository to made CRUD operations on BankAccount in the DB. Ok, but from where ?\nYou can think in the BankAccountAggregate, but it will not be suitable, as it will be doing many tasks which will cause us to lose the Single Responsibility principle.\nThe common practice is to create a dedicated class that will match the DB operations for every received event. I saw that the Axon team is calling it Projector class.\nWe will call our Projector class BankAccountProjection that looks like:\n1 2 3 4 5 6 7 8 9  @Slf4j @RequiredArgsConstructor @Component public class BankAccountProjection { private final BankAccountRepository repository; ... }   The BankAccountProjection is a Spring Component on which we injected our BankAccountRepository.\nGood ! Now, we need to define the Handler for every emitted Event. For example, the EventHandler for AccountCreatedEvent will look like:\n1 2 3 4 5 6 7 8 9 10  @EventHandler public void on(AccountCreatedEvent event) { log.debug(\"Handling a Bank Account creation command {}\", event.getId()); BankAccount bankAccount = new BankAccount( event.getId(), event.getOwner(), event.getInitialBalance() ); this.repository.save(bankAccount); }   Opppaaa ü•≥ ! The Event is serving as a DTO wrapping the needed values to create a BankAccount üòÅ\nThe same thing for the MoneyCreditedEvent and MoneyDebitedEvent:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  ... @EventHandler public void on(MoneyCreditedEvent event) throws AccountNotFoundException { log.debug(\"Handling an Account Credit command {}\", event.getId()); OptionalBankAccount optionalBankAccount = this.repository.findById(event.getId()); if (optionalBankAccount.isPresent()) { BankAccount bankAccount = optionalBankAccount.get(); bankAccount.setBalance(bankAccount.getBalance().add(event.getCreditAmount())); this.repository.save(bankAccount); } else { throw new AccountNotFoundException(event.getId()); } } @EventHandler public void on(MoneyDebitedEvent event) throws AccountNotFoundException { log.debug(\"Handling an Account Debit command {}\", event.getId()); OptionalBankAccount optionalBankAccount = this.repository.findById(event.getId()); if (optionalBankAccount.isPresent()) { BankAccount bankAccount = optionalBankAccount.get(); bankAccount.setBalance(bankAccount.getBalance().subtract(event.getDebitAmount())); this.repository.save(bankAccount); } else { throw new AccountNotFoundException(event.getId()); } } ...   Here, I defined an AccountNotFoundException thrown¬†when no account is found:\n1 2 3 4 5  public class AccountNotFoundException extends Throwable { public AccountNotFoundException(UUID id) { super(\"Cannot found account number [\" + id + \"]\"); } }   Yoopi ! ü§© Now, we will need the REST API and the Spring Service that will be receiving the HTTP Requests and dispatching the Commands to the Axon Engine.\nLet‚Äôs start by the REST API for the Commands:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  @RestController @RequestMapping(value = \"/accounts\") @Api(value = \"Bank Account Commands\", description = \"Bank Account Commands API\") @AllArgsConstructor public class AccountCommandController { private final AccountCommandService accountCommandService; @PostMapping @ResponseStatus(value = CREATED) public CompletableFutureBankAccount createAccount(@RequestBody AccountCreationDTO creationDTO) { return this.accountCommandService.createAccount(creationDTO); } @PutMapping(value = \"/credit/{accountId}\") public CompletableFutureString creditMoneyToAccount(@PathVariable(value = \"accountId\") String accountId, @RequestBody MoneyAmountDTO moneyCreditDTO) { return this.accountCommandService.creditMoneyToAccount(accountId, moneyCreditDTO); } @PutMapping(value = \"/debit/{accountId}\") public CompletableFutureString debitMoneyFromAccount(@PathVariable(value = \"accountId\") String accountId, @RequestBody MoneyAmountDTO moneyDebitDTO) { return this.accountCommandService.debitMoneyFromAccount(accountId, moneyDebitDTO); } }   The AccountCreationDTO:\n1 2 3 4 5  @Value public class AccountCreationDTO { private final BigDecimal initialBalance; private final String owner; }   The MoneyAmountDTO:\n1 2 3 4 5  @Data @NoArgsConstructor public class MoneyAmountDTO { private BigDecimal amount; }   Now, we will create the Spring Service that will be dispatching the Commands to the Axon Engine. To do this, the framework has a very useful component called CommandGateway, which is a very convenient interface towards the command dispatching mechanism üòÅ\nOur AccountCommandService will look like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  @Service @AllArgsConstructor public class AccountCommandService { private final CommandGateway commandGateway; public CompletableFutureBankAccount createAccount(AccountCreationDTO creationDTO) { return this.commandGateway.send(new CreateAccountCommand( UUID.randomUUID(), creationDTO.getInitialBalance(), creationDTO.getOwner() )); } public CompletableFutureString creditMoneyToAccount(String accountId, MoneyAmountDTO moneyCreditDTO) { return this.commandGateway.send(new CreditMoneyCommand( formatUuid(accountId), moneyCreditDTO.getAmount() )); } public CompletableFutureString debitMoneyFromAccount(String accountId, MoneyAmountDTO moneyDebitDTO) { return this.commandGateway.send(new DebitMoneyCommand( formatUuid(accountId), moneyDebitDTO.getAmount() )); } }   Cool ! ü•≥ We need to define the Query part. Let‚Äôs start by defining FindAccountQuery:\n1 2 3 4 5 6  @Data @NoArgsConstructor @AllArgsConstructor public class FindBankAccountQuery { private UUID accountId; }   In the BankAccountProjection, we need to add a QueryHandler method:\n1 2 3 4 5  @QueryHandler public BankAccount handle(FindBankAccountQuery query) { log.debug(\"Handling FindBankAccountQuery query: {}\", query); return this.repository.findById(query.getAccountId()).orElse(null); }   We need to create the Query REST API and Service. The AccountQueryController looks like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  @RestController @RequestMapping(value = \"/accounts\") @Api(value = \"Bank Account Queries\", description = \"Bank Account Query Events API\") @AllArgsConstructor public class AccountQueryController { private final AccountQueryService accountQueryService; @GetMapping(\"/{accountId}\") public CompletableFutureBankAccount findById(@PathVariable(\"accountId\") String accountId) { return this.accountQueryService.findById(accountId); } @GetMapping(\"/{accountId}/events\") public ListObject listEventsForAccount(@PathVariable(value = \"accountId\") String accountId) { return this.accountQueryService.listEventsForAccount(accountId); } }   The AccountQueryService looks like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  @Service @AllArgsConstructor public class AccountQueryService { private final QueryGateway queryGateway; private final EventStore eventStore; public CompletableFutureBankAccount findById(String accountId) { return this.queryGateway.query( new FindBankAccountQuery(formatUuid(accountId)), ResponseTypes.instanceOf(BankAccount.class) ); } public ListObject listEventsForAccount(String accountId) { return this.eventStore .readEvents(formatUuid(accountId).toString()) .asStream() .map(Message::getPayload) .collect(Collectors.toList()); } }   **STOP!!**üëÆüèª‚Äç‚ôÇÔ∏è‚õîÔ∏è What is this strange EventStore ?? EventStore provides access to both the global event stream comprised of all domain and application events. We will be using it to list all the events about a given aggregate.\nWe need to add these properties to the application.properties:\n1 2 3 4 5  # H2 settings spring.h2.console.enabled=true spring.h2.console.path=/h2-console # Axon axon.serializer.general=jackson   We will be using Swagger to have a small UI to test our REST APIs. The SwaggerConfiguration file looks like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  @Configuration @EnableSwagger2 public class SwaggerConfiguration { @Bean public Docket apiDocket() { return new Docket(DocumentationType.SWAGGER_2) .select() .apis(RequestHandlerSelectors .basePackage(\"com.targa.labs.dev.cqrses\")) .paths(PathSelectors.any()) .build() .apiInfo(getApiInfo()); } private ApiInfo getApiInfo() { return new ApiInfo( \"CQRS \u0026 ES Sample App based on Spring Boot and Axon\", \"App to demonstrate CQRS \u0026 ES based on Spring Boot and Axon\", \"0.0.1-SNAPSHOT\", \"Terms of Service\", new Contact(\"Nebrass Lamouchi\", \"https://blog.nebrass.fr\", \"lnibrass@gmail.com\"), \"\", \"\", Collections.emptyList()); } }   Now, let‚Äôs start our application:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  $ mvn spring-boot:run [INFO] Scanning for projects... [INFO] [INFO] ------------------------------------------ [INFO] Building cqrs-es 0.0.1-SNAPSHOT [INFO] --------------------------------[ jar ]--------------------------------- .... ...AxonServerConnectionManager: Connecting using unencrypted connection... ...AxonServerConnectionManager: Requesting connection details from localhost:8124 ...AxonServerConnectionManager: Connecting to AxonServer node [localhost]:[8124] failed: UNAVAILABLE: io exception ********************************************** * * * !!! UNABLE TO CONNECT TO AXON SERVER !!! * * * * Are you sure it's running? * * If you haven't got Axon Server yet, visit * * https://axoniq.io/download * * * ********************************************** To suppress this message, you can - explicitly configure an AxonServer location, - start with -Daxon.axonserver.suppressDownloadMessage=true ...AxonServerQueryBus: Error subscribing query handler org.axonframework.axonserver.connector.AxonServerException: No connection to AxonServer available ... ...DocumentationPluginsBootstrapper: Context refreshed ...TrackingEventProcessor: Fetch Segments for Processor 'com.targa.labs.dev.cqrses.projection' failed: No connection to AxonServer available. Preparing for retry in 1s ...   Wooh üò±üò±üò± These errors are due to a missing Axon Server. We can start a new instance it easily using a Docker Container:\n1  $ docker run -d --name axon-server -p 8024:8024 -p 8124:8124 axoniq/axonserver   Now, the Axon Server UI will be reachable on http://localhost:8024/\nAxon Server UI\n If you click on the Overview section:\nAxon Server UI - Overview\n Next, check the Commands¬†section:\nAxon Server UI - Commands\n Next, check the Queries¬†section:\nAxon Server UI - Queries\n Nothing wrong üòÜ Don‚Äôt be scared, as no application is communicating with the Axon Server, everything is empty.\nLet‚Äôs start now the application again:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  $ mvn spring-boot:run [INFO] Scanning for projects... [INFO] [INFO] ------------------------------------------ [INFO] Building cqrs-es 0.0.1-SNAPSHOT [INFO] --------------------------------[ jar ]--------------------------------- ... . ____ _ __ _ _ /\\\\ / ___'_ __ _ _(_)_ __ __ _ \\ \\ \\ \\ ( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\  \\\\/ ___)| |_)| | | | | || (_| | ) ) ) ) ' |____| .__|_| |_|_| |_\\__, | / / / / =========|_|==============|___/=/_/_/_/ :: Spring Boot :: (v2.2.2.RELEASE) ... ..AxonServerConnectionManager : Connecting using unencrypted connection... ..AxonServerConnectionManager : Requesting connection details from localhost:8124 ..AxonServerConnectionManager : Reusing existing channel ..AxonServerConnectionManager : Re-subscribing commands and queries ..AxonServerCommandBus : Creating new command stream subscriber ..AxonServerQueryBus : Creating new query stream subscriber ..DocumentationPluginsBootstrapper : Context refreshed ..DocumentationPluginsBootstrapper : Found 1 custom documentation plugin(s) ..ApiListingReferenceScanner : Scanning for api listing references ..TrackingEventProcessor : Worker assigned to segment Segment[0/0] for processing ..TrackingEventProcessor : Using current Thread for last segment worker: TrackingSegmentWorker{processor=com.targa.labs.dev.cqrses.projection, segment=Segment[0/0]} ..TrackingEventProcessor : Fetched token: null for segment: Segment[0/0] ..AxonServerEventStore : open stream: 0 ..TomcatWebServer : Tomcat started on port(s): 8080 (http) with context path '' ..CqrsEsApplication : Started CqrsEsApplication in 5.262 seconds (JVM running for 5.532)   Cool ! Let‚Äôs access now the Swagger UI on http://localhost:8080/swagger-ui.html:\nSwagger UI\n As you see, there is already two REST Controllers one for the Commands and one for the Queries. Let‚Äôs test the createAccount REST API:\nCreate Account - Swagger UI\n Here we created a new BankAccount that has:\n id: 962f7577-19b6-439b-9368-9742b44d2a20 initialBalance: 5000 owner: Nebrass Lamouchi  Next, I will test some creditMoneyToAccount¬†operation twice the first with an amount of 300 and the second with 480:\nCredit Account - Swagger UI\n Let‚Äôs debit the amount of 2000 from the sample account using the debitMoneyFromAccount operation:\nDebit Account ‚Äì Swagger UI\n Now, we need to check how much we have in our account, normally the remaining balance will be 5000 + 300 + 480-2000 = 3780.\nLet‚Äôs check the account using the findById operation on the AccountQueryController:\nFind Account by ID ‚Äì Swagger UI\n As expected ! the balance is 3780 ü§©\nWe can verify the Events list occurred on our BankAccount using the listEventsForAccount operation:\nAccount Events list ‚Äì Swagger UI\n Great ! Everything is working like a charm ! ü•≥\nAfter we executed our application and after we did some operations, let‚Äôs visit again the Axon Server UI:\nAxon Server UI - Overview after execution\n As you see, our application instance is spotted on the Axon Dashboard. Let‚Äôs move to the Commands section:\nAxon Server UI - Commands after execution\n You already see that the CreateAccountCommand was fired once, the CreditMoneyCommand twice (300 \u0026 480) and the DebitMoneyCommand once (2000).\nNext, move to the Queries section:\nAxon Server UI - Queries after execution\n You can easily see that the FindBankAccountQuery was executed once.\nYou can see all of the Events in the Search section. Click directly on Search button to grab all the Events:\nAxon Server UI - Search section\n If you want to test our Axon code programmatically, we will start by adding the Axon Test module to the pom.xml:\n1 2 3 4 5 6   org.axonframework axon-test 4.2 test    Next, we will create a BankAccountTest class:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  public class BankAccountTest { private static final String customerName = \"Nebrass\"; private FixtureConfigurationBankAccountAggregate fixture; private UUID id; @BeforeEach public void setUp() { fixture = new AggregateTestFixture(BankAccountAggregate.class); id = UUID.randomUUID(); } @Test public void should_dispatch_accountcreated_event_when_createaccount_command() { fixture.givenNoPriorActivity() .when(new CreateAccountCommand( id, BigDecimal.valueOf(1000), customerName) ) .expectEvents(new AccountCreatedEvent( id, BigDecimal.valueOf(1000), customerName) ); } @Test public void should_dispatch_moneycredited_event_when_balance_is_lower_than_debit_amount() { fixture.given(new AccountCreatedEvent( id, BigDecimal.valueOf(1000), customerName)) .when(new CreditMoneyCommand( id, BigDecimal.valueOf(100)) ) .expectEvents(new MoneyCreditedEvent( id, BigDecimal.valueOf(100)) ); } @Test public void should_dispatch_moneydebited_event_when_balance_is_upper_than_debit_amount() { fixture.given(new AccountCreatedEvent( id, BigDecimal.valueOf(1000), customerName)) .when(new DebitMoneyCommand( id, BigDecimal.valueOf(100))) .expectEvents(new MoneyDebitedEvent( id, BigDecimal.valueOf(100))); } @Test public void should_not_dispatch_event_when_balance_is_lower_than_debit_amount() { fixture.given(new AccountCreatedEvent( id, BigDecimal.valueOf(1000), customerName)) .when(new DebitMoneyCommand( id, BigDecimal.valueOf(5000))) .expectNoEvents(); } }   In our BankAccountTest class, we are using FixtureConfiguration class which we will use to define a test scenario in terms of events and commands:\n Given certain events in the past When executing this command Expect these events to be published  Our test are designed like:\n In the first test, we are testing an Account Creation operation:  we are supposing that we don‚Äôt have any account created when we will dispatch a CreateAccountCommand we are expecting to get the a AccountCreatedEvent with the same values   In the second test, we are testing the Credit Money operation:  we are supposing that we have an account when we will dispatch a CreditMoneyCommand with an amount of 100 we are expecting to get the a MoneyCreditedEvent with an amount of 100   In the third test, we are testing the Debit Money operation:  we are supposing that we have an account when we will dispatch a Debit****MoneyCommand with an amount of 100 we are expecting to get the a MoneyDebitedEvent with an amount of 100   In the third test, we are testing the impossibility to execute Debit Money operation when the requested amount is higher than the account balance:  we are supposing that we have an account when we will dispatch a Debit****MoneyCommand with an amount of 5000 we are expecting to have NO events that occurred    The end !\n Conclusion In this tutorial, I have implemented a CQRS and Event Sourcing based Spring Boot application using the Axon Platform. This is a blog post I wanted to write from some time ago, but I couldn‚Äôt find an opportunity until now. I tried to present the key concepts of the CQRS and Event Sourcing patterns and the main features offered by Axon Platform. I tried to make the demo using a very common example in the DDD world, the Bank Account.\nI really encourage you to dig into the DDD paradigms especially that we have many great platforms like Axon which make our life easier.\nThe sample code of this tutorial can be found on Github.\n","wordCount":"4642","inLanguage":"en","image":"https://blog.nebrass.fr/images/playing-with-cqrs-event-sourcing-spring-boot-axon.webp","datePublished":"2019-12-20T00:00:00Z","dateModified":"2019-12-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nebrass.fr/playing-with-cqrs-and-event-sourcing-in-spring-boot-and-axon/"},"publisher":{"@type":"Organization","name":"Nebrass Homepage","logo":{"@type":"ImageObject","url":"https://blog.nebrass.fr/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nebrass.fr accesskey=h title="Nebrass Homepage (Alt + H)">Nebrass Homepage</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://blog.nebrass.fr/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.nebrass.fr/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.nebrass.fr/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Playing with CQRS and Event Sourcing in Spring Boot and Axon</h1><div class=post-meta><span title="2019-12-20 00:00:00 +0000 UTC">December 20, 2019</span>&nbsp;¬∑&nbsp;22 min</div></header><figure class=entry-cover><img loading=lazy src=https://blog.nebrass.fr/images/playing-with-cqrs-event-sourcing-spring-boot-axon.webp alt></figure><div class=post-content><p>The <strong>Microservices Architecture</strong> World, we can meet many <strong>concepts</strong> and <strong>patterns</strong>, like the <strong>Centralized Configuration</strong>, <strong>Circuit Breaker</strong>, <strong>Service Registry and Discovery</strong>, etc.. Two of these patterns are the <strong>CQRS</strong> and the <strong>Event Sourcing</strong> patterns, coming from the <strong>Domain Driven Design</strong> planet üåè In the most of the use-cases, these two patterns are sold together üòÅ in this new tutorial, we will discover what does each one ? why they are usually used together ? and for sure <strong>we will implement these two patterns in Java</strong> ‚òïÔ∏è obviously ü§ì</p><p>Let&rsquo;s start with some definitions and literature üòá</p><h2 id=what-is-the-cqrs-pattern->What is the cqrs pattern ?<a hidden class=anchor aria-hidden=true href=#what-is-the-cqrs-pattern->#</a></h2><p><strong>CQRS</strong> stands for <strong>Command Query Responsibility Segregation</strong> is a design pattern that aims to <strong>separate</strong> the <strong>Read</strong> and <strong>Write</strong> operations. In the CQRS distinguishes the operations as:</p><ul><li><strong>Queries</strong>: a Read only operation - no state is updated after executing queries</li><li><strong>Commands</strong>: a Writing operation - state is updated after executing commands</li></ul><p>The schema describes the <strong>CQRS</strong> pattern:</p><div align=center><p><img loading=lazy src=../images/cqrs-simple-diagram-886x1024.webp alt="CQRS pattern Diagram" title="CQRS pattern Diagram">
CQRS pattern</p></div><p>A <strong>Query</strong> is a <strong>Read operation</strong>, that <strong>does not update any the state</strong> of the application. A <strong>Query</strong> is handled by the <strong>Reading Components</strong> that will interact with the <strong>DB</strong>, parses the <strong>DB response</strong>, creates a <strong>Data Transfert Object</strong> that will be returned to the User.</p><p>A <strong>Command</strong> is a <strong>Business Action</strong> that the Application&rsquo;s user want to do, for example: <em>RegisterStudent</em>, <em>MakeDeposit</em>, etc..</p><p>Every <strong>Command</strong> has a <strong>Handling Layer</strong>¬†that knows how to apply the <strong>Business Action</strong>. Generally, commands are inserted in a <strong>Queue</strong> to be processed <strong>asynchronously</strong>, so technically speaking, a <strong>Command Handler</strong> is invoked by a <strong>Queue Listener</strong>..</p><h2 id=what-is-the-event-sourcing-pattern->What is the Event Sourcing Pattern ?<a hidden class=anchor aria-hidden=true href=#what-is-the-event-sourcing-pattern->#</a></h2><p>Event Sourcing aims to persist the state of a business entity (<strong>BankAccount</strong> for example) as a sequence of state-changing events. Every action performed on a business entity should be persisted. The application reconstructs an entity‚Äôs current state by replaying the events.</p><p>For example, to reconstruct a given <strong>BankAccount</strong> current state, we need to replay all the events occurred on this business entity. It means we do not store the state of the <strong>BankAccount</strong>.</p><p>Applications persist events in a database of events called <strong>event store</strong>. The store has an API for adding and retrieving an entity‚Äôs events. The <strong>event store</strong> also behaves like a message broker. It provides an API that enables services to subscribe to events. When a service saves an event in the event store, it is delivered to all interested subscribers.</p><p>Some entities, such as a <strong>BankAccount</strong>, can have a large number of events. In order to optimize loading, an application can periodically save a <strong>snapshot</strong> of an entity‚Äôs current state. To reconstruct the current state, the application finds the most recent <strong>snapshot</strong> and the events that have occurred since that <strong>snapshot</strong>. As a result, there are fewer events to replay.</p><div align=center><p><img loading=lazy src=../images/playing-es-diagram-929x1024.webp alt=playing-es-diagram title=playing-es-diagram>
Event Sourcing (very) simplified diagram</p></div><h2 id=why-we-are-always-coupling-these-patterns->Why we are always coupling these patterns ?<a hidden class=anchor aria-hidden=true href=#why-we-are-always-coupling-these-patterns->#</a></h2><p><strong>CQRS</strong> separates the responsibilities, typically into different components. The first component covers <strong>CUD operations</strong> (without the Reading), while a second component will ensure the <strong>Read</strong> <strong>operation</strong>.</p><p><strong>Reads</strong> and <strong>writes</strong> from different places can create a timing issue. Most database theory focuses on consistency. It should be possible to keep a log of every data change. That way, at any point in time, the values that the queries display are logically correct. Here comes the <strong>Event Sourcing</strong>, which will ensure consistency. <strong>Event Sourcing</strong> stores a record of every action in a dedicated database. From there, an <strong>event handler</strong> reads these changes in order, applies them appropriately and marks them as complete once the transaction is complete. This <strong>event handler</strong> does not need to be complex &ndash; it can be as simple as an <em>API endpoint</em>. Once the <strong>event handler</strong> creates an event record, a central service messaging system can push notifications every time it discovers about a new event.</p><div align=center><p><img loading=lazy src=../images/cqrs-and-es-diagram-854x1024.webp alt="Coupling CQRS and Event Sourcing Diagram" title="Coupling CQRS and Event Sourcing Diagram">
Coupling CQRS and Event Sourcing Diagram</p></div><p><strong>CQRS</strong> and <strong>Event Sourcing</strong> patterns are frequently used together. Coupling these two patterns means that each event on the <strong>Writing</strong> part of our application. Obviously ü§ì the Reading part is made by playing the events.</p><h2 id=lets-implement-the-cqrs--event-sourcing-in-a-typical-java-application>Let&rsquo;s implement the CQRS & Event Sourcing in a typical Java application<a hidden class=anchor aria-hidden=true href=#lets-implement-the-cqrs--event-sourcing-in-a-typical-java-application>#</a></h2><p>We will create a small <strong>Spring Boot application</strong> on which we will implement <strong>CQRS</strong> and <strong>Event Sourcing patterns</strong> using <strong>Axon</strong>.</p><p>What is <strong>Axon</strong> ? ü§î</p><p>Based on the official documentation:</p><blockquote><p><strong>Axon</strong> provides a unified, productive way of developing Java applications that can evolve without significant refactoring from a monolith to Event-Driven microservices. <strong>Axon</strong> includes both a programming model as well as specialized infrastructure to provide enterprise ready operational support for the programming model - especially for scaling and distributing mission critical business applications. The programming model is provided by the popular <strong>Axon Framework</strong> while <strong>Axon Server</strong> is the infrastructure part of <strong>Axon</strong>, all open sourced.</p></blockquote><div align=center><p><img loading=lazy src=../images/axon-wide-banner-1024x397.webp alt="Axon Framework and Server - Official documentation " title="Axon Framework and Server - Official documentation">
Axon Framework and Server - Official documentation</p></div><p>Let&rsquo;s dig into the coding part; we will start by generating the <strong>Spring Boot application</strong> using the <strong>Spring Initializr</strong> with these dependencies:</p><ul><li>Web</li><li>H2</li><li>Actuator</li><li>H2 Database</li><li>Lombok</li></ul><div align=center><p><img loading=lazy src=../images/cqrs-es-spring-initializr.webp alt="Generating the Spring Boot application" title="Generating the Spring Boot application">
Generating the Spring Boot application</p></div><p>After generating the project. We will add these dependencies to the <code>pom.xml</code>:</p><ul><li><p><strong>SpringFox Swagger2</strong> and <strong>Swagger UI</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.springfox<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>springfox-swagger2<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>2.9.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>io.springfox<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>springfox-swagger-ui<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>2.9.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>Axon Spring Boot Starter</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.axonframework<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>axon-spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;version&gt;</span>4.2.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>Axon Test module ü§ì</strong> We will be testing our code ü§¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.axonframework<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>axon-test<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>4.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>Our <strong>sample application</strong> will be a <strong>Bank Account</strong> manager. Our <strong>application</strong> will have these features:</p><ul><li>Create a new account for a given <strong>Owner</strong> with a given <strong>Initial Balance</strong></li><li>Credit an amount on a given account</li><li>Debit an amount from a given account</li><li>Read information about a given account</li></ul><p>A <strong>BankAccount</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>               <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NoArgsConstructor</span>  <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@AllArgsConstructor</span> <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Entity</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BankAccount</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Id</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=commands-and-queries>commands and queries<a hidden class=anchor aria-hidden=true href=#commands-and-queries>#</a></h3><p>Now, we need to list the <strong>Reading</strong> and <strong>Writing</strong> actions related to the application features:</p><table><thead><tr><th>Feature</th><th>Command</th><th>Query</th></tr></thead><tbody><tr><td>Create a new account</td><td>Yes</td><td>No</td></tr><tr><td>Credit an amount from account</td><td>Yes</td><td>No</td></tr><tr><td>Debit an amount from account</td><td>Yes</td><td>No</td></tr><tr><td>Get Account information</td><td>No</td><td>Yes</td></tr></tbody></table><p>Based on this table, our commands will be:</p><ul><li>CreateAccountCommand</li><li>CreditMoneyCommand</li><li>DebitMoneyCommand</li></ul><p>For the queries, we will have only one:</p><ul><li>FindAccountQuery</li></ul><p>- What&rsquo;s next ? ü§î</p><p>- Did you forgot that the <strong>CQRS and Event Sourcing</strong> are two patterns that belong to the <strong>DDD paradigm</strong>? ü§î As it&rsquo;s a <strong>Domain Driven</strong>, we need to start designing our <strong>Domain</strong> üòÅ</p><p>We will start by implementing the <strong>Command model</strong> for our <strong>CQRS segments</strong>, using <strong>Aggregates</strong> üò±</p><h3 id=aggregate>Aggregate<a hidden class=anchor aria-hidden=true href=#aggregate>#</a></h3><p>I have found two definitions of Aggregates in the Axon Documentation:</p><blockquote><ul><li><em>An <strong>Aggregate</strong> is a regular object, which contains state and methods to alter that state.</em></li><li><em>An <strong>Aggregate</strong> is an entity or group of entities that is always kept in a consistent state (within a single ACID transaction). The <strong>Aggregate Root</strong> is the entity within the <strong>aggregate</strong> that is responsible for maintaining this consistent state.</em></li></ul></blockquote><p>‚ö†Ô∏è¬†I have a small objection on these definition: I dont like to have the word entity - because like everyone, I will directly think on <strong>JPA Entity</strong> - but keep in mind, <strong>Aggregate</strong> is a pattern in <strong>Domain-Driven Design</strong>, and in this level (the design) we dont talk about technical details. üëâ This is why I would like to say <strong>business entity</strong> instead <strong>entity</strong>.</p><p>The updated definition that I like üòÅ</p><blockquote><ul><li>An <strong>Aggregate</strong> is a regular object, which contains state and methods to alter that state.</li><li>An <strong>Aggregate</strong> is a business entity or group of business entities that is always kept in a consistent state (within a single ACID transaction). The <strong>Aggregate Root</strong> is the business entity within the <strong>aggregate</strong> that is responsible for maintaining this consistent state.</li></ul></blockquote><p>For example: an <strong>aggregate</strong> can be an e-Commerce <strong>Order</strong> with the related <strong>OrderItems</strong> and <strong>Customer</strong> information. Here, the <strong>Order</strong> class is the <strong>Aggregate Root</strong>:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-order-aggregate-833x1024.webp alt="Order Aggregate example" title="Order Aggregate example">
Order Aggregate example</p></div><p>In our application, our <strong>Aggregate</strong> is the <strong>BankAccountAggregate</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span> <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NoArgsConstructor</span>  <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Getter</span>             <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@Aggregate</span> <span class=c1>// 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BankAccountAggregate</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@AggregateIdentifier</span> <span class=c1>// 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>The <code>@Aggregate</code> annotation informs <strong>Axon&rsquo;s auto configurer for Spring</strong> that this class is an <strong>Aggregate</strong> instance.</li><li>The <code>@AggregateIdentifier</code> identifies the field as the identifier of the <strong>Aggregate</strong>.</li></ol><p>‚ö†Ô∏è‚ö†Ô∏è For sure that you are saying now that the <strong>BookAccountAggregate</strong> and the <strong>BookAccount</strong> <em>JPA Entity</em> looks like the same structure. Why are we duplicating the code? Why don&rsquo;t we use the <strong>BookAccountAggregate</strong> class as the <em>JPA Entity</em> class? The answer is that the <strong>BookAccountAggregate</strong> will contain more <strong>Axon</strong> boilerplate code which cannot fit to a <em>JPA Entity</em> class, which is used only to represent data stored in a DB ü§ì</p><p>Let&rsquo;s continue to code our <strong>BookAccountAggregate</strong> class.</p><p>Now we will code the constructor. We already said that we have a <strong>Command</strong> that will create a new account: <strong>CreateAccountCommand</strong>. Here will come the first glue between the <strong>Commands</strong> and the <strong>Aggregate</strong>: the <strong>CreateAccountCommand</strong> will be passed to the <strong>Aggregate</strong> constructor:</p><p>@CommandHandler
public BankAccountAggregate(CreateAccountCommand command) {
}</p><p>The <code>@CommandHandler</code> will mark this method (constructor) as a <strong>Handler</strong> of the <strong>CreateAccountCommand</strong>. The command needs to bring the data needed by to construct the <strong>BankAccount</strong> instance. Think of it as a <strong>Data Transfert Object</strong> used to wrap data received and sent via REST APIs. Obviously a <strong>CreateAccountCommand</strong> will have the same content like the <strong>BankAccount</strong> JPA Entity and the <strong>BookAccountAggregate</strong>. It will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>               <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@NoArgsConstructor</span>  <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nd>@AllArgsConstructor</span> <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreateAccountCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@TargetAggregateIdentifier</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>accountId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>@TargetAggregateIdentifier</code> will identify the field as the identifier of the targeted <strong>aggregate</strong>.</p><p>We said before that in the <strong>CQRS</strong> and <strong>Event Sourcing</strong> based applications, for every <strong>Command</strong> made, we dispatch an <strong>Event</strong>.</p><p>For example; for the <strong>CreateAccountCommand</strong> we need to create an <strong>AccountCreatedEvent</strong> that will be used to say that a <strong>Command</strong> has been received.</p><blockquote><p>You can notice that the Command is formed by an Action + Command suffix while the Event is PastAction + Event suffix</p></blockquote><p>Guess what üòÅ the <strong>AccountCreatedEvent</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span> <span class=c1>// Lombok
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountCreatedEvent</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>BigDecimal</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, the <strong>CommandHandler</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@CommandHandler</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>BankAccountAggregate</span><span class=o>(</span><span class=n>CreateAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>AggregateLifecycle</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>command</span><span class=o>.</span><span class=na>getAccountId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                    <span class=n>command</span><span class=o>.</span><span class=na>getOwner</span><span class=o>()</span>
</span></span><span class=line><span class=cl>            <span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>AggregateLifecycle</code> component is used to notify the <strong>Aggregate</strong> that a new <strong>BankAccount</strong> was created by publishing the <strong>AccountCreatedEvent</strong>.</p><p>Good ! The same way, if we dispatched a <strong>Command</strong>, we defined its <strong>CommandHandler</strong>. Now, as we dispatched an <strong>Event</strong>, we need to define the <strong>EventHandler</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EventSourcingHandler</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>AccountCreatedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>owner</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getOwner</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>balance</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>@EventSourcingHandler</code> will define the annotated method as a handler for <strong>Events</strong> generated by that <strong>Aggregate</strong>.</p><p>Now, we will define the two remaining <strong>Commands</strong>:</p><ul><li><p>The <strong>CreditMoneyCommand</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CreditMoneyCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@TargetAggregateIdentifier</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>accountId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>creditAmount</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>The <strong>DebitMoneyCommand</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DebitMoneyCommand</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@TargetAggregateIdentifier</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>accountId</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>debitAmount</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>The remaining two <strong>Events</strong>:</p><ul><li><p>The <strong>MoneyCreditedEvent</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Value</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MoneyCreditedEvent</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>BigDecimal</span> <span class=n>creditAmount</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>The <strong>MoneyDebitedEvent</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Value</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MoneyDebitedEvent</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>BigDecimal</span> <span class=n>debitAmount</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p>The <strong>BankAccountAggregate</strong> will finally look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Getter</span>
</span></span><span class=line><span class=cl><span class=nd>@Aggregate</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BankAccountAggregate</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@AggregateIdentifier</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>balance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@CommandHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>BankAccountAggregate</span><span class=o>(</span><span class=n>CreateAccountCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>AggregateLifecycle</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getAccountId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getOwner</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@EventSourcingHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>AccountCreatedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>owner</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getOwner</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>balance</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@CommandHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handle</span><span class=o>(</span><span class=n>CreditMoneyCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AggregateLifecycle</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>MoneyCreditedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getAccountId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getCreditAmount</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@EventSourcingHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>MoneyCreditedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>balance</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>balance</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getCreditAmount</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@CommandHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>handle</span><span class=o>(</span><span class=n>DebitMoneyCommand</span> <span class=n>command</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AggregateLifecycle</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>MoneyDebitedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getAccountId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>command</span><span class=o>.</span><span class=na>getDebitAmount</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@EventSourcingHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>MoneyDebitedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InsufficientBalanceException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>balance</span><span class=o>.</span><span class=na>compareTo</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getDebitAmount</span><span class=o>())</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>InsufficientBalanceException</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>(),</span> <span class=n>event</span><span class=o>.</span><span class=na>getDebitAmount</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>balance</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>balance</span><span class=o>.</span><span class=na>subtract</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getDebitAmount</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I defined an <code>InsufficientBalanceException</code> for handling an error while debiting money:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>InsufficientBalanceException</span> <span class=kd>extends</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>InsufficientBalanceException</span><span class=o>(</span><span class=n>UUID</span> <span class=n>accountId</span><span class=o>,</span> <span class=n>BigDecimal</span> <span class=n>debitAmount</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=s>&#34;Insufficient Balance: Cannot debit &#34;</span> <span class=o>+</span> <span class=n>debitAmount</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>                <span class=s>&#34; from account number [&#34;</span> <span class=o>+</span> <span class=n>accountId</span><span class=o>.</span><span class=na>toString</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>At this stage, we created the <strong>aggregate</strong> that receives and handles the <strong>Commands</strong> and for every <strong>Command</strong> will dispatch a <strong>Query</strong>.</p><p>Good ! But no data is inserted in the DB, no boundary is available to emit instructions ü•∫</p><p>Now we will create the <em>JPA Repository</em> for our <strong>BankAccount</strong> <em>JPA Entity</em>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Repository</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>BankAccountRepository</span> <span class=kd>extends</span> <span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>,</span> <span class=n>UUID</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, we can use the <strong>BankAccountRepository</strong> to made CRUD operations on <strong>BankAccount</strong> in the DB. Ok, but from where ?</p><p>You can think in the <strong>BankAccountAggregate</strong>, but it will not be suitable, as it will be doing many tasks which will cause us to lose the <em><strong>Single Responsibility principle</strong></em>.</p><p>The common practice is to create a dedicated class that will match the DB operations for every received event. I saw that the <strong>Axon team is calling it Projector class</strong>.</p><p>We will call our <strong>Projector</strong> class <strong>BankAccountProjection</strong> that looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RequiredArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BankAccountProjection</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>BankAccountRepository</span> <span class=n>repository</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>BankAccountProjection</strong> is a <strong>Spring Component</strong> on which we injected our <strong>BankAccountRepository</strong>.</p><p>Good ! Now, we need to define the <strong>Handler</strong> for every emitted <strong>Event</strong>. For example, the <strong>EventHandler</strong> for <strong>AccountCreatedEvent</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EventHandler</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>AccountCreatedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Handling a Bank Account creation command {}&#34;</span><span class=o>,</span> <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>BankAccount</span> <span class=n>bankAccount</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BankAccount</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=na>getOwner</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>event</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Opppaaa ü•≥ ! The <strong>Event</strong> is serving as a <strong>DTO</strong> wrapping the needed values to create a <strong>BankAccount</strong> üòÅ</p><p>The same thing for the <strong>MoneyCreditedEvent</strong> and <strong>MoneyDebitedEvent</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nd>@EventHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>MoneyCreditedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>AccountNotFoundException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Handling an Account Credit command {}&#34;</span><span class=o>,</span> <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Optional</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=n>optionalBankAccount</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>optionalBankAccount</span><span class=o>.</span><span class=na>isPresent</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>BankAccount</span> <span class=n>bankAccount</span> <span class=o>=</span> <span class=n>optionalBankAccount</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bankAccount</span><span class=o>.</span><span class=na>setBalance</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getCreditAmount</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>AccountNotFoundException</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@EventHandler</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>on</span><span class=o>(</span><span class=n>MoneyDebitedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>AccountNotFoundException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Handling an Account Debit command {}&#34;</span><span class=o>,</span> <span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Optional</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=n>optionalBankAccount</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>optionalBankAccount</span><span class=o>.</span><span class=na>isPresent</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>BankAccount</span> <span class=n>bankAccount</span> <span class=o>=</span> <span class=n>optionalBankAccount</span><span class=o>.</span><span class=na>get</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>bankAccount</span><span class=o>.</span><span class=na>setBalance</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>.</span><span class=na>getBalance</span><span class=o>().</span><span class=na>subtract</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getDebitAmount</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>bankAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>AccountNotFoundException</span><span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getId</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>Here, I defined an <strong>AccountNotFoundException</strong> thrown¬†when no account is found:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountNotFoundException</span> <span class=kd>extends</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>AccountNotFoundException</span><span class=o>(</span><span class=n>UUID</span> <span class=n>id</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>super</span><span class=o>(</span><span class=s>&#34;Cannot found account number [&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Yoopi ! ü§© Now, we will need the REST API and the <strong>Spring Service</strong> that will be receiving the <strong>HTTP Requests</strong> and dispatching the <strong>Commands</strong> to the <strong>Axon Engine</strong>.</p><p>Let&rsquo;s start by the <strong>REST API</strong> for the <strong>Commands</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/accounts&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Api</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;Bank Account Commands&#34;</span><span class=o>,</span> <span class=n>description</span> <span class=o>=</span> <span class=s>&#34;Bank Account Commands API&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountCommandController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>AccountCommandService</span> <span class=n>accountCommandService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@PostMapping</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=n>CREATED</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=nf>createAccount</span><span class=o>(</span><span class=nd>@RequestBody</span> <span class=n>AccountCreationDTO</span> <span class=n>creationDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>accountCommandService</span><span class=o>.</span><span class=na>createAccount</span><span class=o>(</span><span class=n>creationDTO</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@PutMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/credit/{accountId}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>creditMoneyToAccount</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;accountId&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>accountId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                          <span class=nd>@RequestBody</span> <span class=n>MoneyAmountDTO</span> <span class=n>moneyCreditDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>accountCommandService</span><span class=o>.</span><span class=na>creditMoneyToAccount</span><span class=o>(</span><span class=n>accountId</span><span class=o>,</span> <span class=n>moneyCreditDTO</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@PutMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/debit/{accountId}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>debitMoneyFromAccount</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;accountId&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>accountId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                           <span class=nd>@RequestBody</span> <span class=n>MoneyAmountDTO</span> <span class=n>moneyDebitDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>accountCommandService</span><span class=o>.</span><span class=na>debitMoneyFromAccount</span><span class=o>(</span><span class=n>accountId</span><span class=o>,</span> <span class=n>moneyDebitDTO</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>AccountCreationDTO</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Value</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountCreationDTO</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>BigDecimal</span> <span class=n>initialBalance</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>owner</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>MoneyAmountDTO</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>MoneyAmountDTO</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>BigDecimal</span> <span class=n>amount</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, we will create the <strong>Spring Service</strong> that will be dispatching the <strong>Commands</strong> to the <strong>Axon Engine</strong>. To do this, the framework has a very useful component called <strong>CommandGateway</strong>, which is a very convenient interface towards the command dispatching mechanism üòÅ</p><p>Our <strong>AccountCommandService</strong> will look like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountCommandService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>CommandGateway</span> <span class=n>commandGateway</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=nf>createAccount</span><span class=o>(</span><span class=n>AccountCreationDTO</span> <span class=n>creationDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>commandGateway</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=k>new</span> <span class=n>CreateAccountCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>UUID</span><span class=o>.</span><span class=na>randomUUID</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>creationDTO</span><span class=o>.</span><span class=na>getInitialBalance</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>creationDTO</span><span class=o>.</span><span class=na>getOwner</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>creditMoneyToAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                          <span class=n>MoneyAmountDTO</span> <span class=n>moneyCreditDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>commandGateway</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=k>new</span> <span class=n>CreditMoneyCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>formatUuid</span><span class=o>(</span><span class=n>accountId</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>moneyCreditDTO</span><span class=o>.</span><span class=na>getAmount</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>debitMoneyFromAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountId</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                                           <span class=n>MoneyAmountDTO</span> <span class=n>moneyDebitDTO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>commandGateway</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=k>new</span> <span class=n>DebitMoneyCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>formatUuid</span><span class=o>(</span><span class=n>accountId</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=n>moneyDebitDTO</span><span class=o>.</span><span class=na>getAmount</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Cool ! ü•≥ We need to define the <strong>Query</strong> part. Let&rsquo;s start by defining <strong>FindAccountQuery</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@NoArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FindBankAccountQuery</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>accountId</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In the <strong>BankAccountProjection</strong>, we need to add a <strong>QueryHandler</strong> method:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@QueryHandler</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>BankAccount</span> <span class=nf>handle</span><span class=o>(</span><span class=n>FindBankAccountQuery</span> <span class=n>query</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Handling FindBankAccountQuery query: {}&#34;</span><span class=o>,</span> <span class=n>query</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>repository</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>query</span><span class=o>.</span><span class=na>getAccountId</span><span class=o>()).</span><span class=na>orElse</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>We need to create the <strong>Query REST API</strong> and <strong>Service</strong>. The <strong>AccountQueryController</strong> looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/accounts&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Api</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;Bank Account Queries&#34;</span><span class=o>,</span> <span class=n>description</span> <span class=o>=</span> <span class=s>&#34;Bank Account Query Events API&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountQueryController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>AccountQueryService</span> <span class=n>accountQueryService</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=s>&#34;/{accountId}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=nf>findById</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=s>&#34;accountId&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>accountId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>accountQueryService</span><span class=o>.</span><span class=na>findById</span><span class=o>(</span><span class=n>accountId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=s>&#34;/{accountId}/events&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>listEventsForAccount</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;accountId&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>accountId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>accountQueryService</span><span class=o>.</span><span class=na>listEventsForAccount</span><span class=o>(</span><span class=n>accountId</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <strong>AccountQueryService</strong> looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=nd>@AllArgsConstructor</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>AccountQueryService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>QueryGateway</span> <span class=n>queryGateway</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>EventStore</span> <span class=n>eventStore</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>BankAccount</span><span class=o>&gt;</span> <span class=nf>findById</span><span class=o>(</span><span class=n>String</span> <span class=n>accountId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>queryGateway</span><span class=o>.</span><span class=na>query</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>FindBankAccountQuery</span><span class=o>(</span><span class=n>formatUuid</span><span class=o>(</span><span class=n>accountId</span><span class=o>)),</span>
</span></span><span class=line><span class=cl>                <span class=n>ResponseTypes</span><span class=o>.</span><span class=na>instanceOf</span><span class=o>(</span><span class=n>BankAccount</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=nf>listEventsForAccount</span><span class=o>(</span><span class=n>String</span> <span class=n>accountId</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>eventStore</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>readEvents</span><span class=o>(</span><span class=n>formatUuid</span><span class=o>(</span><span class=n>accountId</span><span class=o>).</span><span class=na>toString</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>asStream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Message</span><span class=o>::</span><span class=n>getPayload</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>**STOP!!**üëÆüèª‚Äç‚ôÇÔ∏è‚õîÔ∏è What is this strange <strong>EventStore</strong> ?? <strong>EventStore</strong> provides access to both the global event stream comprised of all domain and application events. We will be using it to list all the events about a given <strong>aggregate</strong>.</p><p>We need to add these properties to the <code>application.properties</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># H2 settings
</span></span><span class=line><span class=cl>spring.h2.console.enabled=true
</span></span><span class=line><span class=cl>spring.h2.console.path=/h2-console
</span></span><span class=line><span class=cl># Axon
</span></span><span class=line><span class=cl>axon.serializer.general=jackson
</span></span></code></pre></td></tr></table></div></div><p>We will be using <strong>Swagger</strong> to have a small <strong>UI</strong> to test our <strong>REST APIs</strong>. The <strong>SwaggerConfiguration</strong> file looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableSwagger2</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SwaggerConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>Docket</span> <span class=nf>apiDocket</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>Docket</span><span class=o>(</span><span class=n>DocumentationType</span><span class=o>.</span><span class=na>SWAGGER_2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>select</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>apis</span><span class=o>(</span><span class=n>RequestHandlerSelectors</span>
</span></span><span class=line><span class=cl>                        <span class=o>.</span><span class=na>basePackage</span><span class=o>(</span><span class=s>&#34;com.targa.labs.dev.cqrses&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>paths</span><span class=o>(</span><span class=n>PathSelectors</span><span class=o>.</span><span class=na>any</span><span class=o>())</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>build</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>apiInfo</span><span class=o>(</span><span class=n>getApiInfo</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>ApiInfo</span> <span class=nf>getApiInfo</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>new</span> <span class=n>ApiInfo</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;CQRS &amp; ES Sample App based on Spring Boot and Axon&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;App to demonstrate CQRS &amp; ES based on Spring Boot and Axon&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;0.0.1-SNAPSHOT&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Terms of Service&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>Contact</span><span class=o>(</span><span class=s>&#34;Nebrass Lamouchi&#34;</span><span class=o>,</span> <span class=s>&#34;https://blog.nebrass.fr&#34;</span><span class=o>,</span> <span class=s>&#34;lnibrass@gmail.com&#34;</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, let&rsquo;s start our application:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mvn spring-boot:run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Scanning <span class=k>for</span> projects...
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> ---------------------&lt; com.targa.labs.dev:cqrs-es &gt;---------------------
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Building cqrs-es 0.0.1-SNAPSHOT
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> --------------------------------<span class=o>[</span> jar <span class=o>]</span>---------------------------------
</span></span><span class=line><span class=cl>....
</span></span><span class=line><span class=cl>...AxonServerConnectionManager: Connecting using unencrypted connection...
</span></span><span class=line><span class=cl>...AxonServerConnectionManager: Requesting connection details from localhost:8124
</span></span><span class=line><span class=cl>...AxonServerConnectionManager: Connecting to AxonServer node <span class=o>[</span>localhost<span class=o>]</span>:<span class=o>[</span>8124<span class=o>]</span> failed: UNAVAILABLE: io exception
</span></span><span class=line><span class=cl>**********************************************
</span></span><span class=line><span class=cl>*                                            *
</span></span><span class=line><span class=cl>*  !!! UNABLE TO CONNECT TO AXON SERVER !!!  *
</span></span><span class=line><span class=cl>*                                            *
</span></span><span class=line><span class=cl>* Are you sure it<span class=s1>&#39;s running?                 *
</span></span></span><span class=line><span class=cl><span class=s1>* If you haven&#39;</span>t got Axon Server yet, visit  *
</span></span><span class=line><span class=cl>*       https://axoniq.io/download           *
</span></span><span class=line><span class=cl>*                                            *
</span></span><span class=line><span class=cl>**********************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To suppress this message, you can
</span></span><span class=line><span class=cl> - explicitly configure an AxonServer location,
</span></span><span class=line><span class=cl> - start with -Daxon.axonserver.suppressDownloadMessage<span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>...AxonServerQueryBus: Error subscribing query handler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>org.axonframework.axonserver.connector.AxonServerException: No connection to AxonServer available
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>...DocumentationPluginsBootstrapper: Context refreshed
</span></span><span class=line><span class=cl>...TrackingEventProcessor: Fetch Segments <span class=k>for</span> Processor <span class=s1>&#39;com.targa.labs.dev.cqrses.projection&#39;</span> failed: No connection to AxonServer available. Preparing <span class=k>for</span> retry in 1s
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>Wooh üò±üò±üò± These errors are due to a missing <strong>Axon Server</strong>. We can start a new instance it easily using a <strong>Docker Container</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker run -d --name axon-server -p 8024:8024 -p 8124:8124 axoniq/axonserver
</span></span></code></pre></td></tr></table></div></div><p>Now, the <strong>Axon Server UI</strong> will be reachable on <a href=http://localhost:8024/>http://localhost:8024/</a></p><div align=center><p><img loading=lazy src=../images/axon-server-ui.webp alt="Axon Server UI" title="Axon Server UI">
Axon Server UI</p></div><p>If you click on the <strong>Overview</strong> section:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-overview.webp alt="Axon Server UI - Overview" title="Axon Server UI - Overview">
Axon Server UI - Overview</p></div><p>Next, check the <strong>Commands</strong>¬†section:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-commands.webp alt="Axon Server UI - Commands" title="Axon Server UI - Commands">
Axon Server UI - Commands</p></div><p>Next, check the <strong>Queries</strong>¬†section:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-queries.webp alt="Axon Server UI - Queries" title="Axon Server UI - Queries">
Axon Server UI - Queries</p></div><p>Nothing wrong üòÜ Don&rsquo;t be scared, as no application is communicating with the <strong>Axon Server</strong>, everything is empty.</p><p>Let&rsquo;s start now the application again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mvn spring-boot:run                                                  
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Scanning <span class=k>for</span> projects...
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> 
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> ---------------------&lt; com.targa.labs.dev:cqrs-es &gt;---------------------
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Building cqrs-es 0.0.1-SNAPSHOT
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> --------------------------------<span class=o>[</span> jar <span class=o>]</span>---------------------------------
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>  .   ____          _            __ _ _
</span></span><span class=line><span class=cl> /<span class=se>\\</span> / ___<span class=s1>&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
</span></span></span><span class=line><span class=cl><span class=s1>( ( )\___ | &#39;</span>_ <span class=p>|</span> <span class=s1>&#39;_| | &#39;</span>_ <span class=se>\/</span> _<span class=sb>`</span> <span class=p>|</span> <span class=se>\ \ \ \
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=se>\\</span>/  ___<span class=o>)</span><span class=p>|</span> <span class=p>|</span>_<span class=o>)</span><span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=p>|</span> <span class=o>||</span> <span class=o>(</span>_<span class=p>|</span> <span class=p>|</span>  <span class=o>)</span> <span class=o>)</span> <span class=o>)</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;  |____| .__|_| |_|_| |_\__, | / / / /
</span></span></span><span class=line><span class=cl><span class=s1> =========|_|==============|___/=/_/_/_/
</span></span></span><span class=line><span class=cl><span class=s1> :: Spring Boot ::        (v2.2.2.RELEASE)
</span></span></span><span class=line><span class=cl><span class=s1>...
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerConnectionManager      : Connecting using unencrypted connection...
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerConnectionManager      : Requesting connection details from localhost:8124
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerConnectionManager       : Reusing existing channel
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerConnectionManager       : Re-subscribing commands and queries
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerCommandBus              : Creating new command stream subscriber
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerQueryBus                : Creating new query stream subscriber
</span></span></span><span class=line><span class=cl><span class=s1>..DocumentationPluginsBootstrapper  : Context refreshed
</span></span></span><span class=line><span class=cl><span class=s1>..DocumentationPluginsBootstrapper  : Found 1 custom documentation plugin(s)
</span></span></span><span class=line><span class=cl><span class=s1>..ApiListingReferenceScanner        : Scanning for api listing references
</span></span></span><span class=line><span class=cl><span class=s1>..TrackingEventProcessor            : Worker assigned to segment Segment[0/0] for processing
</span></span></span><span class=line><span class=cl><span class=s1>..TrackingEventProcessor            : Using current Thread for last segment worker: TrackingSegmentWorker{processor=com.targa.labs.dev.cqrses.projection, segment=Segment[0/0]}
</span></span></span><span class=line><span class=cl><span class=s1>..TrackingEventProcessor            : Fetched token: null for segment: Segment[0/0]
</span></span></span><span class=line><span class=cl><span class=s1>..AxonServerEventStore              : open stream: 0
</span></span></span><span class=line><span class=cl><span class=s1>..TomcatWebServer   : Tomcat started on port(s): 8080 (http) with context path &#39;</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>..CqrsEsApplication : Started CqrsEsApplication in 5.262 seconds <span class=o>(</span>JVM running <span class=k>for</span> 5.532<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Cool ! Let&rsquo;s access now the <strong>Swagger UI</strong> on <a href=http://localhost:8080/swagger-ui.html>http://localhost:8080/swagger-ui.html</a>:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui.webp alt="Swagger UI" title="Swagger UI">
Swagger UI</p></div><p>As you see, there is already two <strong>REST Controllers</strong> one for the <strong>Commands</strong> and one for the <strong>Queries</strong>. Let&rsquo;s test the <strong>createAccount REST API</strong>:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui-create-account.webp alt="Create Account - Swagger UI" title="Create Account - Swagger UI">
Create Account - Swagger UI</p></div><p>Here we created a new <strong>BankAccount</strong> that has:</p><ul><li><strong>id:</strong> 962f7577-19b6-439b-9368-9742b44d2a20</li><li><strong>initialBalance:</strong> 5000</li><li><strong>owner:</strong> Nebrass Lamouchi</li></ul><p>Next, I will test some <strong>creditMoneyToAccount</strong>¬†operation <strong>twice</strong> the first with an amount of <strong>300</strong> and the second with <strong>480</strong>:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui-credit-account.webp alt="Credit Account - Swagger UI" title="Credit Account - Swagger UI">
Credit Account - Swagger UI</p></div><p>Let&rsquo;s <strong>debit</strong> the amount of <strong>2000</strong> from the sample account using the <strong>debitMoneyFromAccount</strong> operation:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui-debit-account.webp alt="Debit Account ‚Äì Swagger UI" title="Debit Account ‚Äì Swagger UI">
Debit Account ‚Äì Swagger UI</p></div><p>Now, we need to check how much we have in our account, normally the remaining balance will be <strong>5000 + 300 + 480-2000 = 3780</strong>.</p><p>Let&rsquo;s check the account using the <strong>findById</strong> operation on the <strong>AccountQueryController</strong>:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui-get-account.webp alt="Find Account by ID ‚Äì Swagger UI" title="Find Account by ID ‚Äì Swagger UI">
Find Account by ID ‚Äì Swagger UI</p></div><p>As expected ! <strong>the balance is 3780</strong> ü§©</p><p>We can verify the Events list occurred on our <strong>BankAccount</strong> using the <strong>listEventsForAccount</strong> operation:</p><div align=center><p><img loading=lazy src=../images/cqrs-es-swagger-ui-account-events-list.webp alt="Account Events list ‚Äì Swagger UI" title="Account Events list ‚Äì Swagger UI">
Account Events list ‚Äì Swagger UI</p></div><p>Great ! Everything is working like a charm ! ü•≥</p><p>After we executed our application and after we did some operations, let&rsquo;s visit again the <strong>Axon Server UI</strong>:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-overview-filled.webp alt="Axon Server UI - Overview after execution" title="Axon Server UI - Overview after execution">
Axon Server UI - Overview after execution</p></div><p>As you see, our application instance is spotted on the <strong>Axon Dashboard</strong>. Let&rsquo;s move to the <strong>Commands</strong> section:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-commands-filled.webp alt="Axon Server UI - Commands after execution" title="Axon Server UI - Commands after execution">
Axon Server UI - Commands after execution</p></div><p>You already see that the <strong>CreateAccountCommand</strong> was fired once, the <strong>CreditMoneyCommand</strong> twice (300 & 480) and the <strong>DebitMoneyCommand</strong> once (2000).</p><p>Next, move to the <strong>Queries</strong> section:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-queries-filled.webp alt="Axon Server UI - Queries after execution" title="Axon Server UI - Queries after execution">
Axon Server UI - Queries after execution</p></div><p>You can easily see that the <strong>FindBankAccountQuery</strong> was executed once.</p><p>You can see all of the <strong>Events</strong> in the <strong>Search</strong> section. Click directly on <strong>Search button</strong> to <strong>grab all the Events</strong>:</p><div align=center><p><img loading=lazy src=../images/axon-server-ui-search-everything.webp alt="Axon Server UI - Search section" title="Axon Server UI - Search section">
Axon Server UI - Search section</p></div><p>If you want to test our <strong>Axon</strong> code <strong>programmatically</strong>, we will start by adding the <strong>Axon Test module</strong> to the <code>pom.xml</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.axonframework<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>axon-test<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>4.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Next, we will create a <strong>BankAccountTest</strong> class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BankAccountTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>customerName</span> <span class=o>=</span> <span class=s>&#34;Nebrass&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>FixtureConfiguration</span><span class=o>&lt;</span><span class=n>BankAccountAggregate</span><span class=o>&gt;</span> <span class=n>fixture</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>UUID</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@BeforeEach</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setUp</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fixture</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AggregateTestFixture</span><span class=o>&lt;&gt;(</span><span class=n>BankAccountAggregate</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>id</span> <span class=o>=</span> <span class=n>UUID</span><span class=o>.</span><span class=na>randomUUID</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>should_dispatch_accountcreated_event_when_createaccount_command</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fixture</span><span class=o>.</span><span class=na>givenNoPriorActivity</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=k>new</span> <span class=n>CreateAccountCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1000</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                        <span class=n>customerName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>expectEvents</span><span class=o>(</span><span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1000</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                        <span class=n>customerName</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>should_dispatch_moneycredited_event_when_balance_is_lower_than_debit_amount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fixture</span><span class=o>.</span><span class=na>given</span><span class=o>(</span><span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1000</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                        <span class=n>customerName</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=k>new</span> <span class=n>CreditMoneyCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>100</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>expectEvents</span><span class=o>(</span><span class=k>new</span> <span class=n>MoneyCreditedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>100</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>should_dispatch_moneydebited_event_when_balance_is_upper_than_debit_amount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fixture</span><span class=o>.</span><span class=na>given</span><span class=o>(</span><span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1000</span><span class=o>),</span> 
</span></span><span class=line><span class=cl>                        <span class=n>customerName</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=k>new</span> <span class=n>DebitMoneyCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>100</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>expectEvents</span><span class=o>(</span><span class=k>new</span> <span class=n>MoneyDebitedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>100</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>should_not_dispatch_event_when_balance_is_lower_than_debit_amount</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fixture</span><span class=o>.</span><span class=na>given</span><span class=o>(</span><span class=k>new</span> <span class=n>AccountCreatedEvent</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>1000</span><span class=o>),</span> 
</span></span><span class=line><span class=cl>                        <span class=n>customerName</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=k>new</span> <span class=n>DebitMoneyCommand</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>id</span><span class=o>,</span> 
</span></span><span class=line><span class=cl>                        <span class=n>BigDecimal</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>5000</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>expectNoEvents</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In our <strong>BankAccountTest</strong> class, we are using <strong>FixtureConfiguration</strong> class which we will use to define a test scenario in terms of events and commands:</p><ul><li>Given certain events in the past</li><li>When executing this command</li><li>Expect these events to be published</li></ul><p>Our test are designed like:</p><ul><li>In the first test, we are testing an <strong>Account Creation operation</strong>:<ul><li>we are supposing that we don&rsquo;t have any account created</li><li>when we will dispatch a <strong>CreateAccountCommand</strong></li><li>we are expecting to get the a <strong>AccountCreatedEvent</strong> with the same values</li></ul></li><li>In the second test, we are testing the <strong>Credit Money operation</strong>:<ul><li>we are supposing that we have an account</li><li>when we will dispatch a <strong>CreditMoneyCommand</strong> with an amount of 100</li><li>we are expecting to get the a <strong>MoneyCreditedEvent</strong> with an amount of 100</li></ul></li><li>In the third test, we are testing the <strong>Debit Money operation</strong>:<ul><li>we are supposing that we have an account</li><li>when we will dispatch a <strong>Debit****MoneyCommand</strong> with an amount of 100</li><li>we are expecting to get the a <strong>MoneyDebitedEvent</strong> with an amount of 100</li></ul></li><li>In the third test, we are testing the impossibility to execute <strong>Debit Money operation</strong> when <strong>the requested amount is higher than the account balance</strong>:<ul><li>we are supposing that we have an account</li><li>when we will dispatch a <strong>Debit****MoneyCommand</strong> with an amount of 5000</li><li>we are expecting to have <strong>NO events that occurred</strong></li></ul></li></ul><div align=center><p><img loading=lazy src=../images/the-end-all-folks.webp alt="The end !" title="The end !">
The end !</p></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this tutorial, I have implemented a <strong>CQRS</strong> and <strong>Event Sourcing</strong> based <strong>Spring Boot application</strong> using the <strong>Axon Platform</strong>. This is a blog post I wanted to write from some time ago, but I couldn&rsquo;t find an opportunity until now. I tried to present the key concepts of the <strong>CQRS</strong> and <strong>Event Sourcing</strong> patterns and the main features offered by <strong>Axon Platform</strong>. I tried to make the demo using a very common example in the <strong>DDD</strong> world, the <strong>Bank Account</strong>.</p><p>I really encourage you to dig into the <strong>DDD paradigms</strong> especially that we have many great platforms like <strong>Axon</strong> which make our life easier.</p><p>The sample code of this tutorial can be found on <a href=https://github.com/nebrass/playing-with-cqrs-and-event-sourcing-in-spring-boot-and-axon>Github</a>.</p></div><footer class=post-footer><ul class=post-tags></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on twitter" href="https://twitter.com/intent/tweet/?text=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f&title=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon&summary=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon&source=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f&title=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on whatsapp" href="https://api.whatsapp.com/send?text=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon%20-%20https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with CQRS and Event Sourcing in Spring Boot and Axon on telegram" href="https://telegram.me/share/url?text=Playing%20with%20CQRS%20and%20Event%20Sourcing%20in%20Spring%20Boot%20and%20Axon&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-cqrs-and-event-sourcing-in-spring-boot-and-axon%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.nebrass.fr>Nebrass Homepage</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>