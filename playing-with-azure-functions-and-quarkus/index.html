<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Playing with Azure Functions and Quarkus | Nebrass Homepage</title>
<meta name=keywords content>
<meta name=description content="Quarkus is one of the current trends of the Java ecosystem. I&rsquo;m already in love with it. I&rsquo;m using it along with Spring Boot, and when I choose, I choose Quarkus. üòÅ
This week, I was working on a Batch POC using Azure Functions and Azure Automation. So I thought it will be useful to share the exercise with you. üòÅ
What I want to do? I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.">
<meta name=author content>
<link rel=canonical href=https://blog.nebrass.fr/playing-with-azure-functions-and-quarkus/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.9aeab43847eb11aca320bfadedfe191ed6516dd768bf1314b534c4992aac901a.css integrity="sha256-muq0OEfrEayjIL+t7f4ZHtZRbddovxMUtTTEmSqskBo=" rel="preload stylesheet" as=style>
<script src=/js/prism.min.js></script>
<link rel=stylesheet href=/css/prism.min.css>
<link rel=icon href=https://blog.nebrass.fr/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blog.nebrass.fr/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blog.nebrass.fr/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blog.nebrass.fr/apple-touch-icon.png>
<link rel=mask-icon href=https://blog.nebrass.fr/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<style amp-custom>.main,.footer,.nav{max-width:calc(var(--main-width) + var(--gap) * 15)}</style>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-111781986-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Playing with Azure Functions and Quarkus">
<meta property="og:description" content="Quarkus is one of the current trends of the Java ecosystem. I&rsquo;m already in love with it. I&rsquo;m using it along with Spring Boot, and when I choose, I choose Quarkus. üòÅ
This week, I was working on a Batch POC using Azure Functions and Azure Automation. So I thought it will be useful to share the exercise with you. üòÅ
What I want to do? I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.nebrass.fr/playing-with-azure-functions-and-quarkus/">
<meta property="og:image" content="https://blog.nebrass.fr/images/quarkus-azure-functions.webp"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-02-23T00:00:00+00:00">
<meta property="article:modified_time" content="2021-02-23T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.nebrass.fr/images/quarkus-azure-functions.webp">
<meta name=twitter:title content="Playing with Azure Functions and Quarkus">
<meta name=twitter:description content="Quarkus is one of the current trends of the Java ecosystem. I&rsquo;m already in love with it. I&rsquo;m using it along with Spring Boot, and when I choose, I choose Quarkus. üòÅ
This week, I was working on a Batch POC using Azure Functions and Azure Automation. So I thought it will be useful to share the exercise with you. üòÅ
What I want to do? I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.nebrass.fr/posts/"},{"@type":"ListItem","position":3,"name":"Playing with Azure Functions and Quarkus","item":"https://blog.nebrass.fr/playing-with-azure-functions-and-quarkus/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Playing with Azure Functions and Quarkus","name":"Playing with Azure Functions and Quarkus","description":"Quarkus is one of the current trends of the Java ecosystem. I\u0026rsquo;m already in love with it. I\u0026rsquo;m using it along with Spring Boot, and when I choose, I choose Quarkus. üòÅ\nThis week, I was working on a Batch POC using Azure Functions and Azure Automation. So I thought it will be useful to share the exercise with you. üòÅ\nWhat I want to do? I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.","keywords":[],"articleBody":"Quarkus is one of the current trends of the Java ecosystem. I‚Äôm already in love with it. I‚Äôm using it along with Spring Boot, and when I choose, I choose Quarkus. üòÅ\nThis week, I was working on a Batch POC using Azure Functions and Azure Automation. So I thought it will be useful to share the exercise with you. üòÅ\nWhat I want to do? I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.\nWhat will I be using? We will be using:\n Azure Functions with Quarkus Azure Java SDK Azure Cosmos DB  What do we need? For this tutorial, we will need:\n Java 11 Maven 3.6.3 An Azure Subscription - you can get a free 12-month Azure Subscription along with 200$ credit here Azure Functions Core Tools v3  Building the Azure Functions with Quarkus Quarkus already has a Maven Archetype that creates a skull for an Azure Function in Java with Quarkus. Let‚Äôs use it, and we will discover in detail what it will bring. To generate a new project, just do:\n1 2 3 4 5 6 7 8 9 10 11 12  $ mvn archetype:generate -B \\  -DarchetypeGroupId=io.quarkus \\  -DarchetypeArtifactId=quarkus-azure-functions-http-archetype \\  -DarchetypeVersion=1.12.0.Final \\  -DjavaVersion=11 \\  -DgroupId=com.targa.labs.dev \\  -DartifactId=azure-quarkus-func \\  -Dversion=1.0.0-SNAPSHOT \\  -DappName=azure-resources-handler \\  -DappRegion=northeurope \\  -Dfunction=azure-resources-handler \\  -DresourceGroup=helloworld-rg   This Maven command will generate, in a batch mode (non-interactive), a Java Azure Function project with:\n Quarkus version: 1.12.0.Final Java version: 11 The Group Id: com.targa.labs.dev The Artifact Id: azure-quarkus-func The project version: 1.0.0-SNAPSHOT  There are also some specifications for the Azure Function Application:\n Resource Group: helloworld-rg Azure Function Application Region: North Europe Azure Function Application Name: azure-resources-handler  After generating the project, its structure will look like:\n You can notice here that there is an extra folder that we are not used to in regular Maven projects. Ok, what is this azure-config folder?\nIn the azure-config folder, we have three JSON files:\n function.json: binding configuration file - used to define how the function will be triggered. The default generated config is for HTTP Trigger: means that the function will be triggered using HTTP Requests host.json: function configuration file - used to active/deactivate the Extensions Bundle local.settings.json: credentials and settings file - used to   For more information about these files, you can check this previous post about Java Azure Functions: Playing with Java in Azure Functions\n Next, in the Java classes, you can notice these 4 Greeting_SOMETHING_ classes. These four classes are the four ways of exposing REST APIs:\n Using JAX-RS: Java EE compliant implementation Using Servlets: Java EE compliant implementation Using the Eclipse Vert.x: The Event-Driven application framework used for creating Reactive Applications Using the Funky Framework üòÇ no ! seriously, its name is Funqy Framework: a Java library from the Quarkus family used for creating Serverless Functions that can be deployed to many Function-as-Service Solutions like Azure Function or AWS Lambda‚Ä¶  These four classes come with their respective Maven Dependencies, listed already in the pom.xml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23     io.quarkus quarkus-resteasy    io.quarkus quarkus-undertow    io.quarkus quarkus-vertx-web    io.quarkus quarkus-funqy-http  ...    Cool! üòÅ I will be using JAX-RS only in this tutorial.\nGood! Now, we will test this sample project with this Maven command:\n1  $ mvn clean install -DskipTests azure-functions:run   The build will start, and the most important part is the one from the azure-functions-maven-plugin:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  [INFO] Scanning for projects... [INFO] [INFO] ------------------------------- [INFO] Building azure-quarkus-func 1.0.0-SNAPSHOT [INFO] --------------------------------[ jar ]--------------------------------- ... [INFO] --- azure-functions-maven-plugin:1.9.2:run (default-cli) @ azure-quarkus-func --- ... [INFO] Azure Function App's staging directory found at: /home/nebrass/java/functions/azure-quarkus-function/target/azure-functions/quarkus-function [INFO] Azure Functions Core Tools found. Azure Functions Core Tools Core Tools Version: 3.0.3284 Commit hash: 98bc25e668274edd175a1647fe5a9bc4ffb6887d Function Runtime Version: 3.0.15371.0 ... Functions: azure-resources-handler: [GET,POST,HEAD,PUT,OPTIONS,DELETE] http://localhost:7071/api/{*path} [2021-02-26T22:34:05.752Z] Worker process started and initialized. [2021-02-26T22:34:10.399Z] Host lock lease acquired by instance ID '000000000000000000000000D5E3A1F8'.   You can notice that the plugin listed the ‚Äúazure-resources-handler‚Äù function is available under http://localhost:7071/api/{*path}, and the support HTTP verbs are GET, POST, HEAD, PUT, OPTION, DELETE. This list of verbs is provided from the function.json file, in the bindings configuration section:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  { \"scriptFile\" : \"../${project.build.finalName}.jar\", \"entryPoint\" : \"io.quarkus.azure.functions.resteasy.runtime.Function.run\", \"bindings\" : [ { \"type\" : \"httpTrigger\", \"direction\" : \"in\", \"name\" : \"req\", \"route\" : \"{*path}\", \"methods\" : [ \"GET\", \"POST\", \"HEAD\", \"PUT\", \"OPTIONS\", \"DELETE\" ], \"dataType\" : \"binary\", \"authLevel\" : \"ANONYMOUS\" }, { \"type\" : \"http\", \"direction\" : \"out\", \"name\" : \"$return\" } ] }   If you want to restrict access to a specific HTTP verb, it‚Äôs here where you can tune your HTTP Triggered function. üòÅ\nWe will now implement the first API, which will be returning the list of¬†VMs information: VM Name and its Resource Group and Status (running or not). We will create a DTO class that will represent the VM info that we want:\n1 2 3 4 5 6 7 8  @Data @AllArgsConstructor @NoArgsConstructor public class VmDTO { private String name; private String status; private String resourceGroup; }   ‚ö†Ô∏è We need to add the Lombok Framework library to the pom.xml\nTo do that, we need to use the Azure SDK Java Libraries. We start by adding the Azure Resource Manager SDK. The Resource Manager in Azure is the main component that we ask for handling (creating, removing, etc..) any given resource.\nThe Azure SDK team provides developer docs. You can know more about the Resource Manager SDK at https://azure.github.io/azure-sdk-for-java/resources.html.\nSo, first of all, we need to add this dependency to the pom.xml:\n1 2 3 4 5   com.azure.resourcemanager azure-resourcemanager 2.2.0    Now we will create the VmManager: a class that will be accessing the Azure Resource Manager API to do the VMs operations. But this communication with the API will need security credentials like a Token. So, we need to add another library that can help the VmManager authenticate to the Azure API. This library will be the Azure Identity. So we need to add its dependency to the pom.xml:\n1 2 3 4 5   com.azure azure-identity 1.2.3    Good üòÅ This Identity library will help the application access the API using some credentials that I need to provide to the application, like a Login and Password. But this is an application, not a human. This is why I will create an Azure Service Principal that will identify and authenticate our application to access the Azure Resources. Based on the Microsoft Docs:\n An Azure service principal is an identity created for use with applications, hosted services, and automated tools to access Azure resources. This access is restricted by the roles assigned to the service principal, giving you control over which resources can be accessed and at which level. For security reasons, it‚Äôs always recommended to use service principals with automated tools rather than allowing them to log in with a user identity.\n First of all, you need to be authenticated to Azure CLI¬†using the az login command. Then, to create the Service Principal, just do:\n1  $ az ad sp create-for-rbac --name QuarkusServicePrincipal   The command output will look like:\n1 2 3 4 5 6 7  { \"appId\": \"856f5c37-a639-4e1e-b294-e6391c396698\", \"displayName\": \"QuarkusServicePrincipal\", \"name\": \"http://QuarkusServicePrincipal\", \"password\": \"M6_6OF4q9t-kNrKISZG-0p0qv-FnZ8EdM~\", \"tenant\": \"2cf6bd3b-ef71-47c4-9d5d-06abe42bb3a6\" }   Our application will use these credentials to authenticate against the Azure API:\n The appId is the Client ID üëâÔ∏è needs to be defined in the Environment Variables as AZURE_CLIENT_ID The password is the Client Secret üëâÔ∏è needs to be defined in the Environment Variables as AZURE_CLIENT_SECRET The tenant üëâÔ∏è needs to be defined in the Environment Variables as AZURE_TENANT_ID  These credentials need to be defined in the Environment Variables, as our Azure Identity components will seek these values from the Environment. This design is better than inserting the credentials directly in the source code or in the properties files.\nTo create an AzureResourceManager instance using these credentials, just use this snippet:\n1 2 3 4 5 6 7 8  AzureProfile profile = new AzureProfile(AzureEnvironment.AZURE); TokenCredential credential = new DefaultAzureCredentialBuilder() .authorityHost(profile.getEnvironment().getActiveDirectoryEndpoint()) .build(); AzureResourceManager azureResourceManager = AzureResourceManager .authenticate(credential, profile) .withDefaultSubscription();   Now we can implement the getAvailableVms() method:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  @ApplicationScoped public class AzureVmManager { private final AzureResourceManager azureResourceManager; public AzureVmManager() { AzureProfile profile = new AzureProfile(AzureEnvironment.AZURE); TokenCredential credential = new DefaultAzureCredentialBuilder() .authorityHost(profile.getEnvironment().getActiveDirectoryEndpoint()) .build(); azureResourceManager = AzureResourceManager .authenticate(credential, profile) .withDefaultSubscription(); } public ListVmDTO getAvailableVMs() { ListString rgList = azureResourceManager.resourceGroups() .list() .stream() .map(HasName::name) .collect(Collectors.toList()); ListVmDTO vmList = new ArrayList(); for (String resourceGroup : rgList) { azureResourceManager.virtualMachines() .listByResourceGroup(resourceGroup) .forEach(vm - vmList.add( new VmDTO( vm.name(), vm.powerState().toString(), resourceGroup ) )); } return vmList; } }   In the getAvailableVms() method, we list the resource groups, and for every resource group, we list its VMs.\nGood üòÑ Now let‚Äôs edit the REST Resource to send the List of VmDTOs:\n1 2 3 4 5 6 7 8 9 10 11 12  @Path(\"/vms\") public class VMsResource { @Inject AzureVmManager azureVmManager; @GET @Produces(MediaType.APPLICATION_JSON) public ListVmDTO getAvailableVMs() { return azureVmManager.getAvailableVMs(); } }   Let‚Äôs test the project now. Just do this Maven command:\n1  $ mvn clean install -DskipTests azure-functions:run   Then, if you open the http://localhost:7071/api/vms URL, the result will look like:\nDon‚Äôt be scared if you got an empty array üòÖ Be sure that you already have some VMs in your subscription.\nNext, we will implement the Start and Stop VM methods in the AzureVmManager class:\n1 2 3 4 5 6 7 8 9  ... public void startVM(VmDTO vmDTO) { azureResourceManager.virtualMachines().start(vmDTO.getResourceGroup(), vmDTO.getName()); } public void stopVM(VmDTO vmDTO) { azureResourceManager.virtualMachines().deallocate(vmDTO.getResourceGroup(), vmDTO.getName()); } }   Then, we need to expose them in the REST API:\n1 2 3 4 5 6 7 8 9 10 11 12 13  @POST @Path(\"/start\") @Consumes(MediaType.APPLICATION_JSON) public void startVM(VmDTO vmDTO){ azureVmManager.startVM(vmDTO); } @POST @Path(\"/stop\") @Consumes(MediaType.APPLICATION_JSON) public void stopVM(VmDTO vmDTO){ azureVmManager.stopVM(vmDTO); }   Excellent! ü•≥ Now we will add the scenario of storing the start/stop events to the Azure Cosmos DB.\nBut before, we need to create the Event model class:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  @Data @AllArgsConstructor @NoArgsConstructor public class VmEvent { private VmEventType type; private String id; private String name; private String resourceGroup; private Date date; public VmEvent(VmEventType type, String name, String resourceGroup) { this.type = type; this.name = name; this.resourceGroup = resourceGroup; this.id = UUID.randomUUID().toString(); this.date = new Date(); } } enum VmEventType { START, STOP; }   Let‚Äôs play with CosmosDB now! ü§©\nAdding Azure CosmosDB to the Game The first step is to create:\n a new CosmosDB account if you don‚Äôt have one already a new CosmosDB database and name it events-db a new CosmosDB container and name it events with /name as Partition key  Then keep aside the Connection String as our application will use it in order to access the Cosmos DB.\nIf you didn‚Äôt that before, you can find a guided tutorial about Azure Cosmos DB here.\nThe Connection String needs to be added to the local.settings.json file, under the ‚ÄúCosmosDbConnection‚Äù entry.\nNow, we will need to add the CosmosDB Client to the AzureVmManager class. But, before that, we need to have a method that can be parsing the Connection String to extract the required credentials which are needed for authenticating the Cosmos DB Client.\nThe Connection String has the format: AccountEndpoint=https://xxxxxxxx.documents.azure.com:443/;AccountKey=RpiUBg4mK0xBIKqPRpiUBg4mK0xBIKqP==;\nTo parse it, I will split the AccountEndpoint and AccountKey parts using the ; sign, and then I will split the KEY=VALUE expression using the = sign. Then I will be storing these credentials in a Map.\nMy getCosmosDbCredentials() method looks like:\n1 2 3 4 5 6 7 8 9 10 11 12 13  private MapString, String getCosmosDbCredentials() { MapString, String credentials = new HashMap(); String cosmosDbConnection = System.getenv(\"CosmosDbConnection\"); String[] elements = cosmosDbConnection.split(\";\"); for (String element : elements) { String[] split = element.split(\"=\"); credentials.put(split[0], split[1]); } return credentials; }   The System.getenv(\"CosmosDbConnection\") instruction will grab the CosmosDbConnection from the System Environment Variables. This is will work, as we added the ‚ÄúCosmosDbConnection‚Äù entry to the local.settings.json, then, Azure Function Runtime will make this entry available as an Environment Variable.\nExcellent! Now, if to instantiate the CosmosClient we will do:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  AzureResourceManager azureResourceManager = AzureResourceManager .authenticate(credential, profile) .withDefaultSubscription(); MapString, String credentials = getCosmosDbCredentials(); CosmosClient cosmosClient = new CosmosClientBuilder() .endpoint(credentials.get(\"AccountEndpoint\")) .key(credentials.get(\"AccountKey\")) .buildClient(); cosmosContainer = cosmosClient .getDatabase(\"events-db\") .getContainer(\"events\");   Then, we will use the cosmosContainer to do the CRUD operations in the Azure Cosmos DB. To insert a VmEvent into CosmosDB, we create the method sendData():\n1 2 3  public void sendData(VmEvent vmEvent) { cosmosContainer.createItem(vmEvent); }   We will include this method into the start/stop VM methods:\n1 2 3 4 5 6 7 8 9 10 11 12 13  public void startVM(VmDTO vmDTO) { azureResourceManager.virtualMachines().start(vmDTO.getResourceGroup(), vmDTO.getName()); sendData( new VmEvent(VmEventType.START, vmDTO.getName(), vmDTO.getResourceGroup()) ); } public void stopVM(VmDTO vmDTO) { azureResourceManager.virtualMachines().deallocate(vmDTO.getResourceGroup(), vmDTO.getName()); sendData( new VmEvent(VmEventType.STOP, vmDTO.getName(), vmDTO.getResourceGroup()) ); }   Then, we will create a method that grabs the stored events - in the AzureVmManager:\n1 2 3 4 5 6 7 8  public ListVmEvent getLogs() { String SELECT_ALL_LOGS_QUERY = \"SELECT * FROM c\"; return cosmosContainer .queryItems(SELECT_ALL_LOGS_QUERY, new CosmosQueryRequestOptions(), VmEvent.class) .stream() .collect(Collectors.toList()); }   Next, we will expose the getLogs() in the REST Resource:\n1 2 3 4 5 6  @GET @Path(\"/logs\") @Produces(MediaType.APPLICATION_JSON) public ListVmEvent logs(){ return azureVmManager.getLogs(); }   Excellent! Now, let‚Äôs run this function locally using the command:\n1  $ mvn clean install -DskipTests azure-functions:run   After the application starts, we will use the list available VMs API, then we will choose a VM, and will start or stop many times, then we will check the get Logs API in order to get the events.\n‚ÑπÔ∏è I will use the HTTPie as a REST CLI\nGet the VMs:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  http http://localhost:7071/api/vms HTTP/1.1 200 OK Content-Length: 265 Content-Type: application/json Date: Tue, 02 Mar 2021 16:53:15 GMT Server: Kestrel [ { \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"status\": \"PowerState/deallocated\" }, { \"name\": \"wordpress-vm\", \"resourceGroup\": \"blog-rg\", \"status\": \"PowerState/running\" }, { \"name\": \"agent-builder\", \"resourceGroup\": \"quarkus-book-rg\", \"status\": \"PowerState/deallocated\" } ]   Start the quarkus-vm machine:\n1 2 3 4 5 6 7  echo '{ \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\" }' \\ | http POST http://localhost:7071/api/vms/start --timeout=300 HTTP/1.1 204 No Content Content-Length: 0 Date: Tue, 02 Mar 2021 16:47:53 GMT Server: Kestrel   Stop it:\n1 2 3 4 5 6 7  echo '{ \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\" }' \\ | http POST http://localhost:7071/api/vms/stop --timeout=300 HTTP/1.1 204 No Content Content-Length: 0 Date: Tue, 02 Mar 2021 16:48:51 GMT Server: Kestrel   ‚ö†Ô∏è Be sure to have the --timeout=300 in the HTTPie command, because the REST call can take more than 30 seconds, which is the default HTTPie timeout.\nThen we will get the Logs:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  http http://localhost:7071/api/vms/logs HTTP/1.1 200 OK Content-Length: 1366 Content-Type: application/json Date: Tue, 02 Mar 2021 16:59:12 GMT Server: Kestrel [ { \"date\": 1614703368791, \"id\": \"f33e9ed4-086d-4ccf-88d5-f4f4f32ba74e\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"START\" }, { \"date\": 1614703445766, \"id\": \"bb03fb09-e07a-4182-8429-baa48cf43b35\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"STOP\" }, { \"date\": 1614703604793, \"id\": \"ce8c06fe-d00b-47ba-a0e3-38670fc2878e\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"START\" }, { \"date\": 1614703674713, \"id\": \"a14f24e8-2b23-4f61-bb6c-c9154d839410\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"STOP\" } ]   Excellent, this data can be then used in your monitoring dashboards or monitoring services. Cool! Let‚Äôs deploy now our Azure Function Application üòÅ\nDeploying the Quarkus Azure Function As usual, it‚Äôs a very easy task: only one Maven Task will do the job ü§© Just be sure that the Azure CLI is authenticated:\n1  $ mvn clean install -DskipTests azure-functions:deploy   The process will take some time, then you will get an output that looks like:\n1 2 3 4 5 6 7 8 9 10  .... [INFO] Syncing triggers and fetching function information (Attempt 1/3)... [INFO] HTTP Trigger Urls: [INFO] quarkus-function : https://quarkus-function.azurewebsites.net/api/{*path} [INFO] ------------------------------------------------------------------------ [INFO] BUILD SUCCESS [INFO] ------------------------------------------------------------------------ [INFO] Total time: 01:59 min [INFO] Finished at: 2021-03-02T18:12:39+01:00 [INFO] ------------------------------------------------------------------------   In theory, the application will work now üòÜ but it‚Äôs not the case, yet!\nWe need to provide the AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID along with the CosmosDbConnection to the Function Environment. To do that, just go to the Azure portal and then go to the Function App menu.¬†Then go to the Configuration menu in order to access the Function Environment Variables, here where you need to add the required items:\nExcellent! Now, our Quarkus Function is ready for receiving our requests, let‚Äôs test it:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  http https://quarkus-function.azurewebsites.net/api/vms/logs HTTP/1.1 200 OK Content-Encoding: gzip Content-Type: application/json Date: Tue, 02 Mar 2021 17:25:27 GMT Request-Context: appId=cid-v1:a3251f24-8fcf-429f-8f94-07eae258f122 Transfer-Encoding: chunked Vary: Accept-Encoding [ { \"date\": 1614703368791, \"id\": \"f33e9ed4-086d-4ccf-88d5-f4f4f32ba74e\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"START\" }, { \"date\": 1614703445766, \"id\": \"bb03fb09-e07a-4182-8429-baa48cf43b35\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"STOP\" }, { \"date\": 1614703604793, \"id\": \"ce8c06fe-d00b-47ba-a0e3-38670fc2878e\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"START\" }, { \"date\": 1614703674713, \"id\": \"a14f24e8-2b23-4f61-bb6c-c9154d839410\", \"name\": \"quarkushop-vm\", \"resourceGroup\": \"quarkushop-rg\", \"type\": \"STOP\" } ]   Enjoy the game!\nConclusion In this tutorial, we learned how to use the Quarkus Azure Functions HTTP library and how to use Quarkus to create a powerful Azure Function üòÖ\nThe source code of this application is available here.\n","wordCount":"3040","inLanguage":"en","image":"https://blog.nebrass.fr/images/quarkus-azure-functions.webp","datePublished":"2021-02-23T00:00:00Z","dateModified":"2021-02-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nebrass.fr/playing-with-azure-functions-and-quarkus/"},"publisher":{"@type":"Organization","name":"Nebrass Homepage","logo":{"@type":"ImageObject","url":"https://blog.nebrass.fr/favicon.ico"}}}</script>
</head>
<body id=top>
<script>window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.nebrass.fr accesskey=h title="Nebrass Homepage (Alt + H)">Nebrass Homepage</a>
<span class=logo-switches>
</span>
</div>
<ul id=menu>
<li>
<a href=https://blog.nebrass.fr/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://blog.nebrass.fr/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://blog.nebrass.fr/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Playing with Azure Functions and Quarkus
</h1>
<div class=post-meta><span title="2021-02-23 00:00:00 +0000 UTC">February 23, 2021</span>&nbsp;¬∑&nbsp;15 min
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://blog.nebrass.fr/images/quarkus-azure-functions.webp alt>
</figure>
<div class=post-content><p><strong>Quarkus</strong> is one of the current trends of the Java ecosystem. I&rsquo;m already in love with it. I&rsquo;m using it along with Spring Boot, and when I choose, I choose <strong>Quarkus</strong>. üòÅ</p>
<p>This week, I was working on a <em>Batch POC</em> using <em><strong>Azure Functions</strong></em> and <em><strong>Azure Automation</strong></em>. So I thought it will be useful to share the exercise with you. üòÅ</p>
<h2 id=what-i-want-to-do>What I want to do?<a hidden class=anchor aria-hidden=true href=#what-i-want-to-do>#</a></h2>
<p>I will be taking a small use case: I need a batch that will be invoked at some specific time or manually, checking all the available VMs and starting or shutting down all those that we choose.</p>
<h2 id=what-will-i-be-using>What will I be using?<a hidden class=anchor aria-hidden=true href=#what-will-i-be-using>#</a></h2>
<p>We will be using:</p>
<ul>
<li><em>Azure Functions with Quarkus</em></li>
<li><em>Azure Java SDK</em></li>
<li><em>Azure Cosmos DB</em></li>
</ul>
<h2 id=what-do-we-need>What do we need?<a hidden class=anchor aria-hidden=true href=#what-do-we-need>#</a></h2>
<p>For this tutorial, we will need:</p>
<ul>
<li>Java 11</li>
<li>Maven 3.6.3</li>
<li>An Azure Subscription - you can get a free 12-month Azure Subscription along with 200$ credit <a href=https://azure.microsoft.com/en-us/free/>here</a></li>
<li>Azure Functions Core Tools v3</li>
</ul>
<h2 id=building-the-azure-functions-with-quarkus>Building the Azure Functions with Quarkus<a hidden class=anchor aria-hidden=true href=#building-the-azure-functions-with-quarkus>#</a></h2>
<p>Quarkus already has a <strong>Maven Archetype</strong> that creates a skull for an Azure Function in Java with Quarkus. Let&rsquo;s use it, and we will discover in detail what it will bring. To generate a new project, just do:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ mvn archetype:generate -B <span class=se>\
</span><span class=se></span>    -DarchetypeGroupId<span class=o>=</span>io.quarkus <span class=se>\
</span><span class=se></span>    -DarchetypeArtifactId<span class=o>=</span>quarkus-azure-functions-http-archetype <span class=se>\
</span><span class=se></span>    -DarchetypeVersion<span class=o>=</span>1.12.0.Final <span class=se>\
</span><span class=se></span>    -DjavaVersion<span class=o>=</span><span class=m>11</span> <span class=se>\
</span><span class=se></span>    -DgroupId<span class=o>=</span>com.targa.labs.dev <span class=se>\
</span><span class=se></span>    -DartifactId<span class=o>=</span>azure-quarkus-func <span class=se>\
</span><span class=se></span>    -Dversion<span class=o>=</span>1.0.0-SNAPSHOT <span class=se>\
</span><span class=se></span>    -DappName<span class=o>=</span>azure-resources-handler <span class=se>\ </span>
    -DappRegion<span class=o>=</span>northeurope <span class=se>\
</span><span class=se></span>    -Dfunction<span class=o>=</span>azure-resources-handler <span class=se>\
</span><span class=se></span>    -DresourceGroup<span class=o>=</span>helloworld-rg
</code></pre></td></tr></table>
</div>
</div><p>This Maven command will generate, in a batch mode (non-interactive), a Java Azure Function project with:</p>
<ul>
<li><strong>Quarkus version</strong>: <code>1.12.0.Final</code></li>
<li><strong>Java version</strong>: <code>11</code></li>
<li><strong>The Group Id</strong>: <code>com.targa.labs.dev</code></li>
<li><strong>The Artifact Id</strong>: <code>azure-quarkus-func</code></li>
<li><strong>The project version</strong>: <code>1.0.0-SNAPSHOT</code></li>
</ul>
<p>There are also some specifications for the <strong>Azure Function Application</strong>:</p>
<ul>
<li><strong>Resource Group</strong>: <code>helloworld-rg</code></li>
<li><strong>Azure Function Application Region</strong>: <code>North Europe</code></li>
<li><strong>Azure Function Application Name</strong>: <code>azure-resources-handler</code></li>
</ul>
<p>After generating the project, its structure will look like:</p>
<div align=center>
<p><img loading=lazy src=../images/azure-quarkus-function-project-structure.webp alt="Azure Quarkus Function Project Structure">
</p>
</div>
<p>You can notice here that there is an extra folder that we are not used to in regular Maven projects. Ok, what is this <code>azure-config</code> folder?</p>
<p>In the <code>azure-config</code> folder, we have three JSON files:</p>
<ul>
<li><code>function.json</code>: binding configuration file - used to define how the function will be triggered. The default generated config is for HTTP Trigger: means that the function will be triggered using HTTP Requests</li>
<li><code>host.json</code>: function configuration file - used to <em>active/deactivate</em> the <em>Extensions Bundle</em></li>
<li><code>local.settings.json</code>: credentials and settings file - used to</li>
</ul>
<blockquote>
<p>For more information about these files, you can check this previous post about Java Azure Functions: <a href=https://blog.nebrass.fr/playing-with-java-in-azure-functions-new-release/>Playing with Java in Azure Functions</a></p>
</blockquote>
<p>Next, in the Java classes, you can notice these 4 <strong>Greeting_SOMETHING_</strong> classes. These four classes are the four ways of exposing REST APIs:</p>
<ul>
<li>Using <em><strong>JAX-RS</strong></em>: Java EE compliant implementation</li>
<li>Using <em><strong>Servlets</strong></em>: Java EE compliant implementation</li>
<li>Using the <em><strong>Eclipse Vert.x</strong></em>: The Event-Driven application framework used for creating Reactive Applications</li>
<li>Using the <em><strong>Funky Framework</strong></em> üòÇ no ! seriously, its name is <em><strong>Funqy Framework</strong></em>: a Java library from the Quarkus family used for creating Serverless Functions that can be deployed to many <em><strong>Function-as-Service</strong></em> Solutions like Azure Function or AWS Lambda&mldr;</li>
</ul>
<p>These four classes come with their respective Maven Dependencies, listed already in the <code>pom.xml</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependencies&gt;</span>
  <span class=c>&lt;!-- remove if not using jaxrs --&gt;</span>
  <span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>io.quarkus<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>quarkus-resteasy<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;/dependency&gt;</span>
  <span class=c>&lt;!-- remove if not using servlets --&gt;</span>
  <span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>io.quarkus<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>quarkus-undertow<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;/dependency&gt;</span>
  <span class=c>&lt;!-- remove if not using vertx web --&gt;</span>
  <span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>io.quarkus<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>quarkus-vertx-web<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;/dependency&gt;</span>
  <span class=c>&lt;!-- remove if not using funqy --&gt;</span>
  <span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>io.quarkus<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>quarkus-funqy-http<span class=nt>&lt;/artifactId&gt;</span>
  <span class=nt>&lt;/dependency&gt;</span>
...
<span class=nt>&lt;/dependencies&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Cool! üòÅ I will be using <strong>JAX-RS</strong> only in this tutorial.</p>
<p>Good! Now, we will test this sample project with this Maven command:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ mvn clean install -DskipTests azure-functions:run
</code></pre></td></tr></table>
</div>
</div><p>The build will start, and the most important part is the one from the <code>azure-functions-maven-plugin</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>INFO<span class=o>]</span> Scanning <span class=k>for</span> projects...
<span class=o>[</span>INFO<span class=o>]</span> 
<span class=o>[</span>INFO<span class=o>]</span> ---------------&lt; com.targa.labs.dev:azure-quarkus-func &gt;----------------
<span class=o>[</span>INFO<span class=o>]</span> Building azure-quarkus-func 1.0.0-SNAPSHOT
<span class=o>[</span>INFO<span class=o>]</span> --------------------------------<span class=o>[</span> jar <span class=o>]</span>---------------------------------
...
<span class=o>[</span>INFO<span class=o>]</span> --- azure-functions-maven-plugin:1.9.2:run <span class=o>(</span>default-cli<span class=o>)</span> @ azure-quarkus-func ---
...
<span class=o>[</span>INFO<span class=o>]</span> Azure Function App<span class=s1>&#39;s staging directory found at: /home/nebrass/java/functions/azure-quarkus-function/target/azure-functions/quarkus-function
</span><span class=s1>[INFO] Azure Functions Core Tools found.
</span><span class=s1>
</span><span class=s1>Azure Functions Core Tools
</span><span class=s1>Core Tools Version:       3.0.3284 Commit hash: 98bc25e668274edd175a1647fe5a9bc4ffb6887d 
</span><span class=s1>Function Runtime Version: 3.0.15371.0
</span><span class=s1>...
</span><span class=s1>Functions:
</span><span class=s1>
</span><span class=s1>	azure-resources-handler: [GET,POST,HEAD,PUT,OPTIONS,DELETE] http://localhost:7071/api/{*path}
</span><span class=s1>
</span><span class=s1>[2021-02-26T22:34:05.752Z] Worker process started and initialized.
</span><span class=s1>[2021-02-26T22:34:10.399Z] Host lock lease acquired by instance ID &#39;</span>000000000000000000000000D5E3A1F8<span class=err>&#39;</span>.
</code></pre></td></tr></table>
</div>
</div><p>You can notice that the plugin listed the &ldquo;<em><strong>azure-resources-handler</strong></em>&rdquo; function is available under <a href=http://localhost:7071/api/%7B*path%7D>http://localhost:7071/api/{*path}</a>, and the support <em><strong>HTTP verbs</strong></em> are <em>GET, POST, HEAD, PUT, OPTION, DELETE</em>. This list of verbs is provided from the <code>function.json</code> file, in the <strong><em>bindings</em></strong> configuration section:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;scriptFile&#34;</span> <span class=p>:</span> <span class=s2>&#34;../${project.build.finalName}.jar&#34;</span><span class=p>,</span>
  <span class=nt>&#34;entryPoint&#34;</span> <span class=p>:</span> <span class=s2>&#34;io.quarkus.azure.functions.resteasy.runtime.Function.run&#34;</span><span class=p>,</span>
  <span class=nt>&#34;bindings&#34;</span> <span class=p>:</span> <span class=p>[</span> <span class=p>{</span>
    <span class=nt>&#34;type&#34;</span> <span class=p>:</span> <span class=s2>&#34;httpTrigger&#34;</span><span class=p>,</span>
    <span class=nt>&#34;direction&#34;</span> <span class=p>:</span> <span class=s2>&#34;in&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span> <span class=p>:</span> <span class=s2>&#34;req&#34;</span><span class=p>,</span>
    <span class=nt>&#34;route&#34;</span> <span class=p>:</span> <span class=s2>&#34;{*path}&#34;</span><span class=p>,</span>
    <span class=nt>&#34;methods&#34;</span> <span class=p>:</span> <span class=p>[</span> <span class=s2>&#34;GET&#34;</span><span class=p>,</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=s2>&#34;HEAD&#34;</span><span class=p>,</span> <span class=s2>&#34;PUT&#34;</span><span class=p>,</span> <span class=s2>&#34;OPTIONS&#34;</span><span class=p>,</span> <span class=s2>&#34;DELETE&#34;</span> <span class=p>],</span>
    <span class=nt>&#34;dataType&#34;</span> <span class=p>:</span> <span class=s2>&#34;binary&#34;</span><span class=p>,</span>
    <span class=nt>&#34;authLevel&#34;</span> <span class=p>:</span> <span class=s2>&#34;ANONYMOUS&#34;</span>
  <span class=p>},</span> <span class=p>{</span>
    <span class=nt>&#34;type&#34;</span> <span class=p>:</span> <span class=s2>&#34;http&#34;</span><span class=p>,</span>
    <span class=nt>&#34;direction&#34;</span> <span class=p>:</span> <span class=s2>&#34;out&#34;</span><span class=p>,</span>
    <span class=nt>&#34;name&#34;</span> <span class=p>:</span> <span class=s2>&#34;$return&#34;</span>
  <span class=p>}</span> <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>If you want to restrict access to a specific HTTP verb, it&rsquo;s here where you can tune your <strong>HTTP Triggered</strong> function. üòÅ</p>
<p>We will now implement the first API, which will be returning the list of¬† VMs information: VM Name and its Resource Group and Status (running or not). We will create a DTO class that will represent the VM info that we want:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Data</span>
<span class=nd>@AllArgsConstructor</span>
<span class=nd>@NoArgsConstructor</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>VmDTO</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>status</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>resourceGroup</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>‚ö†Ô∏è We need to add the <strong>Lombok</strong> <strong>Framework</strong> library to the <code>pom.xml</code></p>
<p>To do that, we need to use the <strong>Azure SDK Java Libraries.</strong> We start by adding the <strong>Azure Resource Manager SDK</strong>. The <strong>Resource Manager</strong> in <strong>Azure</strong> is the main component that we ask for handling (creating, removing, etc..) any given resource.</p>
<p>The <strong>Azure SDK</strong> team provides developer docs. You can know more about the <strong>Resource Manager SDK</strong> at <a href=https://azure.github.io/azure-sdk-for-java/resources.html>https://azure.github.io/azure-sdk-for-java/resources.html</a>.</p>
<p>So, first of all, we need to add this dependency to the <code>pom.xml</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>com.azure.resourcemanager<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>azure-resourcemanager<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>2.2.0<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we will create the <strong>VmManager</strong>: a class that will be accessing the <strong>Azure Resource Manager API</strong> to do the VMs operations. But this communication with the API will need security credentials like a Token. So, we need to add another library that can help the <strong>VmManager</strong> authenticate to the <strong>Azure API</strong>. This library will be the Azure Identity. So we need to add its dependency to the <code>pom.xml</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;dependency&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>com.azure<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>azure-identity<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>1.2.3<span class=nt>&lt;/version&gt;</span>
<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Good üòÅ This Identity library will help the application access the API using some credentials that I need to provide to the application, like a Login and Password. But this is an application, not a human. This is why I will create an <strong>Azure Service Principal</strong> that will identify and authenticate our application to access the <strong>Azure Resources</strong>. Based on the Microsoft Docs:</p>
<blockquote>
<p>An Azure service principal is an identity created for use with applications, hosted services, and automated tools to access Azure resources. This access is restricted by the roles assigned to the service principal, giving you control over which resources can be accessed and at which level. For security reasons, it&rsquo;s always recommended to use service principals with automated tools rather than allowing them to log in with a user identity.</p>
</blockquote>
<p>First of all, you need to be authenticated to <strong>Azure CLI</strong>¬†using the <code>az login</code> command. Then, to create the <strong>Service Principal</strong>, just do:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ az ad sp create-for-rbac --name QuarkusServicePrincipal
</code></pre></td></tr></table>
</div>
</div><p>The command output will look like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;appId&#34;</span><span class=p>:</span> <span class=s2>&#34;856f5c37-a639-4e1e-b294-e6391c396698&#34;</span><span class=p>,</span>
  <span class=nt>&#34;displayName&#34;</span><span class=p>:</span> <span class=s2>&#34;QuarkusServicePrincipal&#34;</span><span class=p>,</span>
  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;http://QuarkusServicePrincipal&#34;</span><span class=p>,</span>
  <span class=nt>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;M6_6OF4q9t-kNrKISZG-0p0qv-FnZ8EdM~&#34;</span><span class=p>,</span>
  <span class=nt>&#34;tenant&#34;</span><span class=p>:</span> <span class=s2>&#34;2cf6bd3b-ef71-47c4-9d5d-06abe42bb3a6&#34;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Our application will use these credentials to authenticate against the <strong>Azure API</strong>:</p>
<ul>
<li>The <code>appId</code> is the <strong>Client ID</strong> üëâÔ∏è needs to be defined in the <strong>Environment Variables</strong> as <code>AZURE_CLIENT_ID</code></li>
<li>The <code>password</code> is the <strong>Client Secret</strong> üëâÔ∏è needs to be defined in the <strong>Environment Variables</strong> as <code>AZURE_CLIENT_SECRET</code></li>
<li>The <code>tenant</code> üëâÔ∏è needs to be defined in the <strong>Environment Variables</strong> as <code>AZURE_TENANT_ID</code></li>
</ul>
<p>These credentials need to be defined in the <strong>Environment Variables</strong>, as our <strong>Azure Identity</strong> components will seek these values from the <strong>Environment</strong>. This design is better than inserting the credentials directly in the source code or in the properties files.</p>
<p>To create an <strong>AzureResourceManager</strong> instance using these credentials, just use this snippet:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>AzureProfile</span> <span class=n>profile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AzureProfile</span><span class=o>(</span><span class=n>AzureEnvironment</span><span class=o>.</span><span class=na>AZURE</span><span class=o>);</span>
<span class=n>TokenCredential</span> <span class=n>credential</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultAzureCredentialBuilder</span><span class=o>()</span>
        <span class=o>.</span><span class=na>authorityHost</span><span class=o>(</span><span class=n>profile</span><span class=o>.</span><span class=na>getEnvironment</span><span class=o>().</span><span class=na>getActiveDirectoryEndpoint</span><span class=o>())</span>
        <span class=o>.</span><span class=na>build</span><span class=o>();</span>

<span class=n>AzureResourceManager</span> <span class=n>azureResourceManager</span> <span class=o>=</span> <span class=n>AzureResourceManager</span>
        <span class=o>.</span><span class=na>authenticate</span><span class=o>(</span><span class=n>credential</span><span class=o>,</span> <span class=n>profile</span><span class=o>)</span>
        <span class=o>.</span><span class=na>withDefaultSubscription</span><span class=o>();</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we can implement the <code>getAvailableVms()</code> method:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@ApplicationScoped</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AzureVmManager</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>AzureResourceManager</span> <span class=n>azureResourceManager</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>AzureVmManager</span><span class=o>()</span> <span class=o>{</span>

        <span class=n>AzureProfile</span> <span class=n>profile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AzureProfile</span><span class=o>(</span><span class=n>AzureEnvironment</span><span class=o>.</span><span class=na>AZURE</span><span class=o>);</span>
        <span class=n>TokenCredential</span> <span class=n>credential</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultAzureCredentialBuilder</span><span class=o>()</span>
                <span class=o>.</span><span class=na>authorityHost</span><span class=o>(</span><span class=n>profile</span><span class=o>.</span><span class=na>getEnvironment</span><span class=o>().</span><span class=na>getActiveDirectoryEndpoint</span><span class=o>())</span>
                <span class=o>.</span><span class=na>build</span><span class=o>();</span>

        <span class=n>azureResourceManager</span> <span class=o>=</span> <span class=n>AzureResourceManager</span>
                <span class=o>.</span><span class=na>authenticate</span><span class=o>(</span><span class=n>credential</span><span class=o>,</span> <span class=n>profile</span><span class=o>)</span>
                <span class=o>.</span><span class=na>withDefaultSubscription</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>VmDTO</span><span class=o>&gt;</span> <span class=nf>getAvailableVMs</span><span class=o>()</span> <span class=o>{</span>

        <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>rgList</span> <span class=o>=</span> <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>resourceGroups</span><span class=o>()</span>
                <span class=o>.</span><span class=na>list</span><span class=o>()</span>
                <span class=o>.</span><span class=na>stream</span><span class=o>()</span>
                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>HasName</span><span class=o>::</span><span class=n>name</span><span class=o>)</span>
                <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>

        <span class=n>List</span><span class=o>&lt;</span><span class=n>VmDTO</span><span class=o>&gt;</span> <span class=n>vmList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>

        <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>resourceGroup</span> <span class=o>:</span> <span class=n>rgList</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>virtualMachines</span><span class=o>()</span>
                    <span class=o>.</span><span class=na>listByResourceGroup</span><span class=o>(</span><span class=n>resourceGroup</span><span class=o>)</span>
                    <span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>vm</span> <span class=o>-&gt;</span> <span class=n>vmList</span><span class=o>.</span><span class=na>add</span><span class=o>(</span>
                            <span class=k>new</span> <span class=n>VmDTO</span><span class=o>(</span>
                                    <span class=n>vm</span><span class=o>.</span><span class=na>name</span><span class=o>(),</span>
                                    <span class=n>vm</span><span class=o>.</span><span class=na>powerState</span><span class=o>().</span><span class=na>toString</span><span class=o>(),</span>
                                    <span class=n>resourceGroup</span>
                            <span class=o>)</span>
                    <span class=o>));</span>
        <span class=o>}</span>

        <span class=k>return</span> <span class=n>vmList</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the <code>getAvailableVms()</code> method, we list the resource groups, and for every resource group, we list its VMs.</p>
<p>Good üòÑ Now let&rsquo;s edit the REST Resource to send the List of VmDTOs:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Path</span><span class=o>(</span><span class=s>&#34;/vms&#34;</span><span class=o>)</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>VMsResource</span> <span class=o>{</span>

    <span class=nd>@Inject</span>
    <span class=n>AzureVmManager</span> <span class=n>azureVmManager</span><span class=o>;</span>

    <span class=nd>@GET</span>
    <span class=nd>@Produces</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
    <span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>VmDTO</span><span class=o>&gt;</span> <span class=nf>getAvailableVMs</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>azureVmManager</span><span class=o>.</span><span class=na>getAvailableVMs</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s test the project now. Just do this Maven command:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ mvn clean install -DskipTests azure-functions:run
</code></pre></td></tr></table>
</div>
</div><p>Then, if you open the <a href=http://localhost:7071/api/vms>http://localhost:7071/api/vms</a> URL, the result will look like:</p>
<p><img loading=lazy src=../images/azure-function-quarkus-list-vms.webp alt="azure-function-quarkus - List VMs">
</p>
<p>Don&rsquo;t be scared if you got an empty array üòÖ Be sure that you already have some VMs in your subscription.</p>
<p>Next, we will implement the Start and Stop VM methods in the AzureVmManager class:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=o>...</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>startVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>virtualMachines</span><span class=o>().</span><span class=na>start</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>stopVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>virtualMachines</span><span class=o>().</span><span class=na>deallocate</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, we need to expose them in the REST API:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@POST</span>
<span class=nd>@Path</span><span class=o>(</span><span class=s>&#34;/start&#34;</span><span class=o>)</span>
<span class=nd>@Consumes</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>startVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>){</span>
    <span class=n>azureVmManager</span><span class=o>.</span><span class=na>startVM</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>);</span>
<span class=o>}</span>

<span class=nd>@POST</span>
<span class=nd>@Path</span><span class=o>(</span><span class=s>&#34;/stop&#34;</span><span class=o>)</span>
<span class=nd>@Consumes</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>stopVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>){</span>
   <span class=n>azureVmManager</span><span class=o>.</span><span class=na>stopVM</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Excellent! ü•≥ Now we will add the scenario of storing the start/stop events to the <strong>Azure Cosmos DB</strong>.</p>
<p>But before, we need to create the Event model class:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Data</span>
<span class=nd>@AllArgsConstructor</span>
<span class=nd>@NoArgsConstructor</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>VmEvent</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=n>VmEventType</span> <span class=n>type</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>id</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>String</span> <span class=n>resourceGroup</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>Date</span> <span class=n>date</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>VmEvent</span><span class=o>(</span><span class=n>VmEventType</span> <span class=n>type</span><span class=o>,</span> <span class=n>String</span> <span class=n>name</span><span class=o>,</span> <span class=n>String</span> <span class=n>resourceGroup</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>type</span> <span class=o>=</span> <span class=n>type</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>name</span> <span class=o>=</span> <span class=n>name</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>resourceGroup</span> <span class=o>=</span> <span class=n>resourceGroup</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>id</span> <span class=o>=</span> <span class=n>UUID</span><span class=o>.</span><span class=na>randomUUID</span><span class=o>().</span><span class=na>toString</span><span class=o>();</span>
        <span class=k>this</span><span class=o>.</span><span class=na>date</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>

<span class=kd>enum</span> <span class=n>VmEventType</span> <span class=o>{</span>
    <span class=n>START</span><span class=o>,</span>
    <span class=n>STOP</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s play with CosmosDB now! ü§©</p>
<h2 id=adding-azure-cosmosdb-to-the-game>Adding Azure CosmosDB to the Game<a hidden class=anchor aria-hidden=true href=#adding-azure-cosmosdb-to-the-game>#</a></h2>
<p>The first step is to create:</p>
<ul>
<li>a <strong>new CosmosDB account</strong> if you don&rsquo;t have one already</li>
<li>a <strong>new CosmosDB database</strong> and name it <code>events-db</code></li>
<li>a <strong>new CosmosDB container</strong> and name it <code>events</code> with <code>/name</code> as <strong>Partition key</strong></li>
</ul>
<p>Then keep aside the <strong>Connection String</strong> as our application will use it in order to access the <strong>Cosmos DB</strong>.</p>
<p>If you didn&rsquo;t that before, you can find a <a href=https://blog.nebrass.fr/playing-with-java-in-azure-functions-new-release/>guided tutorial about Azure Cosmos DB here</a>.</p>
<p>The <strong>Connection String</strong> needs to be added to the <code>local.settings.json</code> file, under the &ldquo;<code>CosmosDbConnection</code>&rdquo; entry.</p>
<p>Now, we will need to add the <strong>CosmosDB Client</strong> to the <strong>AzureVmManager</strong> class. But, before that, we need to have a method that can be parsing the <strong>Connection String</strong> to extract the required credentials which are needed for authenticating the <strong>Cosmos DB Client</strong>.</p>
<p>The <strong>Connection String</strong> has the format: <code>AccountEndpoint=https://xxxxxxxx.documents.azure.com:443/;AccountKey=RpiUBg4mK0xBIKqPRpiUBg4mK0xBIKqP==;</code></p>
<p>To parse it, I will split the <strong>AccountEndpoint</strong> and <strong>AccountKey</strong> parts using the <code>;</code> sign, and then I will split the <strong>KEY=VALUE</strong> expression using the <code>=</code> sign. Then I will be storing these credentials in a Map.</p>
<p>My <code>getCosmosDbCredentials()</code> method looks like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=nf>getCosmosDbCredentials</span><span class=o>()</span> <span class=o>{</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>credentials</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>

    <span class=n>String</span> <span class=n>cosmosDbConnection</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>getenv</span><span class=o>(</span><span class=s>&#34;CosmosDbConnection&#34;</span><span class=o>);</span>
    <span class=n>String</span><span class=o>[]</span> <span class=n>elements</span> <span class=o>=</span> <span class=n>cosmosDbConnection</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;;&#34;</span><span class=o>);</span>

    <span class=k>for</span> <span class=o>(</span><span class=n>String</span> <span class=n>element</span> <span class=o>:</span> <span class=n>elements</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>String</span><span class=o>[]</span> <span class=n>split</span> <span class=o>=</span> <span class=n>element</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=s>&#34;=&#34;</span><span class=o>);</span>
        <span class=n>credentials</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>split</span><span class=o>[</span><span class=n>0</span><span class=o>],</span> <span class=n>split</span><span class=o>[</span><span class=n>1</span><span class=o>]);</span>
    <span class=o>}</span>

    <span class=k>return</span> <span class=n>credentials</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>System.getenv("CosmosDbConnection")</code> instruction will grab the <code>CosmosDbConnection</code> from the <strong>System Environment Variables</strong>. This is will work, as we added the &ldquo;<code>CosmosDbConnection</code>&rdquo; entry to the <code>local.settings.json</code>, then, <strong>Azure Function Runtime</strong> will make this entry available as an <strong>Environment Variable</strong>.</p>
<p>Excellent! Now, if to instantiate the CosmosClient we will do:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>AzureResourceManager</span> <span class=n>azureResourceManager</span> <span class=o>=</span> <span class=n>AzureResourceManager</span>
        <span class=o>.</span><span class=na>authenticate</span><span class=o>(</span><span class=n>credential</span><span class=o>,</span> <span class=n>profile</span><span class=o>)</span>
        <span class=o>.</span><span class=na>withDefaultSubscription</span><span class=o>();</span>

<span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>credentials</span> <span class=o>=</span> <span class=n>getCosmosDbCredentials</span><span class=o>();</span>

<span class=n>CosmosClient</span> <span class=n>cosmosClient</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CosmosClientBuilder</span><span class=o>()</span>
        <span class=o>.</span><span class=na>endpoint</span><span class=o>(</span><span class=n>credentials</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;AccountEndpoint&#34;</span><span class=o>))</span>
        <span class=o>.</span><span class=na>key</span><span class=o>(</span><span class=n>credentials</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;AccountKey&#34;</span><span class=o>))</span>
        <span class=o>.</span><span class=na>buildClient</span><span class=o>();</span>

<span class=n>cosmosContainer</span> <span class=o>=</span> <span class=n>cosmosClient</span>
        <span class=o>.</span><span class=na>getDatabase</span><span class=o>(</span><span class=s>&#34;events-db&#34;</span><span class=o>)</span>
        <span class=o>.</span><span class=na>getContainer</span><span class=o>(</span><span class=s>&#34;events&#34;</span><span class=o>);</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, we will use the <code>cosmosContainer</code> to do the CRUD operations in the <strong>Azure Cosmos DB</strong>. To insert a <code>VmEvent</code> into <strong>CosmosDB</strong>, we create the method <code>sendData()</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>sendData</span><span class=o>(</span><span class=n>VmEvent</span> <span class=n>vmEvent</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>cosmosContainer</span><span class=o>.</span><span class=na>createItem</span><span class=o>(</span><span class=n>vmEvent</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>We will include this method into the start/stop VM methods:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>startVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>virtualMachines</span><span class=o>().</span><span class=na>start</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
    <span class=n>sendData</span><span class=o>(</span>
            <span class=k>new</span> <span class=n>VmEvent</span><span class=o>(</span><span class=n>VmEventType</span><span class=o>.</span><span class=na>START</span><span class=o>,</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>())</span>
    <span class=o>);</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>stopVM</span><span class=o>(</span><span class=n>VmDTO</span> <span class=n>vmDTO</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>azureResourceManager</span><span class=o>.</span><span class=na>virtualMachines</span><span class=o>().</span><span class=na>deallocate</span><span class=o>(</span><span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>());</span>
    <span class=n>sendData</span><span class=o>(</span>
            <span class=k>new</span> <span class=n>VmEvent</span><span class=o>(</span><span class=n>VmEventType</span><span class=o>.</span><span class=na>STOP</span><span class=o>,</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getName</span><span class=o>(),</span> <span class=n>vmDTO</span><span class=o>.</span><span class=na>getResourceGroup</span><span class=o>())</span>
    <span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, we will create a method that grabs the stored events - in the <code>AzureVmManager</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>VmEvent</span><span class=o>&gt;</span> <span class=nf>getLogs</span><span class=o>()</span> <span class=o>{</span>
    <span class=n>String</span> <span class=n>SELECT_ALL_LOGS_QUERY</span> <span class=o>=</span> <span class=s>&#34;SELECT * FROM c&#34;</span><span class=o>;</span>
    
    <span class=k>return</span> <span class=n>cosmosContainer</span>
            <span class=o>.</span><span class=na>queryItems</span><span class=o>(</span><span class=n>SELECT_ALL_LOGS_QUERY</span><span class=o>,</span> <span class=k>new</span> <span class=n>CosmosQueryRequestOptions</span><span class=o>(),</span> <span class=n>VmEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
            <span class=o>.</span><span class=na>stream</span><span class=o>()</span>
            <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toList</span><span class=o>());</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Next, we will expose the <code>getLogs()</code> in the <strong>REST Resource</strong>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@GET</span>
<span class=nd>@Path</span><span class=o>(</span><span class=s>&#34;/logs&#34;</span><span class=o>)</span>
<span class=nd>@Produces</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>VmEvent</span><span class=o>&gt;</span> <span class=nf>logs</span><span class=o>(){</span>
    <span class=k>return</span> <span class=n>azureVmManager</span><span class=o>.</span><span class=na>getLogs</span><span class=o>();</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Excellent! Now, let&rsquo;s run this function locally using the command:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ mvn clean install -DskipTests azure-functions:run
</code></pre></td></tr></table>
</div>
</div><p>After the application starts, we will use the list available VMs API, then we will choose a VM, and will start or stop many times, then we will check the get Logs API in order to get the events.</p>
<p>‚ÑπÔ∏è I will use the <a href=https://httpie.io/>HTTPie</a> as a REST CLI</p>
<p>Get the VMs:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>http http://localhost:7071/api/vms
</span><span class=err>
</span><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>265</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 02 Mar 2021 16:53:15 GMT</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>Kestrel</span>

<span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;PowerState/deallocated&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;wordpress-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;blog-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;PowerState/running&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;agent-builder&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkus-book-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;PowerState/deallocated&#34;</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table>
</div>
</div><p>Start the <code>quarkus-vm</code> machine:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>echo &#39;{ &#34;name&#34;: &#34;quarkushop-vm&#34;, &#34;resourceGroup&#34;: &#34;quarkushop-rg&#34; }&#39; \
</span><span class=err> | http POST http://localhost:7071/api/vms/start --timeout=300
</span><span class=err>
</span><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>204</span> <span class=ne>No Content</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>0</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 02 Mar 2021 16:47:53 GMT</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>Kestrel</span>
</code></pre></td></tr></table>
</div>
</div><p>Stop it:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>echo &#39;{ &#34;name&#34;: &#34;quarkushop-vm&#34;, &#34;resourceGroup&#34;: &#34;quarkushop-rg&#34; }&#39; \
</span><span class=err> | http POST http://localhost:7071/api/vms/stop --timeout=300
</span><span class=err>
</span><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>204</span> <span class=ne>No Content</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>0</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 02 Mar 2021 16:48:51 GMT</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>Kestrel</span>
</code></pre></td></tr></table>
</div>
</div><p>‚ö†Ô∏è Be sure to have the <code>--timeout=300</code> in the <strong>HTTPie</strong> command, because the REST call can take more than 30 seconds, which is the default <strong>HTTPie</strong> timeout.</p>
<p>Then we will get the Logs:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>http http://localhost:7071/api/vms/logs
</span><span class=err>
</span><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>1366</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 02 Mar 2021 16:59:12 GMT</span>
<span class=n>Server</span><span class=o>:</span> <span class=l>Kestrel</span>

<span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703368791</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;f33e9ed4-086d-4ccf-88d5-f4f4f32ba74e&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;START&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703445766</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;bb03fb09-e07a-4182-8429-baa48cf43b35&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STOP&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703604793</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;ce8c06fe-d00b-47ba-a0e3-38670fc2878e&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;START&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703674713</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;a14f24e8-2b23-4f61-bb6c-c9154d839410&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STOP&#34;</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table>
</div>
</div><p>Excellent, this data can be then used in your monitoring dashboards or monitoring services. Cool! Let&rsquo;s deploy now our <strong>Azure Function Application</strong> üòÅ</p>
<h2 id=deploying-the-quarkus-azure-function>Deploying the Quarkus Azure Function<a hidden class=anchor aria-hidden=true href=#deploying-the-quarkus-azure-function>#</a></h2>
<p>As usual, it&rsquo;s a very easy task: only one <strong>Maven Task</strong> will do the job ü§© Just be sure that the Azure CLI is authenticated:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ mvn clean install -DskipTests azure-functions:deploy
</code></pre></td></tr></table>
</div>
</div><p>The process will take some time, then you will get an output that looks like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>....
<span class=o>[</span>INFO<span class=o>]</span> Syncing triggers and fetching <span class=k>function</span> information <span class=o>(</span>Attempt 1/3<span class=o>)</span>...
<span class=o>[</span>INFO<span class=o>]</span> HTTP Trigger Urls:
<span class=o>[</span>INFO<span class=o>]</span> 	 quarkus-function : https://quarkus-function.azurewebsites.net/api/<span class=o>{</span>*path<span class=o>}</span>
<span class=o>[</span>INFO<span class=o>]</span> ------------------------------------------------------------------------
<span class=o>[</span>INFO<span class=o>]</span> BUILD SUCCESS
<span class=o>[</span>INFO<span class=o>]</span> ------------------------------------------------------------------------
<span class=o>[</span>INFO<span class=o>]</span> Total time:  01:59 min
<span class=o>[</span>INFO<span class=o>]</span> Finished at: 2021-03-02T18:12:39+01:00
<span class=o>[</span>INFO<span class=o>]</span> ------------------------------------------------------------------------
</code></pre></td></tr></table>
</div>
</div><p>In theory, the application will work now üòÜ but it&rsquo;s not the case, yet!</p>
<p>We need to provide the <code>AZURE_CLIENT_ID</code>, <code>AZURE_CLIENT_SECRET</code>, <code>AZURE_TENANT_ID</code> along with the <code>CosmosDbConnection</code> to the <strong>Function Environment</strong>. To do that, just go to the <strong>Azure portal</strong> and then go to the <strong>Function App</strong> menu.¬† Then go to the Configuration menu in order to access the <strong>Function Environment Variables</strong>, here where you need to add the required items:</p>
<p><img loading=lazy src=../images/azure-quarkus-function-portal-configuration.webp alt="Azure Function Configuration screen">
</p>
<p>Excellent! Now, our Quarkus Function is ready for receiving our requests, let&rsquo;s test it:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=err>http https://quarkus-function.azurewebsites.net/api/vms/logs
</span><span class=err>
</span><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
<span class=n>Content-Encoding</span><span class=o>:</span> <span class=l>gzip</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
<span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 02 Mar 2021 17:25:27 GMT</span>
<span class=n>Request-Context</span><span class=o>:</span> <span class=l>appId=cid-v1:a3251f24-8fcf-429f-8f94-07eae258f122</span>
<span class=n>Transfer-Encoding</span><span class=o>:</span> <span class=l>chunked</span>
<span class=n>Vary</span><span class=o>:</span> <span class=l>Accept-Encoding</span>

<span class=p>[</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703368791</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;f33e9ed4-086d-4ccf-88d5-f4f4f32ba74e&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;START&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703445766</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;bb03fb09-e07a-4182-8429-baa48cf43b35&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STOP&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703604793</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;ce8c06fe-d00b-47ba-a0e3-38670fc2878e&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;START&#34;</span>
    <span class=p>},</span>
    <span class=p>{</span>
        <span class=nt>&#34;date&#34;</span><span class=p>:</span> <span class=mi>1614703674713</span><span class=p>,</span>
        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;a14f24e8-2b23-4f61-bb6c-c9154d839410&#34;</span><span class=p>,</span>
        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-vm&#34;</span><span class=p>,</span>
        <span class=nt>&#34;resourceGroup&#34;</span><span class=p>:</span> <span class=s2>&#34;quarkushop-rg&#34;</span><span class=p>,</span>
        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STOP&#34;</span>
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table>
</div>
</div><p>Enjoy the game!</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>In this tutorial, we learned how to use the <strong>Quarkus Azure Functions HTTP</strong> library and how to use <strong>Quarkus</strong> to create a powerful <strong>Azure Function</strong> üòÖ</p>
<p>The source code of this application is available <a href=https://github.com/nebrass/azure-quarkus-function>here</a>.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on twitter" href="https://twitter.com/intent/tweet/?text=Playing%20with%20Azure%20Functions%20and%20Quarkus&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f&title=Playing%20with%20Azure%20Functions%20and%20Quarkus&summary=Playing%20with%20Azure%20Functions%20and%20Quarkus&source=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f&title=Playing%20with%20Azure%20Functions%20and%20Quarkus"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on whatsapp" href="https://api.whatsapp.com/send?text=Playing%20with%20Azure%20Functions%20and%20Quarkus%20-%20https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Playing with Azure Functions and Quarkus on telegram" href="https://telegram.me/share/url?text=Playing%20with%20Azure%20Functions%20and%20Quarkus&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-azure-functions-and-quarkus%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://blog.nebrass.fr>Nebrass Homepage</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
</body>
</html>