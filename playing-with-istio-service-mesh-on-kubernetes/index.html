<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Playing with Istio Service Mesh on Kubernetes | Nebrass Homepage</title><meta name=keywords content="istio,kubernetes,service-mesh"><meta name=description content="What is Istio? GoogleÂ presentsÂ IstioÂ as an open platform to connect, monitor, and secure microservices.
IstioÂ is a service mesh implementation that provides many cloud-native capabilities like:
 Traffic management: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦ Observability: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦ Security: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦  IstioÂ delivers all these great features without any changes to the code of the microservices running with it on the sameÂ KubernetesÂ cluster."><meta name=author content><link rel=canonical href=https://blog.nebrass.fr/playing-with-istio-service-mesh-on-kubernetes/><link crossorigin=anonymous href=/assets/css/stylesheet.min.9aeab43847eb11aca320bfadedfe191ed6516dd768bf1314b534c4992aac901a.css integrity="sha256-muq0OEfrEayjIL+t7f4ZHtZRbddovxMUtTTEmSqskBo=" rel="preload stylesheet" as=style><script src=/js/prism.min.js></script>
<link rel=stylesheet href=/css/prism.min.css><link rel=icon href=https://blog.nebrass.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.nebrass.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.nebrass.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.nebrass.fr/apple-touch-icon.png><link rel=mask-icon href=https://blog.nebrass.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style amp-custom>.main,.footer,.nav{max-width:calc(var(--main-width) + var(--gap) * 15)}</style><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-111781986-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Playing with Istio Service Mesh on Kubernetes"><meta property="og:description" content="What is Istio? GoogleÂ presentsÂ IstioÂ as an open platform to connect, monitor, and secure microservices.
IstioÂ is a service mesh implementation that provides many cloud-native capabilities like:
 Traffic management: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦ Observability: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦ Security: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦  IstioÂ delivers all these great features without any changes to the code of the microservices running with it on the sameÂ KubernetesÂ cluster."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.nebrass.fr/playing-with-istio-service-mesh-on-kubernetes/"><meta property="og:image" content="https://blog.nebrass.fr/images/My-Post-7.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-10T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-10T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.nebrass.fr/images/My-Post-7.webp"><meta name=twitter:title content="Playing with Istio Service Mesh on Kubernetes"><meta name=twitter:description content="What is Istio? GoogleÂ presentsÂ IstioÂ as an open platform to connect, monitor, and secure microservices.
IstioÂ is a service mesh implementation that provides many cloud-native capabilities like:
 Traffic management: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦ Observability: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦ Security: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦  IstioÂ delivers all these great features without any changes to the code of the microservices running with it on the sameÂ KubernetesÂ cluster."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.nebrass.fr/posts/"},{"@type":"ListItem","position":3,"name":"Playing with Istio Service Mesh on Kubernetes","item":"https://blog.nebrass.fr/playing-with-istio-service-mesh-on-kubernetes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Playing with Istio Service Mesh on Kubernetes","name":"Playing with Istio Service Mesh on Kubernetes","description":"What is Istio? GoogleÂ presentsÂ IstioÂ as an open platform to connect, monitor, and secure microservices.\nIstioÂ is a service mesh implementation that provides many cloud-native capabilities like:\n Traffic management: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦ Observability: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦ Security: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦  IstioÂ delivers all these great features without any changes to the code of the microservices running with it on the sameÂ KubernetesÂ cluster.","keywords":["istio","kubernetes","service-mesh"],"articleBody":"What is Istio? GoogleÂ presentsÂ IstioÂ as an open platform to connect, monitor, and secure microservices.\nIstioÂ is a service mesh implementation that provides many cloud-native capabilities like:\n Traffic management: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦ Observability: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦ Security: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦  IstioÂ delivers all these great features without any changes to the code of the microservices running with it on the sameÂ KubernetesÂ cluster.\nIn our case, we already implemented many of these features and capabilities when we were writing our microservices. If we hadÂ IstioÂ at the beginning, we could save so much effort and time, by delegating all of these capabilities toÂ Istio.\nIstio Architecture IstioÂ service mesh is composed of two parts:\n TheÂ data planeÂ is responsible for establishing, securing, and controlling the traffic through the Service Mesh. The management components that instruct the data plane how to behave is known as the â€œcontrol planeâ€. TheÂ control planeÂ is the brains of the mesh and exposes an API for operators to manipulate the network behaviors.   Istio Components From theÂ Istio ArchitectureÂ diagram, we can see different components, located in different areas of the ecosystem:\nEnvoy Sidecar proxies per microservice to handle ingress/egress traffic between services in the cluster and from a service to external services. The proxies form aÂ secure microservice meshÂ providing a rich set of functions like discovery, rich layer-7 routing, circuit breakers, policy enforcement and telemetry recording/reporting functions.\n The service mesh is not an overlay network. It simplifies and enhances how microservices in an application talk to each other over the network provided by the underlying platform.\n Envoy is deployed as a sidecar to the relevant microservice in the same Kubernetes pod. This deployment allows Istio to extract a wealth of signals about traffic behavior as attributes. Istio can, in turn, use these attributes in Mixer to enforce policy decisions, and send them to monitoring systems to provide information about the behavior of the entire mesh.\nMixer Mixer is a central component that is leveraged by the proxies and microservices to enforce policies such as authorization, rate limits, quotas, authentication, request tracing and telemetry collection.\nMixer includes a flexible plugin model. This model enables Istio to interface with a variety of host environments and infrastructure backends. Thus, Istio abstracts the Envoy proxy and Istio-managed services from these details.\nPilot Pilot provides service discovery for the Envoy sidecars, traffic management capabilities for intelligent routing (e.g., A/B tests, canary deployments, etc.), and resiliency (timeouts, retries, circuit breakers, etc.).\nPilot converts high level routing rules that control traffic behavior into Envoy-specific configurations, and propagates them to the sidecars at runtime. Pilot abstracts platform-specific service discovery mechanisms and synthesizes them into a standard format that any sidecar conforming with the Envoy data plane APIs can consume. This loose coupling allows Istio to run on multiple environments such as Kubernetes, Consul, or Nomad, while maintaining the same operator interface for traffic management.\nCitadel Citadel provides strong service-to-service and end-user authentication with built-in identity and credential management. You can use Citadel to upgrade unencrypted traffic in the service mesh. Using Citadel, operators can enforce policies based on service identity rather than on network controls. Starting from release 0.5, you can use Istioâ€™s authorization feature to control who can access your services.\nGalley Galley validates user authored Istio API configuration on behalf of the other Istio control plane components. Over time, Galley will take over responsibility as the top-level configuration ingestion, processing and distribution component of Istio. It will be responsible for insulating the rest of the Istio components from the details of obtaining user configuration from the underlying platform (e.g. Kubernetes).\nGetting started with Istio Requirements We will be playing withÂ IstioÂ onÂ Kubernetes. For testing the solution, you need to have, as usual, a runningÂ MinikubeÂ on your machine.\nThe example of this chapter will be running onÂ MinikubeÂ v0.35.0Â with a custom config:Â 4 CPUs with 8Go of Memory.\nGet \u0026 Install Istio To start downloading and installing Istio, just enter the following command:\n1  $ curl -L https://git.io/getLatestIstio | sh -   By the end of the command execution, you will see some message like this one:\n1 2 3  Add /Users/n.lamouchi/istio-1.0.6/bin to your path; e.g copy paste in your shell and/or ~/.profile: $ export PATH=\"$PATH:/Users/n.lamouchi/istio-1.0.6/bin\"   Next, we will move to Istio package directory:\n1  $ cd istio-1.0.6/   As the first step, you have to install Istioâ€™s Custom Resources Definition:\n1  $ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml    What is Custom Resources Definition ?\nCustom resources definition (CRD) is a powerful feature introduced in KubernetesÂ 1.7 which enables users to add their own/custom objects to theÂ KubernetesÂ cluster and use it like any other nativeÂ Kubernetes objects.\n Next, we need to install Istioâ€™s core components. We have four different options to do this:\n Option 1: Install Istio WITHOUT mutual TLS authentication between sidecars Option 2: Install Istio WITH default mutual TLS authentication Option 3: Render Kubernetes manifest with Helm and deploy with kubectl Option 4: Use Helm and Tiller to manage the Istio deployment   For a production setup of Istio, itâ€™s recommended to install with the Helm Chart (Option 4), to use all the configuration options. This permits customization of Istio to operator specific requirements.\n In this tutorial, we will be using theÂ Option 1:\nTo install Istio:\n1  $ kubectl apply -f install/kubernetes/istio-demo.yaml   Verifying the installation\nTo be sure that the Istio components were correctly installed, these Kubernetes Services needs to be installed:Â istio-pilot,Â istio-ingressgateway,Â istio-policy,Â istio-telemetry,Â prometheus,Â istio-galley, and (optionally)Â istio-sidecar-injector:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  $ kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.102.186.225  3000/TCP 35m istio-citadel ClusterIP 10.108.239.218  8060/TCP,9093/TCP 58m istio-egressgateway ClusterIP 10.103.151.29  80/TCP,443/TCP 58m istio-galley ClusterIP 10.96.55.14  443/TCP,9093/TCP 58m istio-ingressgateway LoadBalancer 10.110.91.248  80:31380/TCP.. 58m istio-pilot ClusterIP 10.104.95.143  15010/TCP.. 58m istio-policy ClusterIP 10.100.19.140  9091/TCP.. 58m istio-sidecar-injector ClusterIP 10.101.13.203  443/TCP 58m istio-telemetry ClusterIP 10.103.135.98  9091/TCP.. 58m jaeger-agent ClusterIP None  5775/UDP.. 35m jaeger-collector ClusterIP 10.110.82.2  14267/TCP,14268/TCP 35m jaeger-query ClusterIP 10.101.54.162  16686/TCP 35m prometheus ClusterIP 10.101.210.170  9090/TCP 58m servicegraph ClusterIP 10.99.60.12  8088/TCP 35m tracing ClusterIP 10.98.62.125  80/TCP 35m zipkin ClusterIP 10.100.54.120  9411/TCP 35m   For the KubernetesÂ ServicesÂ already listed, we will find correspondingÂ Pods:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  $ kubectl get svc -n istio-system NAME READY STATUS RESTARTS AGE grafana-59b8896965-n4rvr 1/1 Running 0 91m istio-citadel-6f444d9999-xc27q 1/1 Running 0 91m istio-cleanup-secrets-k2dzg 0/1 Completed 0 91m istio-egressgateway-6d79447874-8twkk 1/1 Running 0 91m istio-galley-685bb48846-tht5x 1/1 Running 0 91m istio-grafana-post-install-rmflr 0/1 Completed 0 91m istio-ingressgateway-5b64fffc9f-56tm2 1/1 Running 0 91m istio-pilot-7f558fc848-2fscl 2/2 Running 0 91m istio-policy-547d64b8d7-skpzm 2/2 Running 0 91m istio-security-post-install-nlfmd 0/1 Completed 0 91m istio-sidecar-injector-5d8dd9448d-rdbq8 1/1 Running 0 91m istio-telemetry-c5488fc49-b8sv8 2/2 Running 0 91m istio-tracing-6b994895fd-6wxvx 1/1 Running 0 91m prometheus-76b7745b64-2tgkw 1/1 Running 0 91m servicegraph-cb9b94c-2x5cb 1/1 Running 1 91m   AllÂ PodsÂ need to be in theÂ RunningÂ status, except theÂ istio-cleanup-secrets-*,Â istio-grafana-post-install-*Â andÂ istio-security-post-install-*Â Pods, which will be in theÂ CompletedÂ status. These threeÂ CompletedÂ PodsÂ are started and executed at a post-installation phase, to do post-installation tasks like cleaning the installation secrets, etcâ€¦\nEnvoy Sidecar Injection In the service mesh world, a sidecar is a utility container in the pod, and its purpose is to support the main container. In the Istio case, the sidecar will be an Envoy proxy that will be deployed to each pod. The process of adding Envoy into a pod is calledÂ Sidecar Injection. This action can be done in two ways:\n Automatically using the Istio Sidecar Injector : Automatic injection injects at pod creation time. The controller resource is unmodified. Sidecars can be updated selectively by manually deleting a pods or systematically with a deployment rolling update. Manually using theÂ Istioctl-CLIÂ tool: Manual injection modifies the controller configuration, e.g. deployment. It does this by modifying the pod template spec such that all pods for that deployment are created with the injected sidecar. Adding, Updating or Removing the sidecar requires modifying the entire deployment.  Automatic Sidecar Injection To enable theÂ Automatic Sidecar InjectÂ just add theÂ istio-injectionÂ label to the Kubernetes namespace: For example to enable it in theÂ defaultÂ namespace:\n1  $ kubectl label namespace default istio-injection=enabled --overwrite   Now, when a pod will be created, the Envoy sidecar is automatically injected inside it.\nManual Sidecar Injection Inject the sidecar into the deployment using the in-cluster configuration. \n1 2 3 4  $ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml \\  --output bookinfo-injected.yaml $ kubectl apply -f bookinfo-injected.yaml    BookInfo Sample Application\nThis example deploys a sample application composed of four separate microservices used to demonstrate various Istio features. The lication displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a cription of the book, book details (ISBN, number of pages, and so on), and a few book reviews.\nThe Bookinfo application is broken into four separate microservices:\n productpage: The productpage microservice calls the details and reviews microservices to populate the page. details: The details microservice contains book information. reviews: The reviews microservice contains book reviews. It also calls the ratings microservice. ratings: The ratings microservice contains book ranking information that accompanies a book review.  There are 3 versions of the reviews microservice:\n Version v1 doesnâ€™t call the ratings service. Version v2 calls the ratings service, and displays each rating as 1 to 5 black stars. Version v3 calls the ratings service, and displays each rating as 1 to 5 red stars.   These two commands can be done in one command:\n1  $ kubectl create -f (istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)   or also:\n1  $ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml | kubectl apply -f -   These commands will inject the Istio Envoy sidecar into the KubernetesÂ DeploymentÂ object.\nFor the sampleÂ DeploymentÂ of theÂ details-v1Â microservice which looks like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145  apiVersion:extensions/v1beta1kind:Deploymentmetadata:name:details-v1spec:replicas:1template:metadata:labels:app:detailsversion:v1spec:containers:- name:detailsimage:istio/examples-bookinfo-details-v1:1.8.0imagePullPolicy:IfNotPresentports:- containerPort:9080TheÂ _Deployment_Â after the injection of Istio will look like:apiVersion:extensions/v1beta1kind:Deploymentmetadata:creationTimestamp:nullname:details-v1spec:replicas:1strategy:{}template:metadata:annotations:sidecar.istio.io/status:'...'creationTimestamp:nulllabels:app:detailsversion:v1spec:containers:- name:detailsimage:istio/examples-bookinfo-details-v1:1.8.0imagePullPolicy:IfNotPresentports:- containerPort:9080resources:{}- args:- proxy- sidecar- --configPath- /etc/istio/proxy- --binaryPath- /usr/local/bin/envoy- --serviceCluster- details- --drainDuration- 45s- --parentShutdownDuration- 1m0s- --discoveryAddress- istio-pilot.istio-system:15007- --discoveryRefreshDelay- 1s- --zipkinAddress- zipkin.istio-system:9411- --connectTimeout- 10s- --proxyAdminPort- \"15000\"- --controlPlaneAuthPolicy- NONEenv:- name:POD_NAMEvalueFrom:fieldRef:fieldPath:metadata.name- name:POD_NAMESPACEvalueFrom:fieldRef:fieldPath:metadata.namespace- name:INSTANCE_IPvalueFrom:fieldRef:fieldPath:status.podIP- name:ISTIO_META_POD_NAMEvalueFrom:fieldRef:fieldPath:metadata.name- name:ISTIO_META_INTERCEPTION_MODEvalue:REDIRECT- name:ISTIO_METAJSON_LABELSvalue:|{\"app\":\"details\",\"version\":\"v1\"}image:docker.io/istio/proxyv2:1.0.6imagePullPolicy:IfNotPresentname:istio-proxyports:- containerPort:15090name:http-envoy-promprotocol:TCPresources:requests:cpu:10msecurityContext:readOnlyRootFilesystem:truerunAsUser:1337volumeMounts:- mountPath:/etc/istio/proxyname:istio-envoy- mountPath:/etc/certs/name:istio-certsreadOnly:trueinitContainers:- args:- -p- \"15001\"- -u- \"1337\"- -m- REDIRECT- -i- '*'- -x- \"\"- -b- \"9080\"- -d- \"\"image:docker.io/istio/proxy_init:1.0.6imagePullPolicy:IfNotPresentname:istio-initresources:{}securityContext:capabilities:add:- NET_ADMINprivileged:truevolumes:- emptyDir:medium:Memoryname:istio-envoy- name:istio-certssecret:optional:truesecretName:istio.defaultstatus:{}  All the extra paramters and configuration are added viaÂ istioctl kube-injectÂ command.\nAfter executing the command:\n1 2 3 4 5 6 7 8 9 10 11 12  $ kubectl create -f (istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) service/details created deployment.extensions/details-v1 created service/ratings created deployment.extensions/ratings-v1 created service/reviews created deployment.extensions/reviews-v1 created deployment.extensions/reviews-v2 created deployment.extensions/reviews-v3 created service/productpage created deployment.extensions/productpage-v1 created   We can verify that theÂ sidecarÂ is deployed in the sameÂ DeploymentÂ as the microservice, just type:\n1 2 3 4  $ kubectl get deployment details-v1 -o wide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR details-v1 1/1 1 1 63m details,istio-proxy ... ...   We can even see that there are two containers in theÂ details-v1-*Â pod:\n To be sure that everything is ok, we need to verify that theÂ BookInfoÂ services \u0026 pods are here:\n1 2 3 4 5 6 7 8  $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.106.82.61  9080/TCP 4h51m kubernetes ClusterIP 10.96.0.1  443/TCP 11h productpage ClusterIP 10.100.126.93  9080/TCP 4h51m ratings ClusterIP 10.98.201.254  9080/TCP 4h51m reviews ClusterIP 10.110.241.59  9080/TCP 4h51m   And :\n1 2 3 4 5 6 7 8 9  $ kubectl get pod NAME READY STATUS RESTARTS AGE details-v1-55bc45969c-99xj2 2/2 Running 0 4h52m productpage-v1-5b597ff459-pfpmt 2/2 Running 0 4h52m ratings-v1-7877895db5-vchw2 2/2 Running 0 4h52m reviews-v1-699587b49b-bt7z5 2/2 Running 0 4h52m reviews-v2-cc7cd59cc-k6l6j 2/2 Running 0 4h52m reviews-v3-6fbcf56df8-nc2lf 2/2 Running 0 4h52m   Now, we can go on to next steps and enjoy the great Istio features :)\nTraffic Management Istio Gateway \u0026 VirtualService Now that the Bookinfo services are up and running, we need to make the Services accessible from outside of your Kubernetes cluster. AnÂ Istio GatewayÂ object is used for this purpose.\nAnÂ Istio GatewayÂ configures a load balancer forÂ HTTP/TCPÂ traffic at the edge of the service mesh and enablesÂ IngressÂ traffic for an application. Unlike KubernetesÂ Ingress,Â Istio GatewayÂ only configures theÂ L4-L6Â functions (for example, ports to expose, TLS configuration). Users can then use standard Istio rules to controlÂ HTTPÂ requests as well asÂ TCPÂ traffic entering aÂ GatewayÂ by binding aÂ VirtualServiceÂ to it.\nWe can define theÂ Ingress gatewayÂ for theÂ BookinfoÂ application using the sample gateway configuration:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  apiVersion:networking.istio.io/v1alpha3kind:Gatewaymetadata:name:bookinfo-gatewayspec:selector:istio:ingressgateway# use istio default controllerservers:- port:number:80name:httpprotocol:HTTPhosts:- \"*\"  AÂ VirtualServiceÂ defines the rules that control how requests for a service are routed within an Istio service mesh. For example, aÂ VirtualServiceÂ could route requests to different versions of a service or to a completely different service than was requested. Requests can be routed based on the request source and destination,Â HTTPÂ paths and header fields, and weights associated with individual service versions.\nTheÂ VirtualServiceÂ configuration looks like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  apiVersion:networking.istio.io/v1alpha3kind:VirtualServicemetadata:name:bookinfospec:hosts:- \"*\"gateways:- bookinfo-gatewayhttp:- match:- uri:exact:/productpage- uri:exact:/login- uri:exact:/logout- uri:prefix:/api/v1/productsroute:- destination:host:productpageport:number:9080  Letâ€™s create theÂ Istio GatewayÂ and theÂ VirtualService:\n1  $ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml   Confirm the gateway has been created:\n1 2 3 4  $ kubectl get gateway NAME AGE bookinfo-gateway 59m   Letâ€™s export theÂ INGRESS_HOST, theÂ INGRESS_PORTÂ and theÂ GATEWAY_URL:\n1 2 3 4 5 6  $ export INGRESS_HOST=$(minikube ip) $ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway \\  -o jsonpath='{.spec.ports[?(@.name==\"http2\")].nodePort}') $ export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT   To test the Gateway:\n1  $ curl -o /dev/null -s -w \"%{http_code}\\n\" http://$GATEWAY_URL/productpage   You must haveÂ 200Â as response code.\nYou can also point your browser toÂ http://$GATEWAY_URL/productpageÂ to view the Bookinfo web page. If you refresh the page several times, you should see different versions of reviews shown inÂ productpage, presented in a round robin style (red stars, black stars, no stars), since we havenâ€™t yet used Istio to control the version routing.\n If we refresh the web page some times, we will get different versions of theÂ reviewsÂ structure: One version has red stars (the one that we got in the screenshot), an other one that have back stars and a third one without starts. This is due to the availability of three versions of theÂ reviewsÂ microservice deployed in our sampleÂ BookInfoÂ application.\nYou can verify the availability of the three versions of theÂ reviewsÂ microservice:\n1 2 3 4 5 6  $ kubectl get pods -l app=reviews NAME READY STATUS RESTARTS AGE reviews-v1-699587b49b-v44wr 2/2 Running 0 5h31m reviews-v2-cc7cd59cc-rgc86 2/2 Running 0 5h31m reviews-v3-6fbcf56df8-wndtz 2/2 Running 0 5h31m   We got different versions ofÂ reviewsÂ structure while refreshing because Istio, by default, dispatches access to loadbalanced services using aÂ Round RobinÂ scheduling. One of the great features of Istio is to route the traffic to some dedicated version of a service, or even using sliced dispatching of requests.\nIn the next steps, we will see how to route the traffic based on version.\nDestination Rules Before we can use Istio to control theÂ BookinfoÂ version routing, we need to define the available versions of an application, calledÂ subsets. TheseÂ subsetsÂ are defined in an Istio object calledÂ DestinationRule/The choice of version to display can be decided based on criteria (headers, URL, etcâ€¦) defined to each version. We can enjoy this flexibility of criterias to do Blue-green Deployments, A/B Testing, and Canary Releases.\n1 2 3 4 5 6 7 8 9 10  apiVersion:networking.istio.io/v1alpha3kind:DestinationRulemetadata:name:productpagespec:host:productpage subsets:- name:v1 labels:version:v1    The Kubernetes Service name on which we will be routing the traffic TheÂ subsetÂ element name TheÂ subsetÂ element version  We will create the default destination rules for the Bookinfo services, using the sampleÂ destination-rule-all.yaml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62  apiVersion:networking.istio.io/v1alpha3kind:DestinationRulemetadata:name:productpagespec:host:productpagesubsets:- name:v1labels:version:v1---apiVersion:networking.istio.io/v1alpha3kind:DestinationRulemetadata:name:reviewsspec:host:reviewssubsets:- name:v1labels:version:v1- name:v2labels:version:v2- name:v3labels:version:v3---apiVersion:networking.istio.io/v1alpha3kind:DestinationRulemetadata:name:ratingsspec:host:ratingssubsets:- name:v1labels:version:v1- name:v2labels:version:v2- name:v2-mysqllabels:version:v2-mysql- name:v2-mysql-vmlabels:version:v2-mysql-vm---apiVersion:networking.istio.io/v1alpha3kind:DestinationRulemetadata:name:detailsspec:host:detailssubsets:- name:v1labels:version:v1- name:v2labels:version:v2---  Run the following command to create default Destination Rules:\n1  $ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml   Wait a few seconds for the destination rules to propagate.\nYou can verify that the destination rules are correctly created, using the following command:\n1  $ kubectl get destinationrules -o yaml   Now, we will change the default round-robin behavior for traffic routing: we will route all traffic toÂ reviews-v1, using a newÂ VirtualServicesÂ configuration that looks like this:\n1 2 3 4 5 6 7 8 9 10 11 12  apiVersion:networking.istio.io/v1alpha3kind:VirtualServicemetadata:name:reviewsspec:hosts:- reviewshttp:- route:- destination:host:reviewssubset:v1  TheÂ BookInfoÂ sample brings aÂ virtual-service-all-v1.yamlÂ that holds the necessary configuration of the newÂ VirtualServices. To deploy it, just type:\n1  $ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml   You can verify that theÂ reviewÂ VirtualServiceÂ is correctly created, using the following command:\n1  $ kubectl get virtualservices reviews -o yaml   Try now to reload the page multiple times, and note how onlyÂ reviews:v1Â is displayed each time:\n Next, we will change the route configuration so that all traffic from a specific user is routed to a specific service version. In this case, all traffic from a user named Jason will be routed to the serviceÂ reviews:v2.\nNext, we will be routing traffic for a specific user to a specific service version. In our example, we will be routing all the traffic for a user namedÂ jasonÂ to the serviceÂ reviews:v2.\nTheÂ virtual-service-reviews-test-v2.yamlÂ configuration covers this case:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  spec:hosts:- reviewshttp:- match:- headers:end-user:exact:jasonroute:- destination:host:reviewssubset:v2- route:- destination:host:reviewssubset:v1  To deploy it, just type:\n1  $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml   You can verify that theÂ reviewÂ VirtualServiceÂ is correctly created, using the following command:\n1  $ kubectl get virtualservices reviews -o yaml   To test the newÂ VirtualService, just click on theÂ SignÂ button and login usingÂ jasonÂ as username and any value as password. Now, we will seeÂ reviews:v2. If you logout, we will get back theÂ reviews:v1:\n Next, we will see how to gradually migrate traffic from one version of a microservice to another one. In our example, we will send 50% of traffic toÂ reviews:v1Â and 50% toÂ reviews:v3:\n1  $ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml   Letâ€™s verify the content of the newÂ VirtualService:\n1  $ kubectl get virtualservice reviews -o yaml   TheÂ subsetÂ is set toÂ 50%Â of traffic to theÂ v1Â andÂ 50%Â to theÂ v3:\n1 2 3 4 5 6 7 8 9 10 11 12 13  spec:hosts:- reviewshttp:- route:- destination:host:reviewssubset:v1weight:50- destination:host:reviewssubset:v3weight:50  Try now to reload the page multiple times, you will see diverselyÂ reviews:v1Â andÂ reviews:v3.\nObservability Distributed Tracing Hello Jaeger To access theÂ Jaeger Dashboard, establish port forwarding from local portÂ 16686Â to theÂ TracingÂ instance:\n1 2 3  $ kubectl port-forward -n istio-system \\  $(kubectl get pod -n istio-system -l app=jaeger -o jsonpath='{.items[0].metadata.name}') \\  16686:16686   In your browser, go toÂ http://127.0.0.1:16686\nFrom theÂ ServicesÂ menu, selectÂ productpageÂ service.\nScroll to the bottom and click onÂ Find TracesÂ button to see traces:\n If you click on a trace, you should see more details. The page should look something like this:\n When invoking theÂ /productpage, many BookInfo services are called. These services correspond toÂ spansÂ and the page call itself corresponds to theÂ trace.\nAlthough Istio proxies are able to automatically send spans, they need some hints to tie together the entire trace. Applications need to propagate the appropriate HTTP headers so that when the proxies send span information, the spans can be correlated correctly into a single trace.\nTo do this, an application needs to collect and propagate the following headers from the incoming request to any outgoing requests:\n x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context   When you make downstream calls in your applications, make sure to include these headers.\n Trace sampling When using the Bookinfo sample application above, every time you accessÂ /productpageÂ you see a corresponding trace in the Jaeger dashboard. This sampling rate (which is 100% in the BookInfo example) is suitable for a test or low traffic mesh, which is why it is used as the default for the demo installs.\nIn other configurations, Istio defaults to generating trace spans for 1 out of every 100 requests (sampling rate of of 1%).\nYou can control the trace sampling percentage in one of two ways:\nIn a running mesh, edit theÂ istio-pilotÂ deployment and change the environment variable with the following steps:\n To open your text editor with the deployment configuration file loaded, run the following command:  1  $ kubectl -n istio-system edit deploy istio-pilot   Find theÂ PILOT_TRACE_SAMPLINGÂ environment variable, and change the value: to your desired percentage.  In both cases, valid values are from 0.0 to 100.0 with a precision of 0.01.\nGrafana TheÂ GrafanaÂ add-on in Istio is a preconfigured instance ofÂ Grafana. The base image (grafana/grafana:5.0.4) has been modified to start with both aÂ PrometheusÂ data source and theÂ Istio DashboardÂ installed. The base install files forÂ Istio, andÂ MixerÂ in particular, ship with a default configuration of global (used for every service) metrics. TheÂ Istio DashboardÂ is built to be used in conjunction with the default Istio metrics configuration and aÂ PrometheusÂ backend.\nEstablish port forwarding from local port 3000 to theÂ GrafanaÂ instance:\n1 2 3  $ kubectl -n istio-system port-forward \\  $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') \\  3000:3000   Browse toÂ http://localhost:3000Â and navigate to theÂ Istio Mesh Dashboard:\nÂ Prometheus Mixer comes with a built-inÂ PrometheusÂ adapter that exposes an endpoint serving generated metric values. TheÂ PrometheusÂ add-on is aÂ PrometheusÂ server that comes preconfigured to scrape Mixer endpoints to collect the exposed metrics. It provides a mechanism for persistent storage and querying of Istio metrics.\nTo access theÂ Prometheus Dashboard, establish port forwarding from local portÂ 9090Â toÂ Prometheus instance:\n1 2 3  $ kubectl -n istio-system port-forward \\  $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') \\  9090:9090   Browse toÂ http://localhost:9090/graph, and in theÂ â€œExpressionâ€Â input box, enter:Â istio_request_byte_count. ClickÂ Execute:\nÂ Service Graph TheÂ ServiceGraphÂ service provides endpoints for generating and visualizing a graph of services within a mesh. It exposes the following endpoints:\n /force/forcegraph.htmlÂ As explored above, this is an interactiveÂ D3.jsÂ visualization. /dotvizÂ is a staticÂ GraphvizÂ visualization. /dotgraphÂ provides aÂ DOTÂ serialization. /d3graphÂ provides a JSON serialization forÂ D3Â visualization. /graphÂ provides a generic JSON serialization.  To access theÂ Service Graph Dashboard, establish port forwarding from local portÂ 8088Â toÂ Service Graph instance:\n1 2 3  $ kubectl -n istio-system port-forward \\  $(kubectl -n istio-system get pod -l app=servicegraph -o jsonpath='{.items[0].metadata.name}') \\  8088:8088   Browse toÂ http://localhost:8088/dotviz:\nÂ TheÂ ServiceGraphÂ example is built on top ofÂ PrometheusÂ queries and depends on the standard Istio metric configuration.\nConclusion Thatâ€™s all folks! We have been presenting the main concepts and components of Istio Service Mesh. This introducing chapter is just for installation and core concepts of Istio. As we saw in the Traffic Management section, there are infinite scenarios and use cases that you want to cover, like fault injection, controlling Ingress and Egress traffic, circuit breakers, etc..\nWe did not have the opportunity to cover the Security capabilities of Istio, just because it needs so much chapters to be covered. ğŸ˜›\nStay tuned, I will be writing some quickies about more great capabilities of Istio ! ğŸ˜\n","wordCount":"4070","inLanguage":"en","image":"https://blog.nebrass.fr/images/My-Post-7.webp","datePublished":"2019-03-10T00:00:00Z","dateModified":"2019-03-10T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.nebrass.fr/playing-with-istio-service-mesh-on-kubernetes/"},"publisher":{"@type":"Organization","name":"Nebrass Homepage","logo":{"@type":"ImageObject","url":"https://blog.nebrass.fr/favicon.ico"}}}</script></head><body id=top><script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.nebrass.fr accesskey=h title="Nebrass Homepage (Alt + H)">Nebrass Homepage</a>
<span class=logo-switches></span></div><ul id=menu><li><a href=https://blog.nebrass.fr/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.nebrass.fr/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.nebrass.fr/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Playing with Istio Service Mesh on Kubernetes</h1><div class=post-meta><span title="2019-03-10 00:00:00 +0000 UTC">March 10, 2019</span>&nbsp;Â·&nbsp;20 min</div></header><figure class=entry-cover><img loading=lazy src=https://blog.nebrass.fr/images/My-Post-7.webp alt></figure><div class=post-content><h2 id=what-is-istio>What is Istio?<a hidden class=anchor aria-hidden=true href=#what-is-istio>#</a></h2><p><strong>Google</strong>Â presentsÂ <strong>Istio</strong>Â as an open platform to connect, monitor, and secure microservices.</p><p><strong>Istio</strong>Â is a service mesh implementation that provides many cloud-native capabilities like:</p><ul><li><strong>Traffic management</strong>: Service Discovery, Load balancing, Failure recovery, A/B testing, Canary releases, etcâ€¦</li><li><strong>Observability</strong>: Request Tracing, Metrics, Monitoring, Auditing, Logging, etcâ€¦</li><li><strong>Security</strong>: ACLs, Access control, Rate limiting, End-to-end authentication, etcâ€¦</li></ul><p><strong>Istio</strong>Â delivers all these great features without any changes to the code of the microservices running with it on the sameÂ <em>Kubernetes</em>Â cluster.</p><p>In our case, we already implemented many of these features and capabilities when we were writing our microservices. If we hadÂ <strong>Istio</strong>Â at the beginning, we could save so much effort and time, by delegating all of these capabilities toÂ <strong>Istio</strong>.</p><h3 id=istio-architecture>Istio Architecture<a hidden class=anchor aria-hidden=true href=#istio-architecture>#</a></h3><p><strong>Istio</strong>Â service mesh is composed of two parts:</p><ul><li>TheÂ <strong>data plane</strong>Â is responsible for establishing, securing, and controlling the traffic through the Service Mesh. The management components that instruct the data plane how to behave is known as the &ldquo;<strong>control plane</strong>&rdquo;.</li><li>TheÂ <strong>control plane</strong>Â is the brains of the mesh and exposes an API for operators to manipulate the network behaviors.</li></ul><div align=center><p><img loading=lazy src=../images/istio-service-mesh-architecture.webp alt></p></div><h3 id=istio-components>Istio Components<a hidden class=anchor aria-hidden=true href=#istio-components>#</a></h3><p>From theÂ <em>Istio Architecture</em>Â diagram, we can see different components, located in different areas of the ecosystem:</p><h4 id=envoy>Envoy<a hidden class=anchor aria-hidden=true href=#envoy>#</a></h4><p>Sidecar proxies per microservice to handle ingress/egress traffic between services in the cluster and from a service to external services. The proxies form aÂ <em>secure microservice mesh</em>Â providing a rich set of functions like discovery, rich layer-7 routing, circuit breakers, policy enforcement and telemetry recording/reporting functions.</p><blockquote><p>The service mesh is not an overlay network. It simplifies and enhances how microservices in an application talk to each other over the network provided by the underlying platform.</p></blockquote><p>Envoy is deployed as a sidecar to the relevant microservice in the same Kubernetes pod. This deployment allows Istio to extract a wealth of signals about traffic behavior as attributes. Istio can, in turn, use these attributes in Mixer to enforce policy decisions, and send them to monitoring systems to provide information about the behavior of the entire mesh.</p><h4 id=mixer>Mixer<a hidden class=anchor aria-hidden=true href=#mixer>#</a></h4><p>Mixer is a central component that is leveraged by the proxies and microservices to enforce policies such as authorization, rate limits, quotas, authentication, request tracing and telemetry collection.</p><p>Mixer includes a flexible plugin model. This model enables Istio to interface with a variety of host environments and infrastructure backends. Thus, Istio abstracts the Envoy proxy and Istio-managed services from these details.</p><h4 id=pilot>Pilot<a hidden class=anchor aria-hidden=true href=#pilot>#</a></h4><p>Pilot provides service discovery for the Envoy sidecars, traffic management capabilities for intelligent routing (e.g., A/B tests, canary deployments, etc.), and resiliency (timeouts, retries, circuit breakers, etc.).</p><p>Pilot converts high level routing rules that control traffic behavior into Envoy-specific configurations, and propagates them to the sidecars at runtime. Pilot abstracts platform-specific service discovery mechanisms and synthesizes them into a standard format that any sidecar conforming with the Envoy data plane APIs can consume. This loose coupling allows Istio to run on multiple environments such as Kubernetes, Consul, or Nomad, while maintaining the same operator interface for traffic management.</p><h4 id=citadel>Citadel<a hidden class=anchor aria-hidden=true href=#citadel>#</a></h4><p>Citadel provides strong service-to-service and end-user authentication with built-in identity and credential management. You can use Citadel to upgrade unencrypted traffic in the service mesh. Using Citadel, operators can enforce policies based on service identity rather than on network controls. Starting from release 0.5, you can use Istioâ€™s authorization feature to control who can access your services.</p><h4 id=galley>Galley<a hidden class=anchor aria-hidden=true href=#galley>#</a></h4><p>Galley validates user authored Istio API configuration on behalf of the other Istio control plane components. Over time, Galley will take over responsibility as the top-level configuration ingestion, processing and distribution component of Istio. It will be responsible for insulating the rest of the Istio components from the details of obtaining user configuration from the underlying platform (e.g. Kubernetes).</p><h2 id=getting-started-with-istio>Getting started with Istio<a hidden class=anchor aria-hidden=true href=#getting-started-with-istio>#</a></h2><h3 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h3><p>We will be playing withÂ <strong>Istio</strong>Â onÂ <em>Kubernetes</em>. For testing the solution, you need to have, as usual, a runningÂ <strong>Minikube</strong>Â on your machine.</p><p>The example of this chapter will be running onÂ <strong>Minikube</strong>Â <em>v0.35.0</em>Â with a custom config:Â <em>4 CPUs with 8Go of Memory</em>.</p><h3 id=get--install-istio>Get & Install Istio<a hidden class=anchor aria-hidden=true href=#get--install-istio>#</a></h3><p>To start downloading and installing Istio, just enter the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -L https://git.io/getLatestIstio <span class=p>|</span> sh -
</span></span></code></pre></td></tr></table></div></div><p>By the end of the command execution, you will see some message like this one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Add /Users/n.lamouchi/istio-1.0.6/bin to your path<span class=p>;</span> e.g copy paste in your shell and/or ~/.profile:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PATH</span><span class=s2>:/Users/n.lamouchi/istio-1.0.6/bin&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Next, we will move to Istio package directory:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> istio-1.0.6/
</span></span></code></pre></td></tr></table></div></div><p>As the first step, you have to install Istioâ€™s Custom Resources Definition:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml
</span></span></code></pre></td></tr></table></div></div><blockquote><p>What is Custom Resources Definition ?</p><p>Custom resources definition (CRD) is a powerful feature introduced in <em>Kubernetes</em>Â 1.7 which enables users to add their own/custom objects to theÂ <em>Kubernetes</em>Â cluster and use it like any other nativeÂ <em>Kubernetes</em> objects.</p></blockquote><p>Next, we need to install Istioâ€™s core components. We have four different options to do this:</p><ul><li><strong>Option 1</strong>: Install Istio WITHOUT mutual TLS authentication between sidecars</li><li><strong>Option 2</strong>: Install Istio WITH default mutual TLS authentication</li><li><strong>Option 3</strong>: Render Kubernetes manifest with Helm and deploy with kubectl</li><li><strong>Option 4</strong>: Use Helm and Tiller to manage the Istio deployment</li></ul><blockquote><p>For a production setup of Istio, itâ€™s recommended to install with the Helm Chart (Option 4), to use all the configuration options. This permits customization of Istio to operator specific requirements.</p></blockquote><p>In this tutorial, we will be using theÂ <strong>Option 1</strong>:</p><p>To install Istio:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f install/kubernetes/istio-demo.yaml
</span></span></code></pre></td></tr></table></div></div><p>Verifying the installation</p><p>To be sure that the Istio components were correctly installed, these Kubernetes Services needs to be installed:Â <code>istio-pilot</code>,Â <code>istio-ingressgateway</code>,Â <code>istio-policy</code>,Â <code>istio-telemetry</code>,Â <code>prometheus</code>,Â <code>istio-galley</code>, and (optionally)Â <code>istio-sidecar-injector</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get svc -n istio-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                    TYPE          CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>              AGE
</span></span><span class=line><span class=cl>grafana                 ClusterIP     10.102.186.225  &lt;none&gt;        3000/TCP             35m
</span></span><span class=line><span class=cl>istio-citadel           ClusterIP     10.108.239.218  &lt;none&gt;        8060/TCP,9093/TCP    58m
</span></span><span class=line><span class=cl>istio-egressgateway     ClusterIP     10.103.151.29   &lt;none&gt;        80/TCP,443/TCP       58m
</span></span><span class=line><span class=cl>istio-galley            ClusterIP     10.96.55.14     &lt;none&gt;        443/TCP,9093/TCP     58m
</span></span><span class=line><span class=cl>istio-ingressgateway    LoadBalancer  10.110.91.248   &lt;pending&gt;     80:31380/TCP..       58m
</span></span><span class=line><span class=cl>istio-pilot             ClusterIP     10.104.95.143   &lt;none&gt;        15010/TCP..          58m
</span></span><span class=line><span class=cl>istio-policy            ClusterIP     10.100.19.140   &lt;none&gt;        9091/TCP..           58m
</span></span><span class=line><span class=cl>istio-sidecar-injector  ClusterIP     10.101.13.203   &lt;none&gt;        443/TCP              58m
</span></span><span class=line><span class=cl>istio-telemetry         ClusterIP     10.103.135.98   &lt;none&gt;        9091/TCP..           58m
</span></span><span class=line><span class=cl>jaeger-agent            ClusterIP     None            &lt;none&gt;        5775/UDP..           35m
</span></span><span class=line><span class=cl>jaeger-collector        ClusterIP     10.110.82.2     &lt;none&gt;        14267/TCP,14268/TCP  35m
</span></span><span class=line><span class=cl>jaeger-query            ClusterIP     10.101.54.162   &lt;none&gt;        16686/TCP            35m
</span></span><span class=line><span class=cl>prometheus              ClusterIP     10.101.210.170  &lt;none&gt;        9090/TCP             58m
</span></span><span class=line><span class=cl>servicegraph            ClusterIP     10.99.60.12     &lt;none&gt;        8088/TCP             35m
</span></span><span class=line><span class=cl>tracing                 ClusterIP     10.98.62.125    &lt;none&gt;        80/TCP               35m
</span></span><span class=line><span class=cl>zipkin                  ClusterIP     10.100.54.120   &lt;none&gt;        9411/TCP             35m
</span></span></code></pre></td></tr></table></div></div><p>For the KubernetesÂ <em>Services</em>Â already listed, we will find correspondingÂ <em>Pods</em>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get svc -n istio-system
</span></span><span class=line><span class=cl>                                                                                                                                 
</span></span><span class=line><span class=cl>NAME                                      READY   STATUS      RESTARTS   AGE
</span></span><span class=line><span class=cl>grafana-59b8896965-n4rvr                  1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-citadel-6f444d9999-xc27q            1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-cleanup-secrets-k2dzg               0/1     Completed   <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-egressgateway-6d79447874-8twkk      1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-galley-685bb48846-tht5x             1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-grafana-post-install-rmflr          0/1     Completed   <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-ingressgateway-5b64fffc9f-56tm2     1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-pilot-7f558fc848-2fscl              2/2     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-policy-547d64b8d7-skpzm             2/2     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-security-post-install-nlfmd         0/1     Completed   <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-sidecar-injector-5d8dd9448d-rdbq8   1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-telemetry-c5488fc49-b8sv8           2/2     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>istio-tracing-6b994895fd-6wxvx            1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>prometheus-76b7745b64-2tgkw               1/1     Running     <span class=m>0</span>          91m
</span></span><span class=line><span class=cl>servicegraph-cb9b94c-2x5cb                1/1     Running     <span class=m>1</span>          91m
</span></span></code></pre></td></tr></table></div></div><p>AllÂ <em>Pods</em>Â need to be in theÂ <strong>Running</strong>Â status, except theÂ <code>istio-cleanup-secrets-*</code>,Â <code>istio-grafana-post-install-*</code>Â andÂ <code>istio-security-post-install-*</code>Â <em>Pods</em>, which will be in theÂ <strong>Completed</strong>Â status. These threeÂ <strong>Completed</strong>Â <em>Pods</em>Â are started and executed at a post-installation phase, to do post-installation tasks like cleaning the installation secrets, etcâ€¦</p><h3 id=envoy-sidecar-injection>Envoy Sidecar Injection<a hidden class=anchor aria-hidden=true href=#envoy-sidecar-injection>#</a></h3><p>In the service mesh world, a sidecar is a utility container in the pod, and its purpose is to support the main container. In the Istio case, the sidecar will be an Envoy proxy that will be deployed to each pod. The process of adding Envoy into a pod is calledÂ <strong>Sidecar Injection</strong>. This action can be done in two ways:</p><ul><li>Automatically using the Istio Sidecar Injector : Automatic injection injects at pod creation time. The controller resource is unmodified. Sidecars can be updated selectively by manually deleting a pods or systematically with a deployment rolling update.</li><li>Manually using theÂ <strong>Istioctl-CLI</strong>Â tool: Manual injection modifies the controller configuration, e.g. deployment. It does this by modifying the pod template spec such that all pods for that deployment are created with the injected sidecar. Adding, Updating or Removing the sidecar requires modifying the entire deployment.</li></ul><h4 id=automatic-sidecar-injection>Automatic Sidecar Injection<a hidden class=anchor aria-hidden=true href=#automatic-sidecar-injection>#</a></h4><p>To enable theÂ <strong>Automatic Sidecar Inject</strong>Â just add theÂ <code>istio-injection</code>Â label to the Kubernetes namespace: For example to enable it in theÂ <em>default</em>Â namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl label namespace default istio-injection<span class=o>=</span>enabled --overwrite
</span></span></code></pre></td></tr></table></div></div><p>Now, when a pod will be created, the Envoy sidecar is automatically injected inside it.</p><h4 id=manual-sidecar-injection>Manual Sidecar Injection<a hidden class=anchor aria-hidden=true href=#manual-sidecar-injection>#</a></h4><p>Inject the sidecar into the deployment using the in-cluster configuration. &lt;1></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                        --output bookinfo-injected.yaml
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>$ kubectl apply -f bookinfo-injected.yaml
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>BookInfo Sample Application</strong></p><p>This example deploys a sample application composed of four separate microservices used to demonstrate various Istio features. The lication displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a cription of the book, book details (ISBN, number of pages, and so on), and a few book reviews.</p><p>The Bookinfo application is broken into four separate microservices:</p><ul><li><code>productpage</code>: The <code>productpage</code> microservice calls the details and reviews microservices to populate the page.</li><li><code>details</code>: The <code>details</code> microservice contains book information.</li><li><code>reviews</code>: The <code>reviews</code> microservice contains book reviews. It also calls the ratings microservice.</li><li><code>ratings</code>: The <code>ratings</code> microservice contains book ranking information that accompanies a book review.</li></ul><p>There are 3 versions of the reviews microservice:</p><ul><li>Version v1 doesnâ€™t call the ratings service.</li><li>Version v2 calls the ratings service, and displays each rating as 1 to 5 black stars.</li><li>Version v3 calls the ratings service, and displays each rating as 1 to 5 red stars.</li></ul></blockquote><p>These two commands can be done in one command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create -f &lt;<span class=o>(</span>istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>or also:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml <span class=p>|</span> kubectl apply -f -
</span></span></code></pre></td></tr></table></div></div><p>These commands will inject the Istio Envoy sidecar into the KubernetesÂ <em>Deployment</em>Â object.</p><p>For the sampleÂ <em>Deployment</em>Â of theÂ <code>details-v1</code>Â microservice which looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>details-v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>istio/examples-bookinfo-details-v1:1.8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>TheÂ _Deployment_Â after the injection of Istio will look like</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>details-v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>sidecar.istio.io/status</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;...&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>istio/examples-bookinfo-details-v1:1.8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>sidecar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>configPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/etc/istio/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>binaryPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/usr/local/bin/envoy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>serviceCluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>drainDuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>45s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>parentShutdownDuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>discoveryAddress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>istio-pilot.istio-system:15007</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>discoveryRefreshDelay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>zipkinAddress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>zipkin.istio-system:9411</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>connectTimeout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>proxyAdminPort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>controlPlaneAuthPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>NONE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_NAMESPACE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>INSTANCE_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.podIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_META_POD_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_META_INTERCEPTION_MODE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>REDIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ISTIO_METAJSON_LABELS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            </span><span class=w>            </span>{<span class=s2>&#34;app&#34;</span><span class=p>:</span><span class=s2>&#34;details&#34;</span><span class=p>,</span><span class=s2>&#34;version&#34;</span><span class=p>:</span><span class=s2>&#34;v1&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxyv2:1.0.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>15090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-envoy-prom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnlyRootFilesystem</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>1337</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/istio/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-envoy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/certs/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;15001&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>u</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;1337&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>REDIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;9080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/istio/proxy_init:1.0.6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>capabilities</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>NET_ADMIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>emptyDir</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>medium</span><span class=p>:</span><span class=w> </span><span class=l>Memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-envoy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>istio-certs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>optional</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>istio.default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>All the extra paramters and configuration are added viaÂ <code>istioctl kube-inject</code>Â command.</p><p>After executing the command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create -f &lt;<span class=o>(</span>istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>service/details created
</span></span><span class=line><span class=cl>deployment.extensions/details-v1 created
</span></span><span class=line><span class=cl>service/ratings created
</span></span><span class=line><span class=cl>deployment.extensions/ratings-v1 created
</span></span><span class=line><span class=cl>service/reviews created
</span></span><span class=line><span class=cl>deployment.extensions/reviews-v1 created
</span></span><span class=line><span class=cl>deployment.extensions/reviews-v2 created
</span></span><span class=line><span class=cl>deployment.extensions/reviews-v3 created
</span></span><span class=line><span class=cl>service/productpage created
</span></span><span class=line><span class=cl>deployment.extensions/productpage-v1 created
</span></span></code></pre></td></tr></table></div></div><p>We can verify that theÂ <strong>sidecar</strong>Â is deployed in the sameÂ <em>Deployment</em>Â as the microservice, just type:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get deployment details-v1 -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS            IMAGES    SELECTOR
</span></span><span class=line><span class=cl>details-v1   1/1     <span class=m>1</span>            <span class=m>1</span>           63m   details,istio-proxy   ...       ...
</span></span></code></pre></td></tr></table></div></div><p>We can even see that there are two containers in theÂ <code>details-v1-*</code>Â pod:</p><div align=center><p><img loading=lazy src=../images/istio-containers-pod.webp alt></p></div><p>To be sure that everything is ok, we need to verify that theÂ <code>BookInfo</code>Â services & pods are here:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>    AGE
</span></span><span class=line><span class=cl>details       ClusterIP   10.106.82.61    &lt;none&gt;        9080/TCP   4h51m
</span></span><span class=line><span class=cl>kubernetes    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    11h
</span></span><span class=line><span class=cl>productpage   ClusterIP   10.100.126.93   &lt;none&gt;        9080/TCP   4h51m
</span></span><span class=line><span class=cl>ratings       ClusterIP   10.98.201.254   &lt;none&gt;        9080/TCP   4h51m
</span></span><span class=line><span class=cl>reviews       ClusterIP   10.110.241.59   &lt;none&gt;        9080/TCP   4h51m
</span></span></code></pre></td></tr></table></div></div><p>And :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>details-v1-55bc45969c-99xj2       2/2     Running   <span class=m>0</span>          4h52m
</span></span><span class=line><span class=cl>productpage-v1-5b597ff459-pfpmt   2/2     Running   <span class=m>0</span>          4h52m
</span></span><span class=line><span class=cl>ratings-v1-7877895db5-vchw2       2/2     Running   <span class=m>0</span>          4h52m
</span></span><span class=line><span class=cl>reviews-v1-699587b49b-bt7z5       2/2     Running   <span class=m>0</span>          4h52m
</span></span><span class=line><span class=cl>reviews-v2-cc7cd59cc-k6l6j        2/2     Running   <span class=m>0</span>          4h52m
</span></span><span class=line><span class=cl>reviews-v3-6fbcf56df8-nc2lf       2/2     Running   <span class=m>0</span>          4h52m
</span></span></code></pre></td></tr></table></div></div><p>Now, we can go on to next steps and enjoy the great Istio features :)</p><h2 id=traffic-management>Traffic Management<a hidden class=anchor aria-hidden=true href=#traffic-management>#</a></h2><h3 id=istio-gateway--virtualservice>Istio Gateway & VirtualService<a hidden class=anchor aria-hidden=true href=#istio-gateway--virtualservice>#</a></h3><p>Now that the Bookinfo services are up and running, we need to make the Services accessible from outside of your Kubernetes cluster. AnÂ <strong>Istio Gateway</strong>Â object is used for this purpose.</p><p>AnÂ <strong>Istio Gateway</strong>Â configures a load balancer forÂ <em>HTTP/TCP</em>Â traffic at the edge of the service mesh and enablesÂ <strong>Ingress</strong>Â traffic for an application. Unlike KubernetesÂ <strong>Ingress</strong>,Â <strong>Istio Gateway</strong>Â only configures theÂ <em>L4-L6</em>Â functions (for example, ports to expose, TLS configuration). Users can then use standard Istio rules to controlÂ <em>HTTP</em>Â requests as well asÂ <em>TCP</em>Â traffic entering aÂ <strong>Gateway</strong>Â by binding aÂ <strong>VirtualService</strong>Â to it.</p><p>We can define theÂ <strong>Ingress gateway</strong>Â for theÂ <em>Bookinfo</em>Â application using the sample gateway configuration:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bookinfo-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w> </span><span class=c># use istio default controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>AÂ <strong>VirtualService</strong>Â defines the rules that control how requests for a service are routed within an Istio service mesh. For example, aÂ <strong>VirtualService</strong>Â could route requests to different versions of a service or to a completely different service than was requested. Requests can be routed based on the request source and destination,Â <em>HTTP</em>Â paths and header fields, and weights associated with individual service versions.</p><p>TheÂ <strong>VirtualService</strong>Â configuration looks like:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bookinfo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>bookinfo-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>/productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>/login</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>/logout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/products</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Letâ€™s create theÂ <strong>Istio Gateway</strong>Â and theÂ <strong>VirtualService</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span></code></pre></td></tr></table></div></div><p>Confirm the gateway has been created:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get gateway
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME               AGE
</span></span><span class=line><span class=cl>bookinfo-gateway   59m
</span></span></code></pre></td></tr></table></div></div><p>Letâ€™s export theÂ <code>INGRESS_HOST</code>, theÂ <code>INGRESS_PORT</code>Â and theÂ <code>GATEWAY_URL</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>minikube ip<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>INGRESS_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl -n istio-system get service istio-ingressgateway <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                    -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>GATEWAY_URL</span><span class=o>=</span><span class=nv>$INGRESS_HOST</span>:<span class=nv>$INGRESS_PORT</span>
</span></span></code></pre></td></tr></table></div></div><p>To test the <strong>Gateway</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -o /dev/null -s -w <span class=s2>&#34;%{http_code}\n&#34;</span> http://<span class=nv>$GATEWAY_URL</span>/productpage
</span></span></code></pre></td></tr></table></div></div><p>You must haveÂ <code>200</code>Â as response code.</p><p>You can also point your browser toÂ <code>http://$GATEWAY_URL/productpage</code>Â to view the Bookinfo web page. If you refresh the page several times, you should see different versions of reviews shown inÂ <code>productpage</code>, presented in a round robin style (red stars, black stars, no stars), since we havenâ€™t yet used Istio to control the version routing.</p><div align=center><p><img loading=lazy src=../images/bookinfo-sample-productpage.webp alt></p></div><p>If we refresh the web page some times, we will get different versions of theÂ <code>reviews</code>Â structure: One version has red stars (the one that we got in the screenshot), an other one that have back stars and a third one without starts. This is due to the availability of three versions of theÂ <code>reviews</code>Â microservice deployed in our sampleÂ <code>BookInfo</code>Â application.</p><p>You can verify the availability of the three versions of theÂ <code>reviews</code>Â microservice:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods -l <span class=nv>app</span><span class=o>=</span>reviews
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>reviews-v1-699587b49b-v44wr   2/2     Running   <span class=m>0</span>          5h31m
</span></span><span class=line><span class=cl>reviews-v2-cc7cd59cc-rgc86    2/2     Running   <span class=m>0</span>          5h31m
</span></span><span class=line><span class=cl>reviews-v3-6fbcf56df8-wndtz   2/2     Running   <span class=m>0</span>          5h31m
</span></span></code></pre></td></tr></table></div></div><p>We got different versions ofÂ <code>reviews</code>Â structure while refreshing because Istio, by default, dispatches access to loadbalanced services using aÂ <strong>Round Robin</strong>Â scheduling. One of the great features of Istio is to route the traffic to some dedicated version of a service, or even using sliced dispatching of requests.</p><p>In the next steps, we will see how to route the traffic based on version.</p><h3 id=destination-rules>Destination Rules<a hidden class=anchor aria-hidden=true href=#destination-rules>#</a></h3><p>Before we can use Istio to control theÂ <code>Bookinfo</code>Â version routing, we need to define the available versions of an application, calledÂ <code>subsets</code>. TheseÂ <code>subsets</code>Â are defined in an Istio object calledÂ <strong>DestinationRule</strong>/The choice of version to display can be decided based on criteria (headers, URL, etcâ€¦) defined to each version. We can enjoy this flexibility of criterias to do Blue-green Deployments, A/B Testing, and Canary Releases.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>productpage &lt;1&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1 &lt;2&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1 &lt;2&gt;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li>The Kubernetes Service name on which we will be routing the traffic</li><li>TheÂ <code>subset</code>Â element name</li><li>TheÂ <code>subset</code>Â element version</li></ol><p>We will create the default destination rules for the Bookinfo services, using the sampleÂ <code>destination-rule-all.yaml</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>productpage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ratings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>ratings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2-mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2-mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2-mysql-vm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2-mysql-vm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>details</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Run the following command to create default <strong>Destination Rules</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</span></span></code></pre></td></tr></table></div></div><p>Wait a few seconds for the destination rules to propagate.</p><p>You can verify that the destination rules are correctly created, using the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get destinationrules -o yaml
</span></span></code></pre></td></tr></table></div></div><p>Now, we will change the default round-robin behavior for traffic routing: we will route all traffic toÂ <code>reviews-v1</code>, using a newÂ <strong>VirtualServices</strong>Â configuration that looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>TheÂ <code>BookInfo</code>Â sample brings aÂ <code>virtual-service-all-v1.yaml</code>Â that holds the necessary configuration of the newÂ <strong>VirtualServices</strong>. To deploy it, just type:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</span></span></code></pre></td></tr></table></div></div><p>You can verify that theÂ <code>review</code>Â <strong>VirtualService</strong>Â is correctly created, using the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get virtualservices reviews -o yaml
</span></span></code></pre></td></tr></table></div></div><p>Try now to reload the page multiple times, and note how onlyÂ <code>reviews:v1</code>Â is displayed each time:</p><div align=center><p><img loading=lazy src=../images/bookinfo-sample-productpage-reviews-v1.webp alt></p></div><p>Next, we will change the route configuration so that all traffic from a specific user is routed to a specific service version. In this case, all traffic from a user named Jason will be routed to the serviceÂ <code>reviews:v2</code>.</p><p>Next, we will be routing traffic for a specific user to a specific service version. In our example, we will be routing all the traffic for a user namedÂ <code>jason</code>Â to the serviceÂ <code>reviews:v2</code>.</p><p>TheÂ <code>virtual-service-reviews-test-v2.yaml</code>Â configuration covers this case:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>end-user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>jason</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>To deploy it, just type:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</span></span></code></pre></td></tr></table></div></div><p>You can verify that theÂ <code>review</code>Â <strong>VirtualService</strong>Â is correctly created, using the following command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get virtualservices reviews -o yaml
</span></span></code></pre></td></tr></table></div></div><p>To test the newÂ <strong>VirtualService</strong>, just click on theÂ <em>Sign</em>Â button and login usingÂ <code>jason</code>Â as username and any value as password. Now, we will seeÂ <code>reviews:v2</code>. If you logout, we will get back theÂ <code>reviews:v1</code>:</p><div align=center><p><img loading=lazy src=../images/bookinfo-sample-productpage-reviews-v2.webp alt></p></div><p>Next, we will see how to gradually migrate traffic from one version of a microservice to another one. In our example, we will send 50% of traffic toÂ <code>reviews:v1</code>Â and 50% toÂ <code>reviews:v3</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</span></span></code></pre></td></tr></table></div></div><p>Letâ€™s verify the content of the newÂ <strong>VirtualService</strong>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get virtualservice reviews -o yaml
</span></span></code></pre></td></tr></table></div></div><p>TheÂ <code>subset</code>Â is set toÂ <strong>50%</strong>Â of traffic to theÂ <code>v1</code>Â andÂ <strong>50%</strong>Â to theÂ <code>v3</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Try now to reload the page multiple times, you will see diverselyÂ <code>reviews:v1</code>Â andÂ <code>reviews:v3</code>.</p><h2 id=observability>Observability<a hidden class=anchor aria-hidden=true href=#observability>#</a></h2><h3 id=distributed-tracing>Distributed Tracing<a hidden class=anchor aria-hidden=true href=#distributed-tracing>#</a></h3><h4 id=hello-jaeger>Hello Jaeger<a hidden class=anchor aria-hidden=true href=#hello-jaeger>#</a></h4><p>To access theÂ <strong>Jaeger Dashboard</strong>, establish port forwarding from local portÂ <em>16686</em>Â to theÂ <em>Tracing</em>Â instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl port-forward -n istio-system <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=k>$(</span>kubectl get pod -n istio-system -l <span class=nv>app</span><span class=o>=</span>jaeger -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  16686:16686
</span></span></code></pre></td></tr></table></div></div><p>In your browser, go toÂ <a href=http://127.0.0.1:16686>http://127.0.0.1:16686</a></p><p>From theÂ <em>Services</em>Â menu, selectÂ <strong>productpage</strong>Â service.</p><p>Scroll to the bottom and click onÂ <em>Find Traces</em>Â button to see traces:</p><div align=center><p><img loading=lazy src=../images/jaeger-dashboard-traces.webp alt></p></div><p>If you click on a trace, you should see more details. The page should look something like this:</p><div align=center><p><img loading=lazy src=../images/jaeger-dashboard-spans.webp alt></p></div><p>When invoking theÂ <code>/productpage</code>, many BookInfo services are called. These services correspond toÂ <code>spans</code>Â and the page call itself corresponds to theÂ <code>trace</code>.</p><p>Although Istio proxies are able to automatically send spans, they need some hints to tie together the entire trace. Applications need to propagate the appropriate HTTP headers so that when the proxies send span information, the spans can be correlated correctly into a single trace.</p><p>To do this, an application needs to collect and propagate the following headers from the incoming request to any outgoing requests:</p><ul><li>x-request-id</li><li>x-b3-traceid</li><li>x-b3-spanid</li><li>x-b3-parentspanid</li><li>x-b3-sampled</li><li>x-b3-flags</li><li>x-ot-span-context</li></ul><blockquote><p>When you make downstream calls in your applications, make sure to include these headers.</p></blockquote><h4 id=trace-sampling>Trace sampling<a hidden class=anchor aria-hidden=true href=#trace-sampling>#</a></h4><p>When using the Bookinfo sample application above, every time you accessÂ <code>/productpage</code>Â you see a corresponding trace in the Jaeger dashboard. This sampling rate (which is 100% in the BookInfo example) is suitable for a test or low traffic mesh, which is why it is used as the default for the demo installs.</p><p>In other configurations, Istio defaults to generating trace spans for 1 out of every 100 requests (sampling rate of of 1%).</p><p>You can control the trace sampling percentage in one of two ways:</p><p>In a running mesh, edit theÂ <code>istio-pilot</code>Â deployment and change the environment variable with the following steps:</p><ol><li>To open your text editor with the deployment configuration file loaded, run the following command:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl -n istio-system edit deploy istio-pilot
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>Find theÂ <code>PILOT_TRACE_SAMPLING</code>Â environment variable, and change the value: to your desired percentage.</li></ol><p>In both cases, valid values are from 0.0 to 100.0 with a precision of 0.01.</p><h3 id=grafana>Grafana<a hidden class=anchor aria-hidden=true href=#grafana>#</a></h3><p>TheÂ <strong>Grafana</strong>Â add-on in Istio is a preconfigured instance ofÂ <strong>Grafana</strong>. The base image (<code>grafana/grafana:5.0.4</code>) has been modified to start with both aÂ <strong>Prometheus</strong>Â data source and theÂ <em>Istio Dashboard</em>Â installed. The base install files forÂ <em>Istio</em>, andÂ <em>Mixer</em>Â in particular, ship with a default configuration of global (used for every service) metrics. TheÂ <em>Istio Dashboard</em>Â is built to be used in conjunction with the default Istio metrics configuration and aÂ <strong>Prometheus</strong>Â backend.</p><p>Establish port forwarding from local port 3000 to theÂ <strong>Grafana</strong>Â instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl -n istio-system port-forward <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=k>$(</span>kubectl -n istio-system get pod -l <span class=nv>app</span><span class=o>=</span>grafana -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  3000:3000
</span></span></code></pre></td></tr></table></div></div><p>Browse toÂ <a href=http://localhost:3000>http://localhost:3000</a>Â and navigate to theÂ <strong>Istio Mesh Dashboard</strong>:</p><div align=center><p><img loading=lazy src=../images/istio-grafana.webp alt></p></div>Â <h3 id=prometheus>Prometheus<a hidden class=anchor aria-hidden=true href=#prometheus>#</a></h3><p>Mixer comes with a built-inÂ <strong>Prometheus</strong>Â adapter that exposes an endpoint serving generated metric values. TheÂ <strong>Prometheus</strong>Â add-on is aÂ <strong>Prometheus</strong>Â server that comes preconfigured to scrape Mixer endpoints to collect the exposed metrics. It provides a mechanism for persistent storage and querying of Istio metrics.</p><p>To access theÂ <strong>Prometheus Dashboard</strong>, establish port forwarding from local portÂ <em>9090</em>Â toÂ <em>Prometheus</em> instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl -n istio-system port-forward <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=k>$(</span>kubectl -n istio-system get pod -l <span class=nv>app</span><span class=o>=</span>prometheus -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  9090:9090
</span></span></code></pre></td></tr></table></div></div><p>Browse toÂ <a href=http://localhost:9090/graph>http://localhost:9090/graph</a>, and in theÂ <em>&ldquo;Expression&rdquo;</em>Â input box, enter:Â <code>istio_request_byte_count</code>. ClickÂ <em>Execute</em>:</p><div align=center><p><img loading=lazy src=../images/istio-prometheus.webp alt></p></div>Â <h3 id=service-graph>Service Graph<a hidden class=anchor aria-hidden=true href=#service-graph>#</a></h3><p>TheÂ <strong>ServiceGraph</strong>Â service provides endpoints for generating and visualizing a graph of services within a mesh. It exposes the following endpoints:</p><ul><li><code>/force/forcegraph.html</code>Â As explored above, this is an interactiveÂ <strong>D3.js</strong>Â visualization.</li><li><code>/dotviz</code>Â is a staticÂ <strong>Graphviz</strong>Â visualization.</li><li><code>/dotgraph</code>Â provides aÂ <strong>DOT</strong>Â serialization.</li><li><code>/d3graph</code>Â provides a JSON serialization forÂ <strong>D3</strong>Â visualization.</li><li><code>/graph</code>Â provides a generic JSON serialization.</li></ul><p>To access theÂ <strong>Service Graph Dashboard</strong>, establish port forwarding from local portÂ <em>8088</em>Â toÂ <em>Service Graph</em> instance:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl -n istio-system port-forward <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=k>$(</span>kubectl -n istio-system get pod -l <span class=nv>app</span><span class=o>=</span>servicegraph -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  8088:8088
</span></span></code></pre></td></tr></table></div></div><p>Browse toÂ <a href=http://localhost:8088/dotviz>http://localhost:8088/dotviz</a>:</p><div align=center><p><img loading=lazy src=../images/istio-dataviz.webp alt></p></div>Â <p>TheÂ <strong>ServiceGraph</strong>Â example is built on top ofÂ <strong>Prometheus</strong>Â queries and depends on the standard Istio metric configuration.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>That&rsquo;s all folks! We have been presenting the main concepts and components of Istio Service Mesh. This introducing chapter is just for installation and core concepts of Istio. As we saw in the <em>Traffic Management</em> section, there are infinite scenarios and use cases that you want to cover, like fault injection, controlling Ingress and Egress traffic, circuit breakers, etc..</p><p>We did not have the opportunity to cover the <em>Security</em> capabilities of Istio, just because it needs so much chapters to be covered. ğŸ˜›</p><p>Stay tuned, I will be writing some quickies about more great capabilities of Istio ! ğŸ˜</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.nebrass.fr/tags/istio/>istio</a></li><li><a href=https://blog.nebrass.fr/tags/kubernetes/>kubernetes</a></li><li><a href=https://blog.nebrass.fr/tags/service-mesh/>service-mesh</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on twitter" href="https://twitter.com/intent/tweet/?text=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f&hashtags=istio%2ckubernetes%2cservice-mesh"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f&title=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes&summary=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes&source=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f&title=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on whatsapp" href="https://api.whatsapp.com/send?text=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes%20-%20https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Playing with Istio Service Mesh on Kubernetes on telegram" href="https://telegram.me/share/url?text=Playing%20with%20Istio%20Service%20Mesh%20on%20Kubernetes&url=https%3a%2f%2fblog.nebrass.fr%2fplaying-with-istio-service-mesh-on-kubernetes%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.nebrass.fr>Nebrass Homepage</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>